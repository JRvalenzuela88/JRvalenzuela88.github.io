
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation, guides and articles on creating, developing and implementing automated betting strategies, using data analysis to inform betting models and how to interact with the Betfair API.">
      
      
        <meta name="author" content="Betfair Data Scientists">
      
      
        <link rel="canonical" href="https://betfair-datascientists.github.io/modelling/AFLmodellingPython/">
      
      <link rel="icon" href="../../img/BetfairFavicon.ico">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-8.1.6">
    
    
      
        <title>AFL modelling walk through in Python - The Automation Hub</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.cd566b2a.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.e6a45f82.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/betfair.css">
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#afl-modelling-walkthrough" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      
  
  <header class="md-header" data-md-component="header">
    <nav class="md-header__inner md-grid" aria-label="Header">
      <a href="../.." title="The Automation Hub" class="md-header__button md-logo" aria-label="The Automation Hub" data-md-component="logo">
        
  <img src="../../img/logo.svg" alt="logo">

      </a>
      <label class="md-header__button md-icon" for="__drawer">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
      </label>
      <div class="md-header__title" data-md-component="header-title">
        <div class="md-header__ellipsis">
          <div class="md-header__topic">
            <span class="md-ellipsis">
              The Automation Hub
            </span>
          </div>
          <div class="md-header__topic" data-md-component="header-topic">
            <span class="md-ellipsis">
              
                AFL modelling walk through in Python
              
            </span>
          </div>
        </div>
      </div>
      
        <form class="md-header__option" data-md-component="palette">
          
            
            
            <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
            
              <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
              </label>
            
          
            
            
            <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
            
              <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3z"/></svg>
              </label>
            
          
        </form>
      
      
      
        <label class="md-header__button md-icon" for="__search">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
      
    </nav>
    
  </header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="The Automation Hub" class="md-nav__button md-logo" aria-label="The Automation Hub" data-md-component="logo">
      
  <img src="../../img/logo.svg" alt="logo">

    </a>
    The Automation Hub
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1" type="checkbox" id="__nav_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_1">
          Home
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Home" data-md-level="1">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          Home
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        The Automation Hub
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          API
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="API" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          API
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/apiResources/" class="md-nav__link">
        API resources
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/apiappkey/" class="md-nav__link">
        How to access the Betfair API
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_3" type="checkbox" id="__nav_2_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_3">
          Tutorials
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Tutorials" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_3">
          <span class="md-nav__icon md-icon"></span>
          Tutorials
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/apiRtutorial/" class="md-nav__link">
        API tutorials in R
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/apiPythontutorial/" class="md-nav__link">
        API tutorial in Python
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/GoldenRulesofAutomation/" class="md-nav__link">
        Golden rules of automation
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Historic Data
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Historic Data" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Historic Data
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../historicData/dataSources/" class="md-nav__link">
        Pricing Data Sources
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2" type="checkbox" id="__nav_3_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3_2">
          Tutorials
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Tutorials" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_2">
          <span class="md-nav__icon md-icon"></span>
          Tutorials
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../historicData/jsonToCsvTutorial/" class="md-nav__link">
        JSON to CSV in Python
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../historicData/backtestingRatingsTutorial/" class="md-nav__link">
        Back testing ratings in Python
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_3" type="checkbox" id="__nav_3_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3_3">
          Historic Data site
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Historic Data site" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_3">
          <span class="md-nav__icon md-icon"></span>
          Historic Data site
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../historicData/usingHistoricDataSite/" class="md-nav__link">
        Downloading from the Historic Data site
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Modelling
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Modelling" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Modelling
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../howToModel/" class="md-nav__link">
        Intro to modelling
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2" type="checkbox" id="__nav_4_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_2">
          Soccer
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Soccer" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_2">
          <span class="md-nav__icon md-icon"></span>
          Soccer
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../soccerEloTutorialR/" class="md-nav__link">
        Elo soccer tutorial in R
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../soccerModellingTutorialPython/" class="md-nav__link">
        Soccer modelling tutorial in Python
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../soccerModellingTutorialR/" class="md-nav__link">
        Soccer modelling tutorial in R
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../EPLmlPython/" class="md-nav__link">
        EPL ML walk through in Python
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3" type="checkbox" id="__nav_4_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_4_3">
          AFL
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="AFL" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_3">
          <span class="md-nav__icon md-icon"></span>
          AFL
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        AFL modelling walk through in Python
      </a>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../brownlowModelTutorial/" class="md-nav__link">
        Modelling the Brownlow Medal in Python
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_4" type="checkbox" id="__nav_4_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_4">
          Tennis
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Tennis" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_4">
          <span class="md-nav__icon md-icon"></span>
          Tennis
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../howToModelTheAusOpen/" class="md-nav__link">
        How to model the Australian Open
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../AusOpenRTutorial/" class="md-nav__link">
        Aus Open R Tutorial
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../AusOpenPythonTutorial/" class="md-nav__link">
        Aus Open Python Tutorial
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          Auto Tools
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Auto Tools" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Auto Tools
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../autoTools/overview/" class="md-nav__link">
        Tools Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_2" type="checkbox" id="__nav_5_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5_2">
          Bet Angel
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Bet Angel" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_2">
          <span class="md-nav__icon md-icon"></span>
          Bet Angel
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../autoTools/betAngel/betAngel/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../autoTools/betAngelbeginners/" class="md-nav__link">
        Beginner's guide
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../autoTools/betAngelintermediate/" class="md-nav__link">
        Intermediate guide
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../autoTools/betAngeladvanced/" class="md-nav__link">
        Advanced guide
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../autoTools/betAngelRatingsAutomation/" class="md-nav__link">
        Ratings auto
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../autoTools/betAngelMarketFavouriteAutomation/" class="md-nav__link">
        Market fav auto
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../autoTools/betAngelTippingAutomation/" class="md-nav__link">
        Tipping auto
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../autoTools/betAngelSimultaneousMarkets/" class="md-nav__link">
        Simultaneous markets
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../autoTools/betAngelKellyStake/" class="md-nav__link">
        Kelly criterion staking
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_3" type="checkbox" id="__nav_5_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5_3">
          Gruss Betting Assistant
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Gruss Betting Assistant" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_3">
          <span class="md-nav__icon md-icon"></span>
          Gruss Betting Assistant
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../autoTools/Gruss/Gruss/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../autoTools/GrussSettingupbasicmarketview/" class="md-nav__link">
        Setup basic market view and one click betting
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../autoTools/grussRatingsAutomation/" class="md-nav__link">
        Ratings auto
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../autoTools/grussMarketFavouriteAutomation/" class="md-nav__link">
        Market fav auto
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../autoTools/grusslSimultaneousMarkets/" class="md-nav__link">
        Simultaneous markets
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../autoTools/grussKellyStake/" class="md-nav__link">
        Kelly criterion staking
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_4" type="checkbox" id="__nav_5_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5_4">
          Cymatic Trader
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Cymatic Trader" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_4">
          <span class="md-nav__icon md-icon"></span>
          Cymatic Trader
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../autoTools/CymaticTrader/CymaticTrader/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../autoTools/cymaticTraderRatingsAutomation/" class="md-nav__link">
        Ratings auto
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_5" type="checkbox" id="__nav_5_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5_5">
          Geeks Toy
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Geeks Toy" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_5">
          <span class="md-nav__icon md-icon"></span>
          Geeks Toy
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../autoTools/GeeksToyinstallationandsetup/" class="md-nav__link">
        Installation and setup
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../autoTools/GeeksToybasicmarketviewstakingandoneclickbetting/" class="md-nav__link">
        Setup basic market view and one click betting
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../autoTools/geeksToyRefreshSettings/" class="md-nav__link">
        Optimising refresh settings
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                

<h1 id="afl-modelling-walkthrough">AFL Modelling Walkthrough</h1>
<hr />
<h1 id="01-data-cleaning">01. Data Cleaning</h1>
<p>These tutorials will walk you through how to construct your own basic AFL model, using publicly available data. The output will be odds for each team to win, which will be shown on <a href="https://www.betfair.com.au/hub/tools/models/afl-prediction-model/">The Hub</a>.</p>
<p>In this notebook we will walk you through the basics of cleaning this dataset and how we have done it. If you want to get straight to feature creation or modelling, feel free to jump ahead!</p>
<pre><code class="language-python"># Import libraries
import pandas as pd
import numpy as np
import re
pd.set_option('display.max_columns', None)
</code></pre>
<p>We will first explore the DataFrames, and then create functions to wrangle them and clean them into more consistent sets of data.</p>
<pre><code class="language-python"># Read/clean each DataFrame
match_results = pd.read_csv(&quot;data/afl_match_results.csv&quot;)
odds = pd.read_csv(&quot;data/afl_odds.csv&quot;)
player_stats = pd.read_csv(&quot;data/afl_player_stats.csv&quot;)
</code></pre>
<pre><code class="language-python">odds.tail(3)
</code></pre>
<table>
<thead>
<tr>
<th></th>
<th>trunc</th>
<th>event_name</th>
<th>path</th>
<th>selection_name</th>
<th>odds</th>
</tr>
</thead>
<tbody>
<tr>
<td>4179</td>
<td>2018-09-01</td>
<td>Match Odds</td>
<td>VFL/Richmond Reserves v Williamstown</td>
<td>Williamstown</td>
<td>2.3878</td>
</tr>
<tr>
<td>4180</td>
<td>2018-09-01</td>
<td>Match Odds</td>
<td>WAFL/South Fremantle v West Perth</td>
<td>South Fremantle</td>
<td>1.5024</td>
</tr>
<tr>
<td>4181</td>
<td>2018-09-01</td>
<td>Match Odds</td>
<td>WAFL/South Fremantle v West Perth</td>
<td>West Perth</td>
<td>2.7382</td>
</tr>
</tbody>
</table>
<pre><code class="language-python">match_results.tail(3)
</code></pre>
<table>
<thead>
<tr>
<th></th>
<th>Game</th>
<th>Date</th>
<th>Round</th>
<th>Home.Team</th>
<th>Home.Goals</th>
<th>Home.Behinds</th>
<th>Home.Points</th>
<th>Away.Team</th>
<th>Away.Goals</th>
<th>Away.Behinds</th>
<th>Away.Points</th>
<th>Venue</th>
<th>Margin</th>
<th>Season</th>
<th>Round.Type</th>
<th>Round.Number</th>
</tr>
</thead>
<tbody>
<tr>
<td>15395</td>
<td>15396</td>
<td>2018-08-26</td>
<td>R23</td>
<td>Brisbane Lions</td>
<td>11</td>
<td>6</td>
<td>72</td>
<td>West Coast</td>
<td>14</td>
<td>14</td>
<td>98</td>
<td>Gabba</td>
<td>-26</td>
<td>2018</td>
<td>Regular</td>
<td>23</td>
</tr>
<tr>
<td>15396</td>
<td>15397</td>
<td>2018-08-26</td>
<td>R23</td>
<td>Melbourne</td>
<td>15</td>
<td>12</td>
<td>102</td>
<td>GWS</td>
<td>8</td>
<td>9</td>
<td>57</td>
<td>M.C.G.</td>
<td>45</td>
<td>2018</td>
<td>Regular</td>
<td>23</td>
</tr>
<tr>
<td>15397</td>
<td>15398</td>
<td>2018-08-26</td>
<td>R23</td>
<td>St Kilda</td>
<td>14</td>
<td>10</td>
<td>94</td>
<td>North Melbourne</td>
<td>17</td>
<td>15</td>
<td>117</td>
<td>Docklands</td>
<td>-23</td>
<td>2018</td>
<td>Regular</td>
<td>23</td>
</tr>
</tbody>
</table>
<pre><code class="language-python">player_stats.tail(3)
</code></pre>
<table>
<thead>
<tr>
<th align="center"></th>
<th align="center">AF</th>
<th align="center">B</th>
<th align="center">BO</th>
<th align="center">CCL</th>
<th align="center">CG</th>
<th align="center">CL</th>
<th align="center">CM</th>
<th align="center">CP</th>
<th align="center">D</th>
<th align="center">DE</th>
<th align="center">Date</th>
<th align="center">ED</th>
<th align="center">FA</th>
<th align="center">FF</th>
<th align="center">G</th>
<th align="center">GA</th>
<th align="center">HB</th>
<th align="center">HO</th>
<th align="center">I50</th>
<th align="center">ITC</th>
<th align="center">K</th>
<th align="center">M</th>
<th align="center">MG</th>
<th align="center">MI5</th>
<th align="center">Match_id</th>
<th align="center">One.Percenters</th>
<th align="center">Opposition</th>
<th align="center">Player</th>
<th align="center">R50</th>
<th align="center">Round</th>
<th align="center">SC</th>
<th align="center">SCL</th>
<th align="center">SI</th>
<th align="center">Season</th>
<th align="center">Status</th>
<th align="center">T</th>
<th align="center">T5</th>
<th align="center">TO</th>
<th align="center">TOG</th>
<th align="center">Team</th>
<th align="center">UP</th>
<th align="center">Venue</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">89317</td>
<td align="center">38</td>
<td align="center">1</td>
<td align="center">0</td>
<td align="center">0.0</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">1</td>
<td align="center">2</td>
<td align="center">9</td>
<td align="center">55.6</td>
<td align="center">25/08/2018</td>
<td align="center">5</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">3</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">2.0</td>
<td align="center">6</td>
<td align="center">3</td>
<td align="center">132.0</td>
<td align="center">2</td>
<td align="center">9711</td>
<td align="center">0</td>
<td align="center">Fremantle</td>
<td align="center">Christopher Mayne</td>
<td align="center">1</td>
<td align="center">Round 23</td>
<td align="center">35</td>
<td align="center">0.0</td>
<td align="center">2.0</td>
<td align="center">2018</td>
<td align="center">Away</td>
<td align="center">1</td>
<td align="center">0.0</td>
<td align="center">1.0</td>
<td align="center">57</td>
<td align="center">Collingwood</td>
<td align="center">7</td>
<td align="center">Optus Stadium</td>
</tr>
<tr>
<td align="center">89318</td>
<td align="center">38</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">0.0</td>
<td align="center">3</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">3</td>
<td align="center">9</td>
<td align="center">55.6</td>
<td align="center">25/08/2018</td>
<td align="center">5</td>
<td align="center">0</td>
<td align="center">1</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">3</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">4.0</td>
<td align="center">6</td>
<td align="center">3</td>
<td align="center">172.0</td>
<td align="center">0</td>
<td align="center">9711</td>
<td align="center">2</td>
<td align="center">Fremantle</td>
<td align="center">Nathan Murphy</td>
<td align="center">5</td>
<td align="center">Round 23</td>
<td align="center">29</td>
<td align="center">0.0</td>
<td align="center">0.0</td>
<td align="center">2018</td>
<td align="center">Away</td>
<td align="center">1</td>
<td align="center">0.0</td>
<td align="center">3.0</td>
<td align="center">70</td>
<td align="center">Collingwood</td>
<td align="center">6</td>
<td align="center">Optus Stadium</td>
</tr>
<tr>
<td align="center">89319</td>
<td align="center">56</td>
<td align="center">1</td>
<td align="center">0</td>
<td align="center">0.0</td>
<td align="center">1</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">3</td>
<td align="center">8</td>
<td align="center">62.5</td>
<td align="center">25/08/2018</td>
<td align="center">5</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">2</td>
<td align="center">0</td>
<td align="center">2</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">2.0</td>
<td align="center">6</td>
<td align="center">3</td>
<td align="center">180.0</td>
<td align="center">3</td>
<td align="center">9711</td>
<td align="center">2</td>
<td align="center">Fremantle</td>
<td align="center">Jaidyn Stephenson</td>
<td align="center">0</td>
<td align="center">Round 23</td>
<td align="center">56</td>
<td align="center">0.0</td>
<td align="center">4.0</td>
<td align="center">2018</td>
<td align="center">Away</td>
<td align="center">3</td>
<td align="center">1.0</td>
<td align="center">2.0</td>
<td align="center">87</td>
<td align="center">Collingwood</td>
<td align="center">5</td>
<td align="center">Optus Stadium</td>
</tr>
</tbody>
</table>
<p>Have a look at the structure of the DataFrames. Notice that for the odds DataFrame, each game is split between two rows, whilst for the match_results each game is on one row. We will have to get around this by splitting the games up onto two rows, as this will allow our feature transformation functions to be applied more easily later on. For the player_stats DataFrame we will aggregate these stats into each game on separate rows.</p>
<p>First, we will write functions to make the odds data look a bit nicer, with only a team column, a date column and a 'home_game' column which takes the values 0 or 1 depending on if it was a home game for that team. To do this we will use the <a href="https://docs.python.org/3/howto/regex.html">regex</a> module to extract the team names from the path column, as well as the to_datetime function from pandas. We will also replace all the inconsistent team names with consistent team names.</p>
<pre><code class="language-python">def get_cleaned_odds(df=None):
    # If a df hasn't been specified as a parameter, read the odds df
    if df is None:
        df = pd.read_csv(&quot;data/afl_odds.csv&quot;)

    # Get a dictionary of team names we want to change and their new values
    team_name_mapping = {
    'Adelaide Crows': 'Adelaide',
    'Brisbane Lions': 'Brisbane',
    'Carlton Blues': 'Carlton',
    'Collingwood Magpies': 'Collingwood',
    'Essendon Bombers': 'Essendon',
    'Fremantle Dockers': 'Fremantle',
    'GWS Giants': 'GWS',
    'Geelong Cats': 'Geelong',
    'Gold Coast Suns': 'Gold Coast',
    'Greater Western Sydney': 'GWS',
    'Greater Western Sydney Giants': 'GWS',
    'Hawthorn Hawks': 'Hawthorn',
    'Melbourne Demons': 'Melbourne', 
    'North Melbourne Kangaroos': 'North Melbourne',
    'Port Adelaide Magpies': 'Port Adelaide',
    'Port Adelaide Power': 'Port Adelaide', 
    'P Adelaide': 'Port Adelaide',
    'Richmond Tigers': 'Richmond',
    'St Kilda Saints': 'St Kilda', 
    'Sydney Swans': 'Sydney',
    'West Coast Eagles': 'West Coast',
    'Wetsern Bulldogs': 'Western Bulldogs',
    'Western Bullbogs': 'Western Bulldogs'
    }

    # Add columns
    df = (df.assign(date=lambda df: pd.to_datetime(df.trunc), # Create a datetime column
                    home_team=lambda df: df.path.str.extract('(([\w\s]+) v ([\w\s]+))', expand=True)[1].str.strip(),
                    away_team=lambda df: df.path.str.extract('(([\w\s]+) v ([\w\s]+))', expand=True)[2].str.strip())
            .drop(columns=['path', 'trunc', 'event_name']) # Drop irrelevant columns
            .rename(columns={'selection_name': 'team'}) # Rename columns
            .replace(team_name_mapping)
            .sort_values(by='date')
            .reset_index(drop=True)
            .assign(home_game=lambda df: df.apply(lambda row: 1 if row.home_team == row.team else 0, axis='columns'))
            .drop(columns=['home_team', 'away_team']))
    return df
</code></pre>
<pre><code class="language-python"># Apply the wrangling and cleaning function
odds = get_cleaned_odds(odds)
odds.tail()
</code></pre>
<table>
<thead>
<tr>
<th></th>
<th>team</th>
<th>odds</th>
<th>date</th>
<th>home_game</th>
</tr>
</thead>
<tbody>
<tr>
<td>4177</td>
<td>South Fremantle</td>
<td>1.5024</td>
<td>2018-09-01</td>
<td>1</td>
</tr>
<tr>
<td>4178</td>
<td>Port Melbourne</td>
<td>2.8000</td>
<td>2018-09-01</td>
<td>0</td>
</tr>
<tr>
<td>4179</td>
<td>Box Hill Hawks</td>
<td>1.4300</td>
<td>2018-09-01</td>
<td>1</td>
</tr>
<tr>
<td>4180</td>
<td>Casey Demons</td>
<td>1.9000</td>
<td>2018-09-01</td>
<td>1</td>
</tr>
<tr>
<td>4181</td>
<td>West Perth</td>
<td>2.7382</td>
<td>2018-09-01</td>
<td>0</td>
</tr>
</tbody>
</table>
<p>We now have a DataFrame that looks nice and easy to join with our other DataFrames. Now let's lean up the match_details DataFrame.</p>
<pre><code class="language-python"># Define a function which cleans the match results df, and separates each teams' stats onto individual rows
def get_cleaned_match_results(df=None):
    # If a df hasn't been specified as a parameter, read the match_results df
    if df is None:
        df = pd.read_csv(&quot;data/afl_match_results.csv&quot;)

    # Create column lists to loop through - these are the columns we want in home and away dfs
    home_columns = ['Game', 'Date', 'Round.Number', 'Home.Team', 'Home.Goals', 'Home.Behinds', 'Home.Points', 'Margin', 'Venue', 'Away.Team', 'Away.Goals', 'Away.Behinds', 'Away.Points']
    away_columns = ['Game', 'Date', 'Round.Number', 'Away.Team', 'Away.Goals', 'Away.Behinds', 'Away.Points', 'Margin', 'Venue', 'Home.Team', 'Home.Goals', 'Home.Behinds', 'Home.Points']

    mapping = ['game', 'date', 'round', 'team', 'goals', 'behinds', 'points', 'margin', 'venue', 'opponent', 'opponent_goals', 'opponent_behinds', 'opponent_points']

    team_name_mapping = {
    'Brisbane Lions': 'Brisbane',
    'Footscray': 'Western Bulldogs'
    }

    # Create a df with only home games
    df_home = (df[home_columns]
                .rename(columns={old_col: new_col for old_col, new_col in zip(home_columns, mapping)})
                .assign(home_game=1))

    # Create a df with only away games
    df_away = (df[away_columns]
                .rename(columns={old_col: new_col for old_col, new_col in zip(away_columns, mapping)})
                .assign(home_game=0,
                        margin=lambda df: df.margin * -1))

    # Append these dfs together
    new_df = (df_home.append(df_away)
                     .sort_values(by='game') # Sort by game ID
                     .reset_index(drop=True) # Reset index
                     .assign(date=lambda df: pd.to_datetime(df.date)) # Create a datetime column
                     .replace(team_name_mapping)) # Rename team names to be consistent with other dfs
    return new_df
</code></pre>
<pre><code class="language-python">match_results = get_cleaned_match_results(match_results)
match_results.head()
</code></pre>
<table>
<thead>
<tr>
<th></th>
<th>game</th>
<th>date</th>
<th>round</th>
<th>team</th>
<th>goals</th>
<th>behinds</th>
<th>points</th>
<th>margin</th>
<th>venue</th>
<th>opponent</th>
<th>opponent_goals</th>
<th>opponent_behinds</th>
<th>opponent_points</th>
<th>home_game</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>1</td>
<td>1897-05-08</td>
<td>1</td>
<td>Fitzroy</td>
<td>6</td>
<td>13</td>
<td>49</td>
<td>33</td>
<td>Brunswick St</td>
<td>Carlton</td>
<td>2</td>
<td>4</td>
<td>16</td>
<td>1</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>1897-05-08</td>
<td>1</td>
<td>Carlton</td>
<td>2</td>
<td>4</td>
<td>16</td>
<td>-33</td>
<td>Brunswick St</td>
<td>Fitzroy</td>
<td>6</td>
<td>13</td>
<td>49</td>
<td>0</td>
</tr>
<tr>
<td>2</td>
<td>2</td>
<td>1897-05-08</td>
<td>1</td>
<td>Collingwood</td>
<td>5</td>
<td>11</td>
<td>41</td>
<td>25</td>
<td>Victoria Park</td>
<td>St Kilda</td>
<td>2</td>
<td>4</td>
<td>16</td>
<td>1</td>
</tr>
<tr>
<td>3</td>
<td>2</td>
<td>1897-05-08</td>
<td>1</td>
<td>St Kilda</td>
<td>2</td>
<td>4</td>
<td>16</td>
<td>-25</td>
<td>Victoria Park</td>
<td>Collingwood</td>
<td>5</td>
<td>11</td>
<td>41</td>
<td>0</td>
</tr>
<tr>
<td>4</td>
<td>3</td>
<td>1897-05-08</td>
<td>1</td>
<td>Geelong</td>
<td>3</td>
<td>6</td>
<td>24</td>
<td>-23</td>
<td>Corio Oval</td>
<td>Essendon</td>
<td>7</td>
<td>5</td>
<td>47</td>
<td>1</td>
</tr>
</tbody>
</table>
<p>Now we have both the odds DataFrame and match_results DataFrame ready for feature creation! Finally, we will aggregate the player_stats DataFrame stats for each game rather than individual player stats. For this DataFrame we have regular stats, such as disposals, marks etc. and Advanced Stats, such as Tackles Inside 50 and Metres Gained. However these advanced stats are only available from 2015, so we will not be using them in this tutorial - as there isn't enough data from 2015 to train our models.</p>
<p>Let's now aggregate the player_stats DataFrame.</p>
<pre><code class="language-python">def get_cleaned_aggregate_player_stats(df=None):
    # If a df hasn't been specified as a parameter, read the player_stats df
    if df is None:
        df = pd.read_csv(&quot;data/afl_player_stats.csv&quot;)

    agg_stats = (df.rename(columns={ # Rename columns to lowercase
                    'Season': 'season',
                    'Round': 'round',
                    'Team': 'team',
                    'Opposition': 'opponent',
                    'Date': 'date'
                    })
                   .groupby(by=['date', 'season', 'team', 'opponent'], as_index=False) # Groupby to aggregate the stats for each game
                   .sum()
                   .drop(columns=['DE', 'TOG', 'Match_id']) # Drop columns
                   .assign(date=lambda df: pd.to_datetime(df.date, format=&quot;%d/%m/%Y&quot;)) # Create a datetime object
                   .sort_values(by='date')
                   .reset_index(drop=True))
    return agg_stats
</code></pre>
<pre><code class="language-python">agg_stats = get_cleaned_aggregate_player_stats(player_stats)
</code></pre>
<pre><code class="language-python">agg_stats.tail()
</code></pre>
<table>
<thead>
<tr>
<th></th>
<th>date</th>
<th>season</th>
<th>team</th>
<th>opponent</th>
<th>AF</th>
<th>B</th>
<th>BO</th>
<th>CCL</th>
<th>CG</th>
<th>CL</th>
<th>CM</th>
<th>CP</th>
<th>D</th>
<th>ED</th>
<th>FA</th>
<th>FF</th>
<th>G</th>
<th>GA</th>
<th>HB</th>
<th>HO</th>
<th>I50</th>
<th>ITC</th>
<th>K</th>
<th>M</th>
<th>MG</th>
<th>MI5</th>
<th>One.Percenters</th>
<th>R50</th>
<th>SC</th>
<th>SCL</th>
<th>SI</th>
<th>T</th>
<th>T5</th>
<th>TO</th>
<th>UP</th>
</tr>
</thead>
<tbody>
<tr>
<td>3621</td>
<td>2018-08-26</td>
<td>2018</td>
<td>Brisbane</td>
<td>West Coast</td>
<td>1652</td>
<td>5</td>
<td>0</td>
<td>14.0</td>
<td>49</td>
<td>37</td>
<td>8</td>
<td>132</td>
<td>394</td>
<td>302</td>
<td>20</td>
<td>18</td>
<td>11</td>
<td>9</td>
<td>167</td>
<td>48</td>
<td>49</td>
<td>59.0</td>
<td>227</td>
<td>104</td>
<td>5571.0</td>
<td>6</td>
<td>48</td>
<td>39</td>
<td>1645</td>
<td>23.0</td>
<td>86.0</td>
<td>62</td>
<td>13.0</td>
<td>69.0</td>
<td>256</td>
</tr>
<tr>
<td>3622</td>
<td>2018-08-26</td>
<td>2018</td>
<td>West Coast</td>
<td>Brisbane</td>
<td>1548</td>
<td>11</td>
<td>5</td>
<td>13.0</td>
<td>49</td>
<td>42</td>
<td>9</td>
<td>141</td>
<td>360</td>
<td>262</td>
<td>18</td>
<td>20</td>
<td>14</td>
<td>8</td>
<td>137</td>
<td>39</td>
<td>56</td>
<td>70.0</td>
<td>223</td>
<td>95</td>
<td>5809.0</td>
<td>12</td>
<td>39</td>
<td>34</td>
<td>1655</td>
<td>29.0</td>
<td>94.0</td>
<td>55</td>
<td>6.0</td>
<td>59.0</td>
<td>217</td>
</tr>
<tr>
<td>3623</td>
<td>2018-08-26</td>
<td>2018</td>
<td>St Kilda</td>
<td>North Melbourne</td>
<td>1587</td>
<td>8</td>
<td>11</td>
<td>19.0</td>
<td>48</td>
<td>33</td>
<td>7</td>
<td>125</td>
<td>383</td>
<td>299</td>
<td>18</td>
<td>14</td>
<td>14</td>
<td>13</td>
<td>173</td>
<td>23</td>
<td>48</td>
<td>68.0</td>
<td>210</td>
<td>112</td>
<td>5522.0</td>
<td>14</td>
<td>46</td>
<td>35</td>
<td>1568</td>
<td>14.0</td>
<td>95.0</td>
<td>50</td>
<td>7.0</td>
<td>77.0</td>
<td>269</td>
</tr>
<tr>
<td>3624</td>
<td>2018-08-26</td>
<td>2018</td>
<td>GWS</td>
<td>Melbourne</td>
<td>1449</td>
<td>7</td>
<td>17</td>
<td>14.0</td>
<td>42</td>
<td>31</td>
<td>12</td>
<td>111</td>
<td>355</td>
<td>274</td>
<td>19</td>
<td>13</td>
<td>8</td>
<td>7</td>
<td>159</td>
<td>18</td>
<td>50</td>
<td>54.0</td>
<td>196</td>
<td>110</td>
<td>5416.0</td>
<td>10</td>
<td>62</td>
<td>34</td>
<td>1532</td>
<td>17.0</td>
<td>78.0</td>
<td>46</td>
<td>5.0</td>
<td>58.0</td>
<td>254</td>
</tr>
<tr>
<td>3625</td>
<td>2018-08-26</td>
<td>2018</td>
<td>Melbourne</td>
<td>GWS</td>
<td>1712</td>
<td>8</td>
<td>12</td>
<td>10.0</td>
<td>38</td>
<td>30</td>
<td>12</td>
<td>139</td>
<td>403</td>
<td>302</td>
<td>13</td>
<td>19</td>
<td>15</td>
<td>14</td>
<td>181</td>
<td>48</td>
<td>54</td>
<td>59.0</td>
<td>222</td>
<td>106</td>
<td>6198.0</td>
<td>16</td>
<td>34</td>
<td>39</td>
<td>1768</td>
<td>20.0</td>
<td>147.0</td>
<td>60</td>
<td>2.0</td>
<td>53.0</td>
<td>269</td>
</tr>
</tbody>
</table>
<p>We now have a three fully prepared DataFrames which are almost ready to be analysed and for a model to be built on! Let's have a look at how they look and then merge them together into our final DataFrame.</p>
<pre><code class="language-python">odds.tail(3)
</code></pre>
<table>
<thead>
<tr>
<th></th>
<th>team</th>
<th>odds</th>
<th>date</th>
<th>home_game</th>
</tr>
</thead>
<tbody>
<tr>
<td>4179</td>
<td>Box Hill Hawks</td>
<td>1.4300</td>
<td>2018-09-01</td>
<td>1</td>
</tr>
<tr>
<td>4180</td>
<td>Casey Demons</td>
<td>1.9000</td>
<td>2018-09-01</td>
<td>1</td>
</tr>
<tr>
<td>4181</td>
<td>West Perth</td>
<td>2.7382</td>
<td>2018-09-01</td>
<td>0</td>
</tr>
</tbody>
</table>
<pre><code class="language-python">match_results.tail(3)
</code></pre>
<table>
<thead>
<tr>
<th></th>
<th>game</th>
<th>date</th>
<th>round</th>
<th>team</th>
<th>goals</th>
<th>behinds</th>
<th>points</th>
<th>margin</th>
<th>venue</th>
<th>opponent</th>
<th>opponent_goals</th>
<th>opponent_behinds</th>
<th>opponent_points</th>
<th>home_game</th>
</tr>
</thead>
<tbody>
<tr>
<td>30793</td>
<td>15397</td>
<td>2018-08-26</td>
<td>23</td>
<td>Melbourne</td>
<td>15</td>
<td>12</td>
<td>102</td>
<td>45</td>
<td>M.C.G.</td>
<td>GWS</td>
<td>8</td>
<td>9</td>
<td>57</td>
<td>1</td>
</tr>
<tr>
<td>30794</td>
<td>15398</td>
<td>2018-08-26</td>
<td>23</td>
<td>St Kilda</td>
<td>14</td>
<td>10</td>
<td>94</td>
<td>-23</td>
<td>Docklands</td>
<td>North Melbourne</td>
<td>17</td>
<td>15</td>
<td>117</td>
<td>1</td>
</tr>
<tr>
<td>30795</td>
<td>15398</td>
<td>2018-08-26</td>
<td>23</td>
<td>North Melbourne</td>
<td>17</td>
<td>15</td>
<td>117</td>
<td>23</td>
<td>Docklands</td>
<td>St Kilda</td>
<td>14</td>
<td>10</td>
<td>94</td>
<td>0</td>
</tr>
</tbody>
</table>
<pre><code class="language-python">agg_stats.tail(3)
</code></pre>
<table>
<thead>
<tr>
<th></th>
<th>date</th>
<th>season</th>
<th>team</th>
<th>opponent</th>
<th>AF</th>
<th>B</th>
<th>BO</th>
<th>CCL</th>
<th>CG</th>
<th>CL</th>
<th>CM</th>
<th>CP</th>
<th>D</th>
<th>ED</th>
<th>FA</th>
<th>FF</th>
<th>G</th>
<th>GA</th>
<th>HB</th>
<th>HO</th>
<th>I50</th>
<th>ITC</th>
<th>K</th>
<th>M</th>
<th>MG</th>
<th>MI5</th>
<th>One.Percenters</th>
<th>R50</th>
<th>SC</th>
<th>SCL</th>
<th>SI</th>
<th>T</th>
<th>T5</th>
<th>TO</th>
<th>UP</th>
</tr>
</thead>
<tbody>
<tr>
<td>3623</td>
<td>2018-08-26</td>
<td>2018</td>
<td>St Kilda</td>
<td>North Melbourne</td>
<td>1587</td>
<td>8</td>
<td>11</td>
<td>19.0</td>
<td>48</td>
<td>33</td>
<td>7</td>
<td>125</td>
<td>383</td>
<td>299</td>
<td>18</td>
<td>14</td>
<td>14</td>
<td>13</td>
<td>173</td>
<td>23</td>
<td>48</td>
<td>68.0</td>
<td>210</td>
<td>112</td>
<td>5522.0</td>
<td>14</td>
<td>46</td>
<td>35</td>
<td>1568</td>
<td>14.0</td>
<td>95.0</td>
<td>50</td>
<td>7.0</td>
<td>77.0</td>
<td>269</td>
</tr>
<tr>
<td>3624</td>
<td>2018-08-26</td>
<td>2018</td>
<td>GWS</td>
<td>Melbourne</td>
<td>1449</td>
<td>7</td>
<td>17</td>
<td>14.0</td>
<td>42</td>
<td>31</td>
<td>12</td>
<td>111</td>
<td>355</td>
<td>274</td>
<td>19</td>
<td>13</td>
<td>8</td>
<td>7</td>
<td>159</td>
<td>18</td>
<td>50</td>
<td>54.0</td>
<td>196</td>
<td>110</td>
<td>5416.0</td>
<td>10</td>
<td>62</td>
<td>34</td>
<td>1532</td>
<td>17.0</td>
<td>78.0</td>
<td>46</td>
<td>5.0</td>
<td>58.0</td>
<td>254</td>
</tr>
<tr>
<td>3625</td>
<td>2018-08-26</td>
<td>2018</td>
<td>Melbourne</td>
<td>GWS</td>
<td>1712</td>
<td>8</td>
<td>12</td>
<td>10.0</td>
<td>38</td>
<td>30</td>
<td>12</td>
<td>139</td>
<td>403</td>
<td>302</td>
<td>13</td>
<td>19</td>
<td>15</td>
<td>14</td>
<td>181</td>
<td>48</td>
<td>54</td>
<td>59.0</td>
<td>222</td>
<td>106</td>
<td>6198.0</td>
<td>16</td>
<td>34</td>
<td>39</td>
<td>1768</td>
<td>20.0</td>
<td>147.0</td>
<td>60</td>
<td>2.0</td>
<td>53.0</td>
<td>269</td>
</tr>
</tbody>
</table>
<pre><code class="language-python">merged_df = (odds[odds.team.isin(agg_stats.team.unique())]
                .pipe(pd.merge, match_results, on=['date', 'team', 'home_game'])
                .pipe(pd.merge, agg_stats, on=['date', 'team', 'opponent'])
                .sort_values(by=['game']))
</code></pre>
<pre><code class="language-python">merged_df.tail(3)
</code></pre>
<table>
<thead>
<tr>
<th></th>
<th>team</th>
<th>odds</th>
<th>date</th>
<th>home_game</th>
<th>game</th>
<th>round</th>
<th>goals</th>
<th>behinds</th>
<th>points</th>
<th>margin</th>
<th>venue</th>
<th>opponent</th>
<th>opponent_goals</th>
<th>opponent_behinds</th>
<th>opponent_points</th>
<th>season</th>
<th>AF</th>
<th>B</th>
<th>BO</th>
<th>CCL</th>
<th>CG</th>
<th>CL</th>
<th>CM</th>
<th>CP</th>
<th>D</th>
<th>ED</th>
<th>FA</th>
<th>FF</th>
<th>G</th>
<th>GA</th>
<th>HB</th>
<th>HO</th>
<th>I50</th>
<th>ITC</th>
<th>K</th>
<th>M</th>
<th>MG</th>
<th>MI5</th>
<th>One.Percenters</th>
<th>R50</th>
<th>SC</th>
<th>SCL</th>
<th>SI</th>
<th>T</th>
<th>T5</th>
<th>TO</th>
<th>UP</th>
</tr>
</thead>
<tbody>
<tr>
<td>3199</td>
<td>Melbourne</td>
<td>1.5116</td>
<td>2018-08-26</td>
<td>1</td>
<td>15397</td>
<td>23</td>
<td>15</td>
<td>12</td>
<td>102</td>
<td>45</td>
<td>M.C.G.</td>
<td>GWS</td>
<td>8</td>
<td>9</td>
<td>57</td>
<td>2018</td>
<td>1712</td>
<td>8</td>
<td>12</td>
<td>10.0</td>
<td>38</td>
<td>30</td>
<td>12</td>
<td>139</td>
<td>403</td>
<td>302</td>
<td>13</td>
<td>19</td>
<td>15</td>
<td>14</td>
<td>181</td>
<td>48</td>
<td>54</td>
<td>59.0</td>
<td>222</td>
<td>106</td>
<td>6198.0</td>
<td>16</td>
<td>34</td>
<td>39</td>
<td>1768</td>
<td>20.0</td>
<td>147.0</td>
<td>60</td>
<td>2.0</td>
<td>53.0</td>
<td>269</td>
</tr>
<tr>
<td>3195</td>
<td>North Melbourne</td>
<td>1.3936</td>
<td>2018-08-26</td>
<td>0</td>
<td>15398</td>
<td>23</td>
<td>17</td>
<td>15</td>
<td>117</td>
<td>23</td>
<td>Docklands</td>
<td>St Kilda</td>
<td>14</td>
<td>10</td>
<td>94</td>
<td>2018</td>
<td>1707</td>
<td>13</td>
<td>7</td>
<td>15.0</td>
<td>50</td>
<td>24</td>
<td>6</td>
<td>131</td>
<td>425</td>
<td>322</td>
<td>14</td>
<td>18</td>
<td>17</td>
<td>13</td>
<td>201</td>
<td>32</td>
<td>59</td>
<td>77.0</td>
<td>224</td>
<td>106</td>
<td>5833.0</td>
<td>23</td>
<td>33</td>
<td>29</td>
<td>1735</td>
<td>9.0</td>
<td>154.0</td>
<td>48</td>
<td>9.0</td>
<td>66.0</td>
<td>300</td>
</tr>
<tr>
<td>3200</td>
<td>St Kilda</td>
<td>3.5178</td>
<td>2018-08-26</td>
<td>1</td>
<td>15398</td>
<td>23</td>
<td>14</td>
<td>10</td>
<td>94</td>
<td>-23</td>
<td>Docklands</td>
<td>North Melbourne</td>
<td>17</td>
<td>15</td>
<td>117</td>
<td>2018</td>
<td>1587</td>
<td>8</td>
<td>11</td>
<td>19.0</td>
<td>48</td>
<td>33</td>
<td>7</td>
<td>125</td>
<td>383</td>
<td>299</td>
<td>18</td>
<td>14</td>
<td>14</td>
<td>13</td>
<td>173</td>
<td>23</td>
<td>48</td>
<td>68.0</td>
<td>210</td>
<td>112</td>
<td>5522.0</td>
<td>14</td>
<td>46</td>
<td>35</td>
<td>1568</td>
<td>14.0</td>
<td>95.0</td>
<td>50</td>
<td>7.0</td>
<td>77.0</td>
<td>269</td>
</tr>
</tbody>
</table>
<p>Great! We now have a clean looking datset with each row representing one team in a game. Let's now eliminate the outliers from a dataset. We know that Essendon had a doping scandal which resulted in their entire team being banned for a year in 2016, so let's remove all of their 2016 games. To do this we will filter based on the team and season, and then invert this with ~.</p>
<pre><code class="language-python"># Define a function which eliminates outliers
def outlier_eliminator(df):
    # Eliminate Essendon 2016 games
    essendon_filter_criteria = ~(((df['team'] == 'Essendon') &amp; (df['season'] == 2016)) | ((df['opponent'] == 'Essendon') &amp; (df['season'] == 2016)))
    df = df[essendon_filter_criteria].reset_index(drop=True)

    return df
</code></pre>
<pre><code class="language-python">afl_data = outlier_eliminator(merged_df)
</code></pre>
<pre><code class="language-python">afl_data.tail(3)
</code></pre>
<table>
<thead>
<tr>
<th></th>
<th>team</th>
<th>odds</th>
<th>date</th>
<th>home_game</th>
<th>game</th>
<th>round</th>
<th>goals</th>
<th>behinds</th>
<th>points</th>
<th>margin</th>
<th>venue</th>
<th>opponent</th>
<th>opponent_goals</th>
<th>opponent_behinds</th>
<th>opponent_points</th>
<th>season</th>
<th>AF</th>
<th>B</th>
<th>BO</th>
<th>CCL</th>
<th>CG</th>
<th>CL</th>
<th>CM</th>
<th>CP</th>
<th>D</th>
<th>ED</th>
<th>FA</th>
<th>FF</th>
<th>G</th>
<th>GA</th>
<th>HB</th>
<th>HO</th>
<th>I50</th>
<th>ITC</th>
<th>K</th>
<th>M</th>
<th>MG</th>
<th>MI5</th>
<th>One.Percenters</th>
<th>R50</th>
<th>SC</th>
<th>SCL</th>
<th>SI</th>
<th>T</th>
<th>T5</th>
<th>TO</th>
<th>UP</th>
</tr>
</thead>
<tbody>
<tr>
<td>3154</td>
<td>Melbourne</td>
<td>1.5116</td>
<td>2018-08-26</td>
<td>1</td>
<td>15397</td>
<td>23</td>
<td>15</td>
<td>12</td>
<td>102</td>
<td>45</td>
<td>M.C.G.</td>
<td>GWS</td>
<td>8</td>
<td>9</td>
<td>57</td>
<td>2018</td>
<td>1712</td>
<td>8</td>
<td>12</td>
<td>10.0</td>
<td>38</td>
<td>30</td>
<td>12</td>
<td>139</td>
<td>403</td>
<td>302</td>
<td>13</td>
<td>19</td>
<td>15</td>
<td>14</td>
<td>181</td>
<td>48</td>
<td>54</td>
<td>59.0</td>
<td>222</td>
<td>106</td>
<td>6198.0</td>
<td>16</td>
<td>34</td>
<td>39</td>
<td>1768</td>
<td>20.0</td>
<td>147.0</td>
<td>60</td>
<td>2.0</td>
<td>53.0</td>
<td>269</td>
</tr>
<tr>
<td>3155</td>
<td>North Melbourne</td>
<td>1.3936</td>
<td>2018-08-26</td>
<td>0</td>
<td>15398</td>
<td>23</td>
<td>17</td>
<td>15</td>
<td>117</td>
<td>23</td>
<td>Docklands</td>
<td>St Kilda</td>
<td>14</td>
<td>10</td>
<td>94</td>
<td>2018</td>
<td>1707</td>
<td>13</td>
<td>7</td>
<td>15.0</td>
<td>50</td>
<td>24</td>
<td>6</td>
<td>131</td>
<td>425</td>
<td>322</td>
<td>14</td>
<td>18</td>
<td>17</td>
<td>13</td>
<td>201</td>
<td>32</td>
<td>59</td>
<td>77.0</td>
<td>224</td>
<td>106</td>
<td>5833.0</td>
<td>23</td>
<td>33</td>
<td>29</td>
<td>1735</td>
<td>9.0</td>
<td>154.0</td>
<td>48</td>
<td>9.0</td>
<td>66.0</td>
<td>300</td>
</tr>
<tr>
<td>3156</td>
<td>St Kilda</td>
<td>3.5178</td>
<td>2018-08-26</td>
<td>1</td>
<td>15398</td>
<td>23</td>
<td>14</td>
<td>10</td>
<td>94</td>
<td>-23</td>
<td>Docklands</td>
<td>North Melbourne</td>
<td>17</td>
<td>15</td>
<td>117</td>
<td>2018</td>
<td>1587</td>
<td>8</td>
<td>11</td>
<td>19.0</td>
<td>48</td>
<td>33</td>
<td>7</td>
<td>125</td>
<td>383</td>
<td>299</td>
<td>18</td>
<td>14</td>
<td>14</td>
<td>13</td>
<td>173</td>
<td>23</td>
<td>48</td>
<td>68.0</td>
<td>210</td>
<td>112</td>
<td>5522.0</td>
<td>14</td>
<td>46</td>
<td>35</td>
<td>1568</td>
<td>14.0</td>
<td>95.0</td>
<td>50</td>
<td>7.0</td>
<td>77.0</td>
<td>269</td>
</tr>
</tbody>
</table>
<p>Finally, let's mark all of the columns that we are going to use in feature creation with the string 'f_' at the start of their column name so that we can easily filter for these columns.</p>
<pre><code class="language-python">non_feature_cols = ['team', 'date', 'home_game', 'game', 'round', 'venue', 'opponent', 'season']
afl_data = afl_data.rename(columns={col: 'f_' + col for col in afl_data if col not in non_feature_cols})
</code></pre>
<pre><code class="language-python">afl_data.tail(3)
</code></pre>
<table>
<thead>
<tr>
<th></th>
<th>team</th>
<th>f_odds</th>
<th>date</th>
<th>home_game</th>
<th>game</th>
<th>round</th>
<th>f_goals</th>
<th>f_behinds</th>
<th>f_points</th>
<th>f_margin</th>
<th>venue</th>
<th>opponent</th>
<th>f_opponent_goals</th>
<th>f_opponent_behinds</th>
<th>f_opponent_points</th>
<th>season</th>
<th>f_AF</th>
<th>f_B</th>
<th>f_BO</th>
<th>f_CCL</th>
<th>f_CG</th>
<th>f_CL</th>
<th>f_CM</th>
<th>f_CP</th>
<th>f_D</th>
<th>f_ED</th>
<th>f_FA</th>
<th>f_FF</th>
<th>f_G</th>
<th>f_GA</th>
<th>f_HB</th>
<th>f_HO</th>
<th>f_I50</th>
<th>f_ITC</th>
<th>f_K</th>
<th>f_M</th>
<th>f_MG</th>
<th>f_MI5</th>
<th>f_One.Percenters</th>
<th>f_R50</th>
<th>f_SC</th>
<th>f_SCL</th>
<th>f_SI</th>
<th>f_T</th>
<th>f_T5</th>
<th>f_TO</th>
<th>f_UP</th>
</tr>
</thead>
<tbody>
<tr>
<td>3154</td>
<td>Melbourne</td>
<td>1.5116</td>
<td>2018-08-26</td>
<td>1</td>
<td>15397</td>
<td>23</td>
<td>15</td>
<td>12</td>
<td>102</td>
<td>45</td>
<td>M.C.G.</td>
<td>GWS</td>
<td>8</td>
<td>9</td>
<td>57</td>
<td>2018</td>
<td>1712</td>
<td>8</td>
<td>12</td>
<td>10.0</td>
<td>38</td>
<td>30</td>
<td>12</td>
<td>139</td>
<td>403</td>
<td>302</td>
<td>13</td>
<td>19</td>
<td>15</td>
<td>14</td>
<td>181</td>
<td>48</td>
<td>54</td>
<td>59.0</td>
<td>222</td>
<td>106</td>
<td>6198.0</td>
<td>16</td>
<td>34</td>
<td>39</td>
<td>1768</td>
<td>20.0</td>
<td>147.0</td>
<td>60</td>
<td>2.0</td>
<td>53.0</td>
<td>269</td>
</tr>
<tr>
<td>3155</td>
<td>North Melbourne</td>
<td>1.3936</td>
<td>2018-08-26</td>
<td>0</td>
<td>15398</td>
<td>23</td>
<td>17</td>
<td>15</td>
<td>117</td>
<td>23</td>
<td>Docklands</td>
<td>St Kilda</td>
<td>14</td>
<td>10</td>
<td>94</td>
<td>2018</td>
<td>1707</td>
<td>13</td>
<td>7</td>
<td>15.0</td>
<td>50</td>
<td>24</td>
<td>6</td>
<td>131</td>
<td>425</td>
<td>322</td>
<td>14</td>
<td>18</td>
<td>17</td>
<td>13</td>
<td>201</td>
<td>32</td>
<td>59</td>
<td>77.0</td>
<td>224</td>
<td>106</td>
<td>5833.0</td>
<td>23</td>
<td>33</td>
<td>29</td>
<td>1735</td>
<td>9.0</td>
<td>154.0</td>
<td>48</td>
<td>9.0</td>
<td>66.0</td>
<td>300</td>
</tr>
<tr>
<td>3156</td>
<td>St Kilda</td>
<td>3.5178</td>
<td>2018-08-26</td>
<td>1</td>
<td>15398</td>
<td>23</td>
<td>14</td>
<td>10</td>
<td>94</td>
<td>-23</td>
<td>Docklands</td>
<td>North Melbourne</td>
<td>17</td>
<td>15</td>
<td>117</td>
<td>2018</td>
<td>1587</td>
<td>8</td>
<td>11</td>
<td>19.0</td>
<td>48</td>
<td>33</td>
<td>7</td>
<td>125</td>
<td>383</td>
<td>299</td>
<td>18</td>
<td>14</td>
<td>14</td>
<td>13</td>
<td>173</td>
<td>23</td>
<td>48</td>
<td>68.0</td>
<td>210</td>
<td>112</td>
<td>5522.0</td>
<td>14</td>
<td>46</td>
<td>35</td>
<td>1568</td>
<td>14.0</td>
<td>95.0</td>
<td>50</td>
<td>7.0</td>
<td>77.0</td>
<td>269</td>
</tr>
</tbody>
</table>
<p>Our data is now fully ready to be explored and for features to be created.</p>
<hr />
<h1 id="02-feature-creation">02. Feature Creation</h1>
<p>These tutorials will walk you through how to construct your own basic AFL model. The output will be odds for each team to win, which will be shown on <a href="https://www.betfair.com.au/hub/tools/models/afl-prediction-model/">The Hub</a>.</p>
<p>In this notebook we will walk you through creating features from our dataset, which was cleaned in the first tutorial. Feature engineering is an integral part of the Data Science process. Creative and smart features can be the difference between an average performing model and a model profitable which beats the market odds.</p>
<hr />
<h2 id="grabbing-our-dataset">Grabbing Our Dataset</h2>
<p>First, we will import our required modules, as well as the prepare_afl_data function which we created in our afl_data_cleaning script. This essentially cleans all the data for us so that we're ready to explore the data and make some features.</p>
<pre><code class="language-python"># Import modules
from afl_data_cleaning_v2 import *
import afl_data_cleaning_v2
import pandas as pd
pd.set_option('display.max_columns', None)
import warnings
warnings.filterwarnings('ignore')
import numpy as np
</code></pre>
<pre><code class="language-python"># Use the prepare_afl_data function to prepare the data for us; this function condenses what we walked through in the previous tutorial
afl_data = prepare_afl_data()
</code></pre>
<pre><code class="language-python">afl_data.tail(3)
</code></pre>
<table>
<thead>
<tr>
<th></th>
<th>team</th>
<th>f_odds</th>
<th>date</th>
<th>home_game</th>
<th>game</th>
<th>round</th>
<th>f_goals</th>
<th>f_behinds</th>
<th>f_points</th>
<th>f_margin</th>
<th>venue</th>
<th>opponent</th>
<th>f_opponent_goals</th>
<th>f_opponent_behinds</th>
<th>f_opponent_points</th>
<th>season</th>
<th>f_AF</th>
<th>f_B</th>
<th>f_BO</th>
<th>f_CCL</th>
<th>f_CG</th>
<th>f_CL</th>
<th>f_CM</th>
<th>f_CP</th>
<th>f_D</th>
<th>f_ED</th>
<th>f_FA</th>
<th>f_FF</th>
<th>f_G</th>
<th>f_GA</th>
<th>f_HB</th>
<th>f_HO</th>
<th>f_I50</th>
<th>f_ITC</th>
<th>f_K</th>
<th>f_M</th>
<th>f_MG</th>
<th>f_MI5</th>
<th>f_One.Percenters</th>
<th>f_R50</th>
<th>f_SC</th>
<th>f_SCL</th>
<th>f_SI</th>
<th>f_T</th>
<th>f_T5</th>
<th>f_TO</th>
<th>f_UP</th>
</tr>
</thead>
<tbody>
<tr>
<td>3154</td>
<td>Melbourne</td>
<td>1.5116</td>
<td>2018-08-26</td>
<td>1</td>
<td>15397</td>
<td>23</td>
<td>15</td>
<td>12</td>
<td>102</td>
<td>45</td>
<td>M.C.G.</td>
<td>GWS</td>
<td>8</td>
<td>9</td>
<td>57</td>
<td>2018</td>
<td>1712</td>
<td>8</td>
<td>12</td>
<td>10.0</td>
<td>38</td>
<td>30</td>
<td>12</td>
<td>139</td>
<td>403</td>
<td>302</td>
<td>13</td>
<td>19</td>
<td>15</td>
<td>14</td>
<td>181</td>
<td>48</td>
<td>54</td>
<td>59.0</td>
<td>222</td>
<td>106</td>
<td>6198.0</td>
<td>16</td>
<td>34</td>
<td>39</td>
<td>1768</td>
<td>20.0</td>
<td>147.0</td>
<td>60</td>
<td>2.0</td>
<td>53.0</td>
<td>269</td>
</tr>
<tr>
<td>3155</td>
<td>North Melbourne</td>
<td>1.3936</td>
<td>2018-08-26</td>
<td>0</td>
<td>15398</td>
<td>23</td>
<td>17</td>
<td>15</td>
<td>117</td>
<td>23</td>
<td>Docklands</td>
<td>St Kilda</td>
<td>14</td>
<td>10</td>
<td>94</td>
<td>2018</td>
<td>1707</td>
<td>13</td>
<td>7</td>
<td>15.0</td>
<td>50</td>
<td>24</td>
<td>6</td>
<td>131</td>
<td>425</td>
<td>322</td>
<td>14</td>
<td>18</td>
<td>17</td>
<td>13</td>
<td>201</td>
<td>32</td>
<td>59</td>
<td>77.0</td>
<td>224</td>
<td>106</td>
<td>5833.0</td>
<td>23</td>
<td>33</td>
<td>29</td>
<td>1735</td>
<td>9.0</td>
<td>154.0</td>
<td>48</td>
<td>9.0</td>
<td>66.0</td>
<td>300</td>
</tr>
<tr>
<td>3156</td>
<td>St Kilda</td>
<td>3.5178</td>
<td>2018-08-26</td>
<td>1</td>
<td>15398</td>
<td>23</td>
<td>14</td>
<td>10</td>
<td>94</td>
<td>-23</td>
<td>Docklands</td>
<td>North Melbourne</td>
<td>17</td>
<td>15</td>
<td>117</td>
<td>2018</td>
<td>1587</td>
<td>8</td>
<td>11</td>
<td>19.0</td>
<td>48</td>
<td>33</td>
<td>7</td>
<td>125</td>
<td>383</td>
<td>299</td>
<td>18</td>
<td>14</td>
<td>14</td>
<td>13</td>
<td>173</td>
<td>23</td>
<td>48</td>
<td>68.0</td>
<td>210</td>
<td>112</td>
<td>5522.0</td>
<td>14</td>
<td>46</td>
<td>35</td>
<td>1568</td>
<td>14.0</td>
<td>95.0</td>
<td>50</td>
<td>7.0</td>
<td>77.0</td>
<td>269</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="creating-a-feature-dataframe">Creating A Feature DataFrame</h2>
<p>Let's create a feature DataFrame and merge all of our features into this DataFrame as we go.</p>
<pre><code class="language-python">features = afl_data[['date', 'game', 'team', 'opponent', 'venue', 'home_game']].copy()
</code></pre>
<h3 id="what-each-column-refers-to">What Each Column Refers To</h3>
<p>Below is a DataFrame which outlines what each column refers to.</p>
<pre><code class="language-python">column_abbreviations = pd.read_csv(&quot;data/afl_data_columns_mapping.csv&quot;)
column_abbreviations
</code></pre>
<table>
<thead>
<tr>
<th></th>
<th>Feature Abbreviated</th>
<th>Feature</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>GA</td>
<td>Goal Assists</td>
</tr>
<tr>
<td>1</td>
<td>CP</td>
<td>Contested Possessions</td>
</tr>
<tr>
<td>2</td>
<td>UP</td>
<td>Uncontested Possessions</td>
</tr>
<tr>
<td>3</td>
<td>ED</td>
<td>Effective Disposals</td>
</tr>
<tr>
<td>4</td>
<td>CM</td>
<td>Contested Marks</td>
</tr>
<tr>
<td>5</td>
<td>MI5</td>
<td>Marks Inside 50</td>
</tr>
<tr>
<td>6</td>
<td>One.Percenters</td>
<td>One Percenters</td>
</tr>
<tr>
<td>7</td>
<td>BO</td>
<td>Bounces</td>
</tr>
<tr>
<td>8</td>
<td>K</td>
<td>Kicks</td>
</tr>
<tr>
<td>9</td>
<td>HB</td>
<td>Handballs</td>
</tr>
<tr>
<td>10</td>
<td>D</td>
<td>Disposals</td>
</tr>
<tr>
<td>11</td>
<td>M</td>
<td>Marks</td>
</tr>
<tr>
<td>12</td>
<td>G</td>
<td>Goals</td>
</tr>
<tr>
<td>13</td>
<td>B</td>
<td>Behinds</td>
</tr>
<tr>
<td>14</td>
<td>T</td>
<td>Tackles</td>
</tr>
<tr>
<td>15</td>
<td>HO</td>
<td>Hitouts</td>
</tr>
<tr>
<td>16</td>
<td>I50</td>
<td>Inside 50s</td>
</tr>
<tr>
<td>17</td>
<td>CL</td>
<td>Clearances</td>
</tr>
<tr>
<td>18</td>
<td>CG</td>
<td>Clangers</td>
</tr>
<tr>
<td>19</td>
<td>R50</td>
<td>Rebound 50s</td>
</tr>
<tr>
<td>20</td>
<td>FF</td>
<td>Frees For</td>
</tr>
<tr>
<td>21</td>
<td>FA</td>
<td>Frees Against</td>
</tr>
<tr>
<td>22</td>
<td>AF</td>
<td>AFL Fantasy Points</td>
</tr>
<tr>
<td>23</td>
<td>SC</td>
<td>Supercoach Points</td>
</tr>
<tr>
<td>24</td>
<td>CCL</td>
<td>Centre Clearances</td>
</tr>
<tr>
<td>25</td>
<td>SCL</td>
<td>Stoppage Clearances</td>
</tr>
<tr>
<td>26</td>
<td>SI</td>
<td>Score Involvements</td>
</tr>
<tr>
<td>27</td>
<td>MG</td>
<td>Metres Gained</td>
</tr>
<tr>
<td>28</td>
<td>TO</td>
<td>Turnovers</td>
</tr>
<tr>
<td>29</td>
<td>ITC</td>
<td>Intercepts</td>
</tr>
<tr>
<td>30</td>
<td>T5</td>
<td>Tackles Inside 50</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="feature-creation">Feature Creation</h2>
<p>Now let's think about what features we can create. We have a enormous amount of stats to sift through. To start, let's create some simple features based on our domain knowledge of Aussie Rules.</p>
<h3 id="creating-expontentially-weighted-rolling-averages-as-features">Creating Expontentially Weighted Rolling Averages as Features</h3>
<p>Next, we will create rolling averages of statistics such as Tackles, which we will use as features.</p>
<p>It is fair to assume that a team's performance in a certain stat may have predictive power to the overall result. And in general, if a team consistently performs well in this stat, this may have predictive power to the result of their future games. We can't simply train a model on stats from the game which we are trying to predict (i.e. data that we don't have before the game begins), as this will leak the result. We need to train our model on past data. One way of doing this is to train our model on average stats over a certain amount of games. If a team is averaging high in this stat, this may give insight into if they are a strong team. Similarly, if the team is averaging poorly in this stat (relative to the team they are playing), this may have predictive power and give rise to a predicted loss.</p>
<p>To do this we will create a function which calculates the rolling averages, known as create_exp_weighted_avgs, which takes our cleaned DataFrame as an input, as well as the alpha which, when higher, weights recent performances more than old performances. To read more about expontentially weighted moving averages, please read the documentation <a href="https://pandas.pydata.org/pandas-docs/stable/generated/pandas.DataFrame.ewm.html">here</a>.</p>
<p>First, we will grab all the columns which we want to create EMAs for, and then use our function to create the average for that column. We will create a new DataFrame and add these columns to this new DataFrame.</p>
<pre><code class="language-python"># Define a function which returns a DataFrame with the expontential moving average for each numeric stat
def create_exp_weighted_avgs(df, span):
    # Create a copy of the df with only the game id and the team - we will add cols to this df
    ema_features = df[['game', 'team']].copy()

    feature_names = [col for col in df.columns if col.startswith('f_')] # Get a list of columns we will iterate over

    for feature_name in feature_names:
        feature_ema = (df.groupby('team')[feature_name]
                         .transform(lambda row: (row.ewm(span=span)
                                                    .mean()
                                                    .shift(1))))
        ema_features[feature_name] = feature_ema

    return ema_features
</code></pre>
<pre><code class="language-python">features_rolling_averages = create_exp_weighted_avgs(afl_data, span=10)
</code></pre>
<pre><code class="language-python">features_rolling_averages.tail()
</code></pre>
<table>
<thead>
<tr>
<th></th>
<th>game</th>
<th>team</th>
<th>f_odds</th>
<th>f_goals</th>
<th>f_behinds</th>
<th>f_points</th>
<th>f_margin</th>
<th>f_opponent_goals</th>
<th>f_opponent_behinds</th>
<th>f_opponent_points</th>
<th>f_AF</th>
<th>f_B</th>
<th>f_BO</th>
<th>f_CCL</th>
<th>f_CG</th>
<th>f_CL</th>
<th>f_CM</th>
<th>f_CP</th>
<th>f_D</th>
<th>f_ED</th>
<th>f_FA</th>
<th>f_FF</th>
<th>f_G</th>
<th>f_GA</th>
<th>f_HB</th>
<th>f_HO</th>
<th>f_I50</th>
<th>f_ITC</th>
<th>f_K</th>
<th>f_M</th>
<th>f_MG</th>
<th>f_MI5</th>
<th>f_One.Percenters</th>
<th>f_R50</th>
<th>f_SC</th>
<th>f_SCL</th>
<th>f_SI</th>
<th>f_T</th>
<th>f_T5</th>
<th>f_TO</th>
<th>f_UP</th>
</tr>
</thead>
<tbody>
<tr>
<td>3152</td>
<td>15396</td>
<td>West Coast</td>
<td>2.094236</td>
<td>12.809630</td>
<td>10.047145</td>
<td>86.904928</td>
<td>8.888770</td>
<td>11.435452</td>
<td>9.403444</td>
<td>78.016158</td>
<td>3193.612782</td>
<td>16.472115</td>
<td>11.958482</td>
<td>23.379562</td>
<td>100.095244</td>
<td>68.252001</td>
<td>27.688669</td>
<td>284.463270</td>
<td>719.884644</td>
<td>525.878017</td>
<td>36.762440</td>
<td>44.867118</td>
<td>25.618202</td>
<td>17.522871</td>
<td>270.478779</td>
<td>88.139376</td>
<td>105.698031</td>
<td>148.005305</td>
<td>449.405865</td>
<td>201.198907</td>
<td>11581.929999</td>
<td>20.048124</td>
<td>95.018480</td>
<td>74.180967</td>
<td>3314.157893</td>
<td>44.872398</td>
<td>177.894442</td>
<td>126.985101</td>
<td>20.565549</td>
<td>138.876613</td>
<td>438.848376</td>
</tr>
<tr>
<td>3153</td>
<td>15397</td>
<td>GWS</td>
<td>1.805565</td>
<td>13.100372</td>
<td>13.179329</td>
<td>91.781563</td>
<td>18.527618</td>
<td>10.371198</td>
<td>11.026754</td>
<td>73.253945</td>
<td>3165.127358</td>
<td>19.875913</td>
<td>12.947209</td>
<td>25.114002</td>
<td>105.856671</td>
<td>80.609640</td>
<td>23.374884</td>
<td>303.160047</td>
<td>741.439198</td>
<td>534.520295</td>
<td>42.597317</td>
<td>38.160889</td>
<td>26.208715</td>
<td>18.688880</td>
<td>300.188301</td>
<td>81.540693</td>
<td>106.989070</td>
<td>143.032506</td>
<td>441.250897</td>
<td>173.050118</td>
<td>12091.630837</td>
<td>21.106142</td>
<td>103.077097</td>
<td>80.201059</td>
<td>3419.245919</td>
<td>55.495610</td>
<td>219.879895</td>
<td>138.202470</td>
<td>25.313148</td>
<td>135.966798</td>
<td>438.466439</td>
</tr>
<tr>
<td>3154</td>
<td>15397</td>
<td>Melbourne</td>
<td>1.706488</td>
<td>15.157271</td>
<td>13.815113</td>
<td>104.758740</td>
<td>25.170429</td>
<td>11.814319</td>
<td>8.702396</td>
<td>79.588311</td>
<td>3312.408470</td>
<td>22.077317</td>
<td>7.724955</td>
<td>28.364418</td>
<td>114.399147</td>
<td>78.406069</td>
<td>26.934677</td>
<td>324.352577</td>
<td>775.176933</td>
<td>547.385948</td>
<td>39.353251</td>
<td>36.025646</td>
<td>30.308918</td>
<td>22.461080</td>
<td>348.613592</td>
<td>99.787800</td>
<td>120.339062</td>
<td>154.417642</td>
<td>426.563341</td>
<td>178.102118</td>
<td>12395.717925</td>
<td>32.168752</td>
<td>96.390688</td>
<td>63.786515</td>
<td>3427.596843</td>
<td>50.041649</td>
<td>232.287556</td>
<td>144.875098</td>
<td>23.789233</td>
<td>149.042149</td>
<td>456.988552</td>
</tr>
<tr>
<td>3155</td>
<td>15398</td>
<td>North Melbourne</td>
<td>2.272313</td>
<td>12.721783</td>
<td>10.733785</td>
<td>87.064486</td>
<td>-1.214246</td>
<td>12.915796</td>
<td>10.783958</td>
<td>88.278732</td>
<td>3066.272143</td>
<td>17.322710</td>
<td>9.815243</td>
<td>26.015421</td>
<td>106.465181</td>
<td>67.504286</td>
<td>26.064079</td>
<td>291.259574</td>
<td>736.279779</td>
<td>534.154748</td>
<td>34.301603</td>
<td>40.908551</td>
<td>25.386136</td>
<td>17.816570</td>
<td>341.210547</td>
<td>81.541130</td>
<td>102.589427</td>
<td>145.265493</td>
<td>395.069232</td>
<td>173.089408</td>
<td>10875.002463</td>
<td>21.802751</td>
<td>82.347511</td>
<td>70.416194</td>
<td>3171.120023</td>
<td>41.488865</td>
<td>197.620152</td>
<td>122.547684</td>
<td>22.286256</td>
<td>142.780474</td>
<td>450.374058</td>
</tr>
<tr>
<td>3156</td>
<td>15398</td>
<td>St Kilda</td>
<td>5.516150</td>
<td>10.464266</td>
<td>11.957047</td>
<td>74.742643</td>
<td>-21.138101</td>
<td>14.105551</td>
<td>11.247440</td>
<td>95.880745</td>
<td>3094.163405</td>
<td>20.523847</td>
<td>14.569589</td>
<td>24.134276</td>
<td>102.540441</td>
<td>66.976211</td>
<td>18.018350</td>
<td>270.674857</td>
<td>773.086015</td>
<td>573.769838</td>
<td>41.319843</td>
<td>36.198820</td>
<td>20.850476</td>
<td>14.443658</td>
<td>364.405251</td>
<td>63.498760</td>
<td>103.803779</td>
<td>130.494307</td>
<td>408.680763</td>
<td>184.780054</td>
<td>10765.717942</td>
<td>21.572806</td>
<td>94.731555</td>
<td>65.790561</td>
<td>3228.278599</td>
<td>42.841935</td>
<td>196.086493</td>
<td>115.901425</td>
<td>18.796764</td>
<td>127.364334</td>
<td>508.844514</td>
</tr>
</tbody>
</table>
<p>As you can see our function worked perfectly! Now we have a full DataFrame of exponentially weighted moving averages. Note that as these rolling averages have been shifted by 1 to ensure no data leakage, the first round of the data will have all NA values. We can drop these later.</p>
<p>Let's add these averages to our features DataFrame</p>
<pre><code class="language-python">features = pd.merge(features, features_rolling_averages, on=['game', 'team'])
</code></pre>
<h3 id="creating-a-form-between-the-teams-feature">Creating a 'Form Between the Teams' Feature</h3>
<p>It is well known in Aussie Rules that often some teams perform better against certain teams than others. If we isolate our features to pure stats based on previous games not between the teams playing, or elo ratings, we won't account for any relationships between certain teams. An example is the <a href="https://en.wikipedia.org/wiki/Kennett_curse">Kennett Curse</a>, where Geelong won 11 consecutive games against Hawthorn, despite being similarly matched teams. Let's create a feature which calculates how many games a team has won against their opposition over a given window of games.</p>
<p>To do this, we will need to use historical data that dates back well before our current DataFrame starts at. Otherwise we will be using a lot of our games to calculate form, meaning we will have to drop these rows before feeding it into an algorithm. So let's use our prepare_match_results function which we defined in the afl_data_cleaning tutorial to grab a clean DataFrame of all match results since 1897. We can then calculate the form and join this to our current DataFrame.</p>
<pre><code class="language-python">match_results = afl_data_cleaning_v2.get_cleaned_match_results()
</code></pre>
<pre><code class="language-python">match_results.head(3)
</code></pre>
<table>
<thead>
<tr>
<th></th>
<th>game</th>
<th>date</th>
<th>round</th>
<th>team</th>
<th>goals</th>
<th>behinds</th>
<th>points</th>
<th>margin</th>
<th>venue</th>
<th>opponent</th>
<th>opponent_goals</th>
<th>opponent_behinds</th>
<th>opponent_points</th>
<th>home_game</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>1</td>
<td>1897-05-08</td>
<td>1</td>
<td>Fitzroy</td>
<td>6</td>
<td>13</td>
<td>49</td>
<td>33</td>
<td>Brunswick St</td>
<td>Carlton</td>
<td>2</td>
<td>4</td>
<td>16</td>
<td>1</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>1897-05-08</td>
<td>1</td>
<td>Carlton</td>
<td>2</td>
<td>4</td>
<td>16</td>
<td>-33</td>
<td>Brunswick St</td>
<td>Fitzroy</td>
<td>6</td>
<td>13</td>
<td>49</td>
<td>0</td>
</tr>
<tr>
<td>2</td>
<td>2</td>
<td>1897-05-08</td>
<td>1</td>
<td>Collingwood</td>
<td>5</td>
<td>11</td>
<td>41</td>
<td>25</td>
<td>Victoria Park</td>
<td>St Kilda</td>
<td>2</td>
<td>4</td>
<td>16</td>
<td>1</td>
</tr>
</tbody>
</table>
<pre><code class="language-python">form_btwn_teams = match_results[['game', 'team', 'opponent', 'margin']].copy()

form_btwn_teams['f_form_margin_btwn_teams'] = (match_results.groupby(['team', 'opponent'])['margin']
                                                          .transform(lambda row: row.rolling(5).mean().shift())
                                                          .fillna(0))

form_btwn_teams['f_form_past_5_btwn_teams'] = \
(match_results.assign(win=lambda df: df.apply(lambda row: 1 if row.margin &gt; 0 else 0, axis='columns'))
              .groupby(['team', 'opponent'])['win']
              .transform(lambda row: row.rolling(5).mean().shift() * 5)
              .fillna(0))
</code></pre>
<pre><code class="language-python">form_btwn_teams.tail(3)
</code></pre>
<table>
<thead>
<tr>
<th></th>
<th>game</th>
<th>team</th>
<th>opponent</th>
<th>margin</th>
<th>f_form_margin_btwn_teams</th>
<th>f_form_past_5_btwn_teams</th>
</tr>
</thead>
<tbody>
<tr>
<td>30793</td>
<td>15397</td>
<td>Melbourne</td>
<td>GWS</td>
<td>45</td>
<td>-23.2</td>
<td>2.0</td>
</tr>
<tr>
<td>30794</td>
<td>15398</td>
<td>St Kilda</td>
<td>North Melbourne</td>
<td>-23</td>
<td>-3.2</td>
<td>2.0</td>
</tr>
<tr>
<td>30795</td>
<td>15398</td>
<td>North Melbourne</td>
<td>St Kilda</td>
<td>23</td>
<td>3.2</td>
<td>3.0</td>
</tr>
</tbody>
</table>
<pre><code class="language-python"># Merge to our features df
features = pd.merge(features, form_btwn_teams.drop(columns=['margin']), on=['game', 'team', 'opponent'])
</code></pre>
<h3 id="creating-efficiency-features">Creating Efficiency Features</h3>
<h4 id="disposal-efficiency">Disposal Efficiency</h4>
<p>Disposal efficiency is pivotal in Aussie Rules football. If you are dispose of the ball effectively you are much more likely to score and much less likely to concede goals than if you dispose of it ineffectively.</p>
<p>Let's create a disposal efficiency feature by dividing Effective Disposals by Disposals.</p>
<h4 id="inside-50rebound-50-efficiency">Inside 50/Rebound 50 Efficiency</h4>
<p>Similarly, one could hypothesise that teams who keep the footy in their Inside 50 regularly will be more likely to score, whilst teams who are effective at getting the ball out of their Defensive 50 will be less likely to concede. Let's use this logic to create Inside 50 Efficiency and Rebound 50 Efficiency features.</p>
<p>The formula used will be:</p>
<pre><code>Inside 50 Efficiency = R50_Opponents / I50 (lower is better).
Rebound 50 Efficiency = R50 / I50_Opponents (higher is better).
</code></pre>
<p>Using these formulas, I50 Efficiency = R50 Efficiency_Opponent. So we will just need to create the formulas for I50 efficiency.
To create these features we will need the opposition's Inside 50s/Rebound 50s. So we will split out data into two DataFrames, create a new DataFrame by joining these two DataFrames on the Game, calculate our efficiency features, then join our features with our main features DataFrame.</p>
<pre><code class="language-python"># Get each match on single rows
single_row_df = (afl_data[['game', 'team', 'f_I50', 'f_R50', 'f_D', 'f_ED', 'home_game', ]]
                    .query('home_game == 1')
                    .rename(columns={'team': 'home_team', 'f_I50': 'f_I50_home', 'f_R50': 'f_R50_home', 'f_D': 'f_D_home', 'f_ED': 'f_ED_home'})
                    .drop(columns='home_game')
                    .pipe(pd.merge, afl_data[['game', 'team', 'f_I50', 'f_R50', 'f_D', 'f_ED', 'home_game']]
                                    .query('home_game == 0')
                                    .rename(columns={'team': 'away_team', 'f_I50': 'f_I50_away', 'f_R50': 'f_R50_away', 'f_D': 'f_D_away', 'f_ED': 'f_ED_away'})
                                    .drop(columns='home_game'), on='game'))
</code></pre>
<pre><code class="language-python">single_row_df.head()
</code></pre>
<table>
<thead>
<tr>
<th></th>
<th>game</th>
<th>home_team</th>
<th>f_I50_home</th>
<th>f_R50_home</th>
<th>f_D_home</th>
<th>f_ED_home</th>
<th>away_team</th>
<th>f_I50_away</th>
<th>f_R50_away</th>
<th>f_D_away</th>
<th>f_ED_away</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>13764</td>
<td>Carlton</td>
<td>69</td>
<td>21</td>
<td>373</td>
<td>268</td>
<td>Richmond</td>
<td>37</td>
<td>50</td>
<td>316</td>
<td>226</td>
</tr>
<tr>
<td>1</td>
<td>13765</td>
<td>Geelong</td>
<td>54</td>
<td>40</td>
<td>428</td>
<td>310</td>
<td>St Kilda</td>
<td>52</td>
<td>45</td>
<td>334</td>
<td>246</td>
</tr>
<tr>
<td>2</td>
<td>13766</td>
<td>Collingwood</td>
<td>70</td>
<td>38</td>
<td>398</td>
<td>289</td>
<td>Port Adelaide</td>
<td>50</td>
<td>44</td>
<td>331</td>
<td>232</td>
</tr>
<tr>
<td>3</td>
<td>13767</td>
<td>Adelaide</td>
<td>59</td>
<td>38</td>
<td>366</td>
<td>264</td>
<td>Hawthorn</td>
<td>54</td>
<td>38</td>
<td>372</td>
<td>264</td>
</tr>
<tr>
<td>4</td>
<td>13768</td>
<td>Brisbane</td>
<td>50</td>
<td>39</td>
<td>343</td>
<td>227</td>
<td>Fremantle</td>
<td>57</td>
<td>30</td>
<td>351</td>
<td>250</td>
</tr>
</tbody>
</table>
<pre><code class="language-python">single_row_df = single_row_df.assign(f_I50_efficiency_home=lambda df: df.f_R50_away / df.f_I50_home,
                                    f_I50_efficiency_away=lambda df: df.f_R50_home / df.f_I50_away)

feature_efficiency_cols = ['f_I50_efficiency_home', 'f_I50_efficiency_away']

# Now let's create an Expontentially Weighted Moving Average for these features - we will need to reshape our DataFrame to do this
efficiency_features_multi_row = (single_row_df[['game', 'home_team'] + feature_efficiency_cols]
                                    .rename(columns={
                                        'home_team': 'team',
                                        'f_I50_efficiency_home': 'f_I50_efficiency',
                                        'f_I50_efficiency_away': 'f_I50_efficiency_opponent',
                                    })
                                    .append((single_row_df[['game', 'away_team'] + feature_efficiency_cols]
                                                 .rename(columns={
                                                     'away_team': 'team',
                                                     'f_I50_efficiency_home': 'f_I50_efficiency_opponent',
                                                     'f_I50_efficiency_away': 'f_I50_efficiency',
                                                 })), sort=True)
                                    .sort_values(by='game')
                                    .reset_index(drop=True))

efficiency_features = efficiency_features_multi_row[['game', 'team']].copy()
feature_efficiency_cols = ['f_I50_efficiency', 'f_I50_efficiency_opponent']

for feature in feature_efficiency_cols:
    efficiency_features[feature] = (efficiency_features_multi_row.groupby('team')[feature]
                                        .transform(lambda row: row.ewm(span=10).mean().shift(1)))

# Get feature efficiency df back onto single rows
efficiency_features = pd.merge(efficiency_features, afl_data[['game', 'team', 'home_game']], on=['game', 'team'])
efficiency_features_single_row = (efficiency_features.query('home_game == 1')
                                    .rename(columns={
                                        'team': 'home_team', 
                                        'f_I50_efficiency': 'f_I50_efficiency_home',
                                        'f_I50_efficiency_opponent': 'f_R50_efficiency_home'})
                                    .drop(columns='home_game')
                                    .pipe(pd.merge, (efficiency_features.query('home_game == 0')
                                                        .rename(columns={
                                                            'team': 'away_team',
                                                            'f_I50_efficiency': 'f_I50_efficiency_away',
                                                            'f_I50_efficiency_opponent': 'f_R50_efficiency_away'})
                                                        .drop(columns='home_game')), on='game'))
</code></pre>
<pre><code class="language-python">efficiency_features_single_row.tail(5)
</code></pre>
<table>
<thead>
<tr>
<th></th>
<th>game</th>
<th>home_team</th>
<th>f_I50_efficiency_home</th>
<th>f_R50_efficiency_home</th>
<th>away_team</th>
<th>f_I50_efficiency_away</th>
<th>f_R50_efficiency_away</th>
</tr>
</thead>
<tbody>
<tr>
<td>1580</td>
<td>15394</td>
<td>Carlton</td>
<td>0.730668</td>
<td>0.675002</td>
<td>Adelaide</td>
<td>0.691614</td>
<td>0.677128</td>
</tr>
<tr>
<td>1581</td>
<td>15395</td>
<td>Sydney</td>
<td>0.699994</td>
<td>0.778280</td>
<td>Hawthorn</td>
<td>0.699158</td>
<td>0.673409</td>
</tr>
<tr>
<td>1582</td>
<td>15396</td>
<td>Brisbane</td>
<td>0.683604</td>
<td>0.691730</td>
<td>West Coast</td>
<td>0.696822</td>
<td>0.709605</td>
</tr>
<tr>
<td>1583</td>
<td>15397</td>
<td>Melbourne</td>
<td>0.667240</td>
<td>0.692632</td>
<td>GWS</td>
<td>0.684525</td>
<td>0.753783</td>
</tr>
<tr>
<td>1584</td>
<td>15398</td>
<td>St Kilda</td>
<td>0.730843</td>
<td>0.635819</td>
<td>North Melbourne</td>
<td>0.697018</td>
<td>0.654991</td>
</tr>
</tbody>
</table>
<p>We will merge these features back to our features df later, when the features data frame is on a single row as well.</p>
<h3 id="creating-an-elo-feature">Creating an Elo Feature</h3>
<p>Another feature which we could create is an Elo feature. If you don't know what Elo is, go ahead and read our article on it <a href="https://www.betfair.com.au/hub/better-betting/betting-strategies/tennis/tennis-elo-modelling/">here</a>. We have also written a guide on using elo to model the 2018 FIFA World Cup <a href="https://www.betfair.com.au/hub/how-to-use-elo-to-model-the-world-cup/">here</a>.</p>
<p>Essentially, Elo ratings increase if you win. The amount the rating increases is based on how strong the opponent is relative to the team who won. Weak teams get more points for beating stronger teams than they do for beating weaker teams, and vice versa for losses (teams lose points for losses).</p>
<p>Mathematically, Elo ratings can also assign a probability for winning or losing based on the two Elo Ratings of the teams playing.</p>
<p>So let's get into it. We will first define a function which calculates the elo for each team and applies these elos to our DataFrame.</p>
<pre><code class="language-python"># Define a function which finds the elo for each team in each game and returns a dictionary with the game ID as a key and the
# elos as the key's value, in a list. It also outputs the probabilities and a dictionary of the final elos for each team
def elo_applier(df, k_factor):
    # Initialise a dictionary with default elos for each team
    elo_dict = {team: 1500 for team in df['team'].unique()}
    elos, elo_probs = {}, {}

    # Get a home and away dataframe so that we can get the teams on the same row
    home_df = df.loc[df.home_game == 1, ['team', 'game', 'f_margin', 'home_game']].rename(columns={'team': 'home_team'})
    away_df = df.loc[df.home_game == 0, ['team', 'game']].rename(columns={'team': 'away_team'})

    df = (pd.merge(home_df, away_df, on='game')
            .sort_values(by='game')
            .drop_duplicates(subset='game', keep='first')
            .reset_index(drop=True))

    # Loop over the rows in the DataFrame
    for index, row in df.iterrows():
        # Get the Game ID
        game_id = row['game']

        # Get the margin
        margin = row['f_margin']

        # If the game already has the elos for the home and away team in the elos dictionary, go to the next game
        if game_id in elos.keys():
            continue

        # Get the team and opposition
        home_team = row['home_team']
        away_team = row['away_team']

        # Get the team and opposition elo score
        home_team_elo = elo_dict[home_team]
        away_team_elo = elo_dict[away_team]

        # Calculated the probability of winning for the team and opposition
        prob_win_home = 1 / (1 + 10**((away_team_elo - home_team_elo) / 400))
        prob_win_away = 1 - prob_win_home

        # Add the elos and probabilities our elos dictionary and elo_probs dictionary based on the Game ID
        elos[game_id] = [home_team_elo, away_team_elo]
        elo_probs[game_id] = [prob_win_home, prob_win_away]

        # Calculate the new elos of each team
        if margin &gt; 0: # Home team wins; update both teams' elo
            new_home_team_elo = home_team_elo + k_factor*(1 - prob_win_home)
            new_away_team_elo = away_team_elo + k_factor*(0 - prob_win_away)
        elif margin &lt; 0: # Away team wins; update both teams' elo
            new_home_team_elo = home_team_elo + k_factor*(0 - prob_win_home)
            new_away_team_elo = away_team_elo + k_factor*(1 - prob_win_away)
        elif margin == 0: # Drawn game' update both teams' elo
            new_home_team_elo = home_team_elo + k_factor*(0.5 - prob_win_home)
            new_away_team_elo = away_team_elo + k_factor*(0.5 - prob_win_away)

        # Update elos in elo dictionary
        elo_dict[home_team] = new_home_team_elo
        elo_dict[away_team] = new_away_team_elo

    return elos, elo_probs, elo_dict
</code></pre>
<pre><code class="language-python"># Use the elo applier function to get the elos and elo probabilities for each game - we will map these later
elos, probs, elo_dict = elo_applier(afl_data, 30)
</code></pre>
<p>Great! now we have both rolling averages for stats as a feature, and the elo of the teams! Let's have a quick look at the current elo standings with a k-factor of 30, out of curiosity.</p>
<pre><code class="language-python">for team in sorted(elo_dict, key=elo_dict.get)[::-1]:
    print(team, elo_dict[team])

    Richmond 1695.2241513840117
    Sydney 1645.548990879842
    Hawthorn 1632.5266709780622
    West Coast 1625.871701773721
    Geelong 1625.423154644809
    GWS 1597.4158602131877
    Adelaide 1591.1704934545442
    Collingwood 1560.370309216614
    Melbourne 1558.5666572771509
    Essendon 1529.0198398117086
    Port Adelaide 1524.8882517820093
    North Melbourne 1465.5637511922569
    Western Bulldogs 1452.2110697845148
    Fremantle 1393.142087030804
    St Kilda 1360.9120149937303
    Brisbane 1276.2923772139352
    Gold Coast 1239.174528704772
    Carlton 1226.6780896643265
</code></pre>
<p>This looks extremely similar to the currently AFL ladder, so this is a good sign for elo being an effective predictor of winning.</p>
<h3 id="merging-our-features-into-one-features-dataframe">Merging Our Features Into One Features DataFrame</h3>
<p>Now we need to reshape our features df so that we have all of the statistics for both teams in a game on a single row. We can then merge our elo and efficiency features to this df.</p>
<pre><code class="language-python"># Look at our current features df
features.tail(3)
</code></pre>
<table>
<thead>
<tr>
<th></th>
<th>date</th>
<th>game</th>
<th>team</th>
<th>opponent</th>
<th>venue</th>
<th>home_game</th>
<th>f_odds</th>
<th>f_goals</th>
<th>f_behinds</th>
<th>f_points</th>
<th>f_margin</th>
<th>f_opponent_goals</th>
<th>f_opponent_behinds</th>
<th>f_opponent_points</th>
<th>f_AF</th>
<th>f_B</th>
<th>f_BO</th>
<th>f_CCL</th>
<th>f_CG</th>
<th>f_CL</th>
<th>f_CM</th>
<th>f_CP</th>
<th>f_D</th>
<th>f_ED</th>
<th>f_FA</th>
<th>f_FF</th>
<th>f_G</th>
<th>f_GA</th>
<th>f_HB</th>
<th>f_HO</th>
<th>f_I50</th>
<th>f_ITC</th>
<th>f_K</th>
<th>f_M</th>
<th>f_MG</th>
<th>f_MI5</th>
<th>f_One.Percenters</th>
<th>f_R50</th>
<th>f_SC</th>
<th>f_SCL</th>
<th>f_SI</th>
<th>f_T</th>
<th>f_T5</th>
<th>f_TO</th>
<th>f_UP</th>
<th>f_form_margin_btwn_teams</th>
<th>f_form_past_5_btwn_teams</th>
</tr>
</thead>
<tbody>
<tr>
<td>3156</td>
<td>2018-08-26</td>
<td>15397</td>
<td>Melbourne</td>
<td>GWS</td>
<td>M.C.G.</td>
<td>1</td>
<td>1.706488</td>
<td>15.157271</td>
<td>13.815113</td>
<td>104.758740</td>
<td>25.170429</td>
<td>11.814319</td>
<td>8.702396</td>
<td>79.588311</td>
<td>3312.408470</td>
<td>22.077317</td>
<td>7.724955</td>
<td>28.364418</td>
<td>114.399147</td>
<td>78.406069</td>
<td>26.934677</td>
<td>324.352577</td>
<td>775.176933</td>
<td>547.385948</td>
<td>39.353251</td>
<td>36.025646</td>
<td>30.308918</td>
<td>22.461080</td>
<td>348.613592</td>
<td>99.78780</td>
<td>120.339062</td>
<td>154.417642</td>
<td>426.563341</td>
<td>178.102118</td>
<td>12395.717925</td>
<td>32.168752</td>
<td>96.390688</td>
<td>63.786515</td>
<td>3427.596843</td>
<td>50.041649</td>
<td>232.287556</td>
<td>144.875098</td>
<td>23.789233</td>
<td>149.042149</td>
<td>456.988552</td>
<td>-23.2</td>
<td>2.0</td>
</tr>
<tr>
<td>3157</td>
<td>2018-08-26</td>
<td>15398</td>
<td>North Melbourne</td>
<td>St Kilda</td>
<td>Docklands</td>
<td>0</td>
<td>2.272313</td>
<td>12.721783</td>
<td>10.733785</td>
<td>87.064486</td>
<td>-1.214246</td>
<td>12.915796</td>
<td>10.783958</td>
<td>88.278732</td>
<td>3066.272143</td>
<td>17.322710</td>
<td>9.815243</td>
<td>26.015421</td>
<td>106.465181</td>
<td>67.504286</td>
<td>26.064079</td>
<td>291.259574</td>
<td>736.279779</td>
<td>534.154748</td>
<td>34.301603</td>
<td>40.908551</td>
<td>25.386136</td>
<td>17.816570</td>
<td>341.210547</td>
<td>81.54113</td>
<td>102.589427</td>
<td>145.265493</td>
<td>395.069232</td>
<td>173.089408</td>
<td>10875.002463</td>
<td>21.802751</td>
<td>82.347511</td>
<td>70.416194</td>
<td>3171.120023</td>
<td>41.488865</td>
<td>197.620152</td>
<td>122.547684</td>
<td>22.286256</td>
<td>142.780474</td>
<td>450.374058</td>
<td>3.2</td>
<td>3.0</td>
</tr>
<tr>
<td>3158</td>
<td>2018-08-26</td>
<td>15398</td>
<td>St Kilda</td>
<td>North Melbourne</td>
<td>Docklands</td>
<td>1</td>
<td>5.516150</td>
<td>10.464266</td>
<td>11.957047</td>
<td>74.742643</td>
<td>-21.138101</td>
<td>14.105551</td>
<td>11.247440</td>
<td>95.880745</td>
<td>3094.163405</td>
<td>20.523847</td>
<td>14.569589</td>
<td>24.134276</td>
<td>102.540441</td>
<td>66.976211</td>
<td>18.018350</td>
<td>270.674857</td>
<td>773.086015</td>
<td>573.769838</td>
<td>41.319843</td>
<td>36.198820</td>
<td>20.850476</td>
<td>14.443658</td>
<td>364.405251</td>
<td>63.49876</td>
<td>103.803779</td>
<td>130.494307</td>
<td>408.680763</td>
<td>184.780054</td>
<td>10765.717942</td>
<td>21.572806</td>
<td>94.731555</td>
<td>65.790561</td>
<td>3228.278599</td>
<td>42.841935</td>
<td>196.086493</td>
<td>115.901425</td>
<td>18.796764</td>
<td>127.364334</td>
<td>508.844514</td>
<td>-3.2</td>
<td>2.0</td>
</tr>
</tbody>
</table>
<pre><code class="language-python">one_line_cols = ['game', 'team', 'home_game'] + [col for col in features if col.startswith('f_')]

# Get all features onto individual rows for each match
features_one_line = (features.loc[features.home_game == 1, one_line_cols]
                     .rename(columns={'team': 'home_team'})
                     .drop(columns='home_game')
                     .pipe(pd.merge, (features.loc[features.home_game == 0, one_line_cols]
                                              .drop(columns='home_game')
                                              .rename(columns={'team': 'away_team'})
                                              .rename(columns={col: col+'_away' for col in features.columns if col.startswith('f_')})), on='game')
                    .drop(columns=['f_form_margin_btwn_teams_away', 'f_form_past_5_btwn_teams_away']))

# Add our created features - elo, efficiency etc.
features_one_line = (features_one_line.assign(f_elo_home=lambda df: df.game.map(elos).apply(lambda x: x[0]),
                                            f_elo_away=lambda df: df.game.map(elos).apply(lambda x: x[1]))
                                      .pipe(pd.merge, efficiency_features_single_row, on=['game', 'home_team', 'away_team'])
                                      .pipe(pd.merge, afl_data.loc[afl_data.home_game == 1, ['game', 'date', 'round', 'venue']], on=['game'])
                                      .dropna()
                                      .reset_index(drop=True)
                                      .assign(season=lambda df: df.date.apply(lambda row: row.year)))

ordered_cols = [col for col in features_one_line if col[:2] != 'f_'] + [col for col in features_one_line if col.startswith('f_')]

feature_df = features_one_line[ordered_cols]
</code></pre>
<p>Finally, let's reduce the dimensionality of the features df by subtracting the home features from the away features. This will reduce the huge amount of columns we have and make our data more manageable. To do this, we will need a list of columns which we are subtracting from each other. We will then loop over each of these columns to create our new differential columns. </p>
<p>We will then add in the implied probability from the odds of the home and away team, as our current odds feature is simply an exponential moving average over the past n games.</p>
<pre><code class="language-python"># Create differential df - this df is the home features - the away features
diff_cols = [col for col in feature_df.columns if col + '_away' in feature_df.columns and col != 'f_odds' and col.startswith('f_')]
non_diff_cols = [col for col in feature_df.columns if col not in diff_cols and col[:-5] not in diff_cols]

diff_df = feature_df[non_diff_cols].copy()

for col in diff_cols:
    diff_df[col+'_diff'] = feature_df[col] - feature_df[col+'_away']

# Add current odds in to diff_df
odds = get_cleaned_odds()
home_odds = (odds[odds.home_game == 1]
             .assign(f_current_odds_prob=lambda df: 1 / df.odds)
             .rename(columns={'team': 'home_team'})
             .drop(columns=['home_game', 'odds']))

away_odds = (odds[odds.home_game == 0]
             .assign(f_current_odds_prob_away=lambda df: 1 / df.odds)
             .rename(columns={'team': 'away_team'})
             .drop(columns=['home_game', 'odds']))

diff_df = (diff_df.pipe(pd.merge, home_odds, on=['date', 'home_team'])
              .pipe(pd.merge, away_odds, on=['date', 'away_team']))
</code></pre>
<pre><code class="language-python">diff_df.tail()
</code></pre>
<table>
<thead>
<tr>
<th></th>
<th>game</th>
<th>home_team</th>
<th>away_team</th>
<th>date</th>
<th>round</th>
<th>venue</th>
<th>season</th>
<th>f_odds</th>
<th>f_form_margin_btwn_teams</th>
<th>f_form_past_5_btwn_teams</th>
<th>f_odds_away</th>
<th>f_elo_home</th>
<th>f_elo_away</th>
<th>f_I50_efficiency_home</th>
<th>f_R50_efficiency_home</th>
<th>f_I50_efficiency_away</th>
<th>f_R50_efficiency_away</th>
<th>f_goals_diff</th>
<th>f_behinds_diff</th>
<th>f_points_diff</th>
<th>f_margin_diff</th>
<th>f_opponent_goals_diff</th>
<th>f_opponent_behinds_diff</th>
<th>f_opponent_points_diff</th>
<th>f_AF_diff</th>
<th>f_B_diff</th>
<th>f_BO_diff</th>
<th>f_CCL_diff</th>
<th>f_CG_diff</th>
<th>f_CL_diff</th>
<th>f_CM_diff</th>
<th>f_CP_diff</th>
<th>f_D_diff</th>
<th>f_ED_diff</th>
<th>f_FA_diff</th>
<th>f_FF_diff</th>
<th>f_G_diff</th>
<th>f_GA_diff</th>
<th>f_HB_diff</th>
<th>f_HO_diff</th>
<th>f_I50_diff</th>
<th>f_ITC_diff</th>
<th>f_K_diff</th>
<th>f_M_diff</th>
<th>f_MG_diff</th>
<th>f_MI5_diff</th>
<th>f_One.Percenters_diff</th>
<th>f_R50_diff</th>
<th>f_SC_diff</th>
<th>f_SCL_diff</th>
<th>f_SI_diff</th>
<th>f_T_diff</th>
<th>f_T5_diff</th>
<th>f_TO_diff</th>
<th>f_UP_diff</th>
<th>f_current_odds_prob</th>
<th>f_current_odds_prob_away</th>
</tr>
</thead>
<tbody>
<tr>
<td>1626</td>
<td>15394</td>
<td>Carlton</td>
<td>Adelaide</td>
<td>2018-08-25</td>
<td>23</td>
<td>Docklands</td>
<td>2018</td>
<td>6.467328</td>
<td>-26.2</td>
<td>1.0</td>
<td>2.066016</td>
<td>1230.072138</td>
<td>1587.776445</td>
<td>0.730668</td>
<td>0.675002</td>
<td>0.691614</td>
<td>0.677128</td>
<td>-3.498547</td>
<td>-5.527193</td>
<td>-26.518474</td>
<td>-34.473769</td>
<td>1.289715</td>
<td>0.217006</td>
<td>7.955295</td>
<td>-341.342677</td>
<td>-9.317269</td>
<td>3.088569</td>
<td>-2.600593</td>
<td>15.192839</td>
<td>-12.518345</td>
<td>-4.136673</td>
<td>-41.855717</td>
<td>-72.258378</td>
<td>-51.998775</td>
<td>9.499447</td>
<td>8.670917</td>
<td>-6.973088</td>
<td>-4.740623</td>
<td>-26.964945</td>
<td>-13.147675</td>
<td>-23.928700</td>
<td>-28.940883</td>
<td>-45.293433</td>
<td>-15.183406</td>
<td>-1900.784014</td>
<td>-0.362402</td>
<td>-1.314627</td>
<td>4.116133</td>
<td>-294.813511</td>
<td>-9.917793</td>
<td>-34.724925</td>
<td>-5.462844</td>
<td>-9.367141</td>
<td>-19.623785</td>
<td>-38.188082</td>
<td>0.187709</td>
<td>0.816860</td>
</tr>
<tr>
<td>1627</td>
<td>15395</td>
<td>Sydney</td>
<td>Hawthorn</td>
<td>2018-08-25</td>
<td>23</td>
<td>S.C.G.</td>
<td>2018</td>
<td>2.128611</td>
<td>1.0</td>
<td>2.0</td>
<td>1.777290</td>
<td>1662.568452</td>
<td>1615.507209</td>
<td>0.699994</td>
<td>0.778280</td>
<td>0.699158</td>
<td>0.673409</td>
<td>-1.756730</td>
<td>-0.874690</td>
<td>-11.415069</td>
<td>-15.575319</td>
<td>0.014390</td>
<td>4.073909</td>
<td>4.160250</td>
<td>-174.005092</td>
<td>-0.942357</td>
<td>-4.078635</td>
<td>-4.192916</td>
<td>7.814496</td>
<td>-2.225780</td>
<td>6.215760</td>
<td>15.042979</td>
<td>-34.894261</td>
<td>-50.615255</td>
<td>4.214158</td>
<td>0.683548</td>
<td>-3.535594</td>
<td>-3.168608</td>
<td>-12.068691</td>
<td>-30.493980</td>
<td>-9.867332</td>
<td>2.588103</td>
<td>-22.825570</td>
<td>-5.604199</td>
<td>253.086090</td>
<td>-2.697132</td>
<td>-22.612327</td>
<td>25.340623</td>
<td>-90.812188</td>
<td>1.967104</td>
<td>-31.047879</td>
<td>0.007606</td>
<td>-6.880120</td>
<td>11.415593</td>
<td>-49.957313</td>
<td>0.440180</td>
<td>0.561924</td>
</tr>
<tr>
<td>1628</td>
<td>15396</td>
<td>Brisbane</td>
<td>West Coast</td>
<td>2018-08-26</td>
<td>23</td>
<td>Gabba</td>
<td>2018</td>
<td>3.442757</td>
<td>-49.2</td>
<td>0.0</td>
<td>2.094236</td>
<td>1279.963814</td>
<td>1622.200265</td>
<td>0.683604</td>
<td>0.691730</td>
<td>0.696822</td>
<td>0.709605</td>
<td>-0.190413</td>
<td>1.182699</td>
<td>0.040221</td>
<td>-13.621456</td>
<td>1.772577</td>
<td>3.026217</td>
<td>13.661677</td>
<td>-22.709485</td>
<td>2.424261</td>
<td>-4.848054</td>
<td>1.800473</td>
<td>5.051157</td>
<td>6.440524</td>
<td>-5.549630</td>
<td>-17.041838</td>
<td>27.543023</td>
<td>33.983159</td>
<td>4.459181</td>
<td>-3.213885</td>
<td>-0.428455</td>
<td>1.514474</td>
<td>42.646138</td>
<td>-7.141638</td>
<td>1.457375</td>
<td>-17.472537</td>
<td>-15.103115</td>
<td>8.001966</td>
<td>-383.083539</td>
<td>6.458915</td>
<td>7.275716</td>
<td>0.942863</td>
<td>44.461590</td>
<td>4.640136</td>
<td>13.180967</td>
<td>-15.704694</td>
<td>2.366444</td>
<td>-5.985843</td>
<td>38.195255</td>
<td>0.433501</td>
<td>0.569866</td>
</tr>
<tr>
<td>1629</td>
<td>15397</td>
<td>Melbourne</td>
<td>GWS</td>
<td>2018-08-26</td>
<td>23</td>
<td>M.C.G.</td>
<td>2018</td>
<td>1.706488</td>
<td>-23.2</td>
<td>2.0</td>
<td>1.805565</td>
<td>1540.367850</td>
<td>1615.614668</td>
<td>0.667240</td>
<td>0.692632</td>
<td>0.684525</td>
<td>0.753783</td>
<td>2.056899</td>
<td>0.635785</td>
<td>12.977177</td>
<td>6.642811</td>
<td>1.443121</td>
<td>-2.324358</td>
<td>6.334366</td>
<td>147.281112</td>
<td>2.201404</td>
<td>-5.222254</td>
<td>3.250416</td>
<td>8.542475</td>
<td>-2.203571</td>
<td>3.559792</td>
<td>21.192530</td>
<td>33.737734</td>
<td>12.865653</td>
<td>-3.244066</td>
<td>-2.135243</td>
<td>4.100203</td>
<td>3.772200</td>
<td>48.425291</td>
<td>18.247107</td>
<td>13.349992</td>
<td>11.385136</td>
<td>-14.687556</td>
<td>5.052000</td>
<td>304.087088</td>
<td>11.062610</td>
<td>-6.686409</td>
<td>-16.414544</td>
<td>8.350924</td>
<td>-5.453961</td>
<td>12.407662</td>
<td>6.672628</td>
<td>-1.523915</td>
<td>13.075351</td>
<td>18.522113</td>
<td>0.661551</td>
<td>0.340379</td>
</tr>
<tr>
<td>1630</td>
<td>15398</td>
<td>St Kilda</td>
<td>North Melbourne</td>
<td>2018-08-26</td>
<td>23</td>
<td>Docklands</td>
<td>2018</td>
<td>5.516150</td>
<td>-3.2</td>
<td>2.0</td>
<td>2.272313</td>
<td>1372.453734</td>
<td>1454.022032</td>
<td>0.730843</td>
<td>0.635819</td>
<td>0.697018</td>
<td>0.654991</td>
<td>-2.257517</td>
<td>1.223261</td>
<td>-12.321842</td>
<td>-19.923855</td>
<td>1.189755</td>
<td>0.463481</td>
<td>7.602012</td>
<td>27.891262</td>
<td>3.201137</td>
<td>4.754346</td>
<td>-1.881145</td>
<td>-3.924740</td>
<td>-0.528075</td>
<td>-8.045729</td>
<td>-20.584717</td>
<td>36.806235</td>
<td>39.615090</td>
<td>7.018240</td>
<td>-4.709732</td>
<td>-4.535660</td>
<td>-3.372912</td>
<td>23.194704</td>
<td>-18.042370</td>
<td>1.214353</td>
<td>-14.771187</td>
<td>13.611531</td>
<td>11.690647</td>
<td>-109.284521</td>
<td>-0.229945</td>
<td>12.384044</td>
<td>-4.625633</td>
<td>57.158576</td>
<td>1.353070</td>
<td>-1.533659</td>
<td>-6.646259</td>
<td>-3.489492</td>
<td>-15.416140</td>
<td>58.470456</td>
<td>0.284269</td>
<td>0.717566</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="wrapping-it-up">Wrapping it Up</h2>
<p>We now have a fairly decent amount of features. Some other features which could be added include whether the game is in a major Capital city outisde of Mebourne (i.e. Sydney, Adelaide or Peth), how many 'Elite' players are playing (which could be judged by average SuperCoach scores over 110, for example), as well as your own metrics for attacking and defending.</p>
<p>Note that all of our features have columns starting with 'f_' so in the section, we will grab this feature dataframe and use these features to sport predicting the matches.</p>
<hr />
<h1 id="03-modelling">03. Modelling</h1>
<p>These tutorials will walk you through how to construct your own basic AFL model, using publically available data. The output will be odds for each team to win, which will be shown on <a href="https://www.betfair.com.au/hub/tools/models/afl-prediction-model/">The Hub</a>.</p>
<p>In this notebook we will walk you through modelling our AFL data to create predictions. We will train a variety of quick and easy models to get a feel of what works and what doesn't. We will then tune our hyperparameters so that we are ready to make week by week predictions.</p>
<hr />
<h2 id="grabbing-our-dataset_1">Grabbing Our Dataset</h2>
<p>First, we will import our required modules, as well as the prepare_afl_features function which we created in our afl_feature_creation script. This essentially creates some basic features for us so that we can get started on the modelling component.</p>
<pre><code class="language-python"># Import libraries
from afl_data_cleaning_v2 import *
import datetime
import pandas as pd
import numpy as np
from sklearn import svm, tree, linear_model, neighbors, naive_bayes, ensemble, discriminant_analysis, gaussian_process
# from xgboost import XGBClassifier
from sklearn.model_selection import StratifiedKFold, cross_val_score, GridSearchCV, train_test_split
from sklearn.linear_model import LogisticRegressionCV
from sklearn.feature_selection import RFECV
import seaborn as sns
from sklearn.preprocessing import OneHotEncoder, LabelEncoder, StandardScaler
from sklearn import feature_selection
from sklearn import metrics
from sklearn.linear_model import LogisticRegression, RidgeClassifier
from sklearn.ensemble import RandomForestClassifier
from sklearn.discriminant_analysis import LinearDiscriminantAnalysis
from sklearn.naive_bayes import GaussianNB
import warnings
warnings.filterwarnings('ignore')
import afl_feature_creation_v2
import afl_data_cleaning_v2
</code></pre>
<pre><code class="language-python"># Grab our feature DataFrame which we created in the previous tutorial
feature_df = afl_feature_creation_v2.prepare_afl_features()
afl_data = afl_data_cleaning_v2.prepare_afl_data()
</code></pre>
<pre><code class="language-python">feature_df.tail(3)
</code></pre>
<table>
<thead>
<tr>
<th></th>
<th>game</th>
<th>home_team</th>
<th>away_team</th>
<th>date</th>
<th>round</th>
<th>venue</th>
<th>season</th>
<th>f_odds</th>
<th>f_form_margin_btwn_teams</th>
<th>f_form_past_5_btwn_teams</th>
<th>f_odds_away</th>
<th>f_elo_home</th>
<th>f_elo_away</th>
<th>f_I50_efficiency_home</th>
<th>f_R50_efficiency_home</th>
<th>f_I50_efficiency_away</th>
<th>f_R50_efficiency_away</th>
<th>f_goals_diff</th>
<th>f_behinds_diff</th>
<th>f_points_diff</th>
<th>f_margin_diff</th>
<th>f_opponent_goals_diff</th>
<th>f_opponent_behinds_diff</th>
<th>f_opponent_points_diff</th>
<th>f_AF_diff</th>
<th>f_B_diff</th>
<th>f_BO_diff</th>
<th>f_CCL_diff</th>
<th>f_CG_diff</th>
<th>f_CL_diff</th>
<th>f_CM_diff</th>
<th>f_CP_diff</th>
<th>f_D_diff</th>
<th>f_ED_diff</th>
<th>f_FA_diff</th>
<th>f_FF_diff</th>
<th>f_G_diff</th>
<th>f_GA_diff</th>
<th>f_HB_diff</th>
<th>f_HO_diff</th>
<th>f_I50_diff</th>
<th>f_ITC_diff</th>
<th>f_K_diff</th>
<th>f_M_diff</th>
<th>f_MG_diff</th>
<th>f_MI5_diff</th>
<th>f_One.Percenters_diff</th>
<th>f_R50_diff</th>
<th>f_SC_diff</th>
<th>f_SCL_diff</th>
<th>f_SI_diff</th>
<th>f_T_diff</th>
<th>f_T5_diff</th>
<th>f_TO_diff</th>
<th>f_UP_diff</th>
<th>f_current_odds_prob</th>
<th>f_current_odds_prob_away</th>
</tr>
</thead>
<tbody>
<tr>
<td>1628</td>
<td>15396</td>
<td>Brisbane</td>
<td>West Coast</td>
<td>2018-08-26</td>
<td>23</td>
<td>Gabba</td>
<td>2018</td>
<td>3.442757</td>
<td>-49.2</td>
<td>0.0</td>
<td>2.094236</td>
<td>1279.963814</td>
<td>1622.200265</td>
<td>0.683604</td>
<td>0.691730</td>
<td>0.696822</td>
<td>0.709605</td>
<td>-0.190413</td>
<td>1.182699</td>
<td>0.040221</td>
<td>-13.621456</td>
<td>1.772577</td>
<td>3.026217</td>
<td>13.661677</td>
<td>-22.709485</td>
<td>2.424261</td>
<td>-4.848054</td>
<td>1.800473</td>
<td>5.051157</td>
<td>6.440524</td>
<td>-5.549630</td>
<td>-17.041838</td>
<td>27.543023</td>
<td>33.983159</td>
<td>4.459181</td>
<td>-3.213885</td>
<td>-0.428455</td>
<td>1.514474</td>
<td>42.646138</td>
<td>-7.141638</td>
<td>1.457375</td>
<td>-17.472537</td>
<td>-15.103115</td>
<td>8.001966</td>
<td>-383.083539</td>
<td>6.458915</td>
<td>7.275716</td>
<td>0.942863</td>
<td>44.461590</td>
<td>4.640136</td>
<td>13.180967</td>
<td>-15.704694</td>
<td>2.366444</td>
<td>-5.985843</td>
<td>38.195255</td>
<td>0.433501</td>
<td>0.569866</td>
</tr>
<tr>
<td>1629</td>
<td>15397</td>
<td>Melbourne</td>
<td>GWS</td>
<td>2018-08-26</td>
<td>23</td>
<td>M.C.G.</td>
<td>2018</td>
<td>1.706488</td>
<td>-23.2</td>
<td>2.0</td>
<td>1.805565</td>
<td>1540.367850</td>
<td>1615.614668</td>
<td>0.667240</td>
<td>0.692632</td>
<td>0.684525</td>
<td>0.753783</td>
<td>2.056899</td>
<td>0.635785</td>
<td>12.977177</td>
<td>6.642811</td>
<td>1.443121</td>
<td>-2.324358</td>
<td>6.334366</td>
<td>147.281112</td>
<td>2.201404</td>
<td>-5.222254</td>
<td>3.250416</td>
<td>8.542475</td>
<td>-2.203571</td>
<td>3.559792</td>
<td>21.192530</td>
<td>33.737734</td>
<td>12.865653</td>
<td>-3.244066</td>
<td>-2.135243</td>
<td>4.100203</td>
<td>3.772200</td>
<td>48.425291</td>
<td>18.247107</td>
<td>13.349992</td>
<td>11.385136</td>
<td>-14.687556</td>
<td>5.052000</td>
<td>304.087088</td>
<td>11.062610</td>
<td>-6.686409</td>
<td>-16.414544</td>
<td>8.350924</td>
<td>-5.453961</td>
<td>12.407662</td>
<td>6.672628</td>
<td>-1.523915</td>
<td>13.075351</td>
<td>18.522113</td>
<td>0.661551</td>
<td>0.340379</td>
</tr>
<tr>
<td>1630</td>
<td>15398</td>
<td>St Kilda</td>
<td>North Melbourne</td>
<td>2018-08-26</td>
<td>23</td>
<td>Docklands</td>
<td>2018</td>
<td>5.516150</td>
<td>-3.2</td>
<td>2.0</td>
<td>2.272313</td>
<td>1372.453734</td>
<td>1454.022032</td>
<td>0.730843</td>
<td>0.635819</td>
<td>0.697018</td>
<td>0.654991</td>
<td>-2.257517</td>
<td>1.223261</td>
<td>-12.321842</td>
<td>-19.923855</td>
<td>1.189755</td>
<td>0.463481</td>
<td>7.602012</td>
<td>27.891262</td>
<td>3.201137</td>
<td>4.754346</td>
<td>-1.881145</td>
<td>-3.924740</td>
<td>-0.528075</td>
<td>-8.045729</td>
<td>-20.584717</td>
<td>36.806235</td>
<td>39.615090</td>
<td>7.018240</td>
<td>-4.709732</td>
<td>-4.535660</td>
<td>-3.372912</td>
<td>23.194704</td>
<td>-18.042370</td>
<td>1.214353</td>
<td>-14.771187</td>
<td>13.611531</td>
<td>11.690647</td>
<td>-109.284521</td>
<td>-0.229945</td>
<td>12.384044</td>
<td>-4.625633</td>
<td>57.158576</td>
<td>1.353070</td>
<td>-1.533659</td>
<td>-6.646259</td>
<td>-3.489492</td>
<td>-15.416140</td>
<td>58.470456</td>
<td>0.284269</td>
<td>0.717566</td>
</tr>
</tbody>
</table>
<pre><code class="language-python"># Get the result and merge to the feature_df

match_results = (pd.read_csv(&quot;data/afl_match_results.csv&quot;)
                    .rename(columns={'Game': 'game'})
                    .assign(result=lambda df: df.apply(lambda row: 1 if row['Home.Points'] &gt; row['Away.Points'] else 0, axis=1)))

# Merge result column to feature_df
feature_df = pd.merge(feature_df, match_results[['game', 'result']], on='game')
</code></pre>
<hr />
<h2 id="creating-a-training-and-testing-set">Creating a Training and Testing Set</h2>
<p>So that we don't train our data on the data that we will later test our model on, we will create separate train and test sets. For this exercise we will use the 2018 season to test how our model performs, whilst the rest of the data can be used to train the model.</p>
<pre><code class="language-python"># Create our test and train sets from our afl DataFrame; drop the columns which leak the result, duplicates, and the advanced
# stats which don't have data until 2015

feature_columns = [col for col in feature_df if col.startswith('f_')]

# Create our test set
test_x = feature_df.loc[feature_df.season == 2018, ['game'] + feature_columns]
test_y = feature_df.loc[feature_df.season == 2018, 'result']

# Create our train set
X = feature_df.loc[feature_df.season != 2018, ['game'] + feature_columns]
y = feature_df.loc[feature_df.season != 2018, 'result']

# Scale features
scaler = StandardScaler()
X[feature_columns] = scaler.fit_transform(X[feature_columns])
test_x[feature_columns] = scaler.transform(test_x[feature_columns])
</code></pre>
<hr />
<h2 id="using-cross-validation-to-find-the-best-algorithms">Using Cross Validation to Find The Best Algorithms</h2>
<p>Now that we have our training set, we can run through a list of popular classifiers to determine which classifier is best for modelling our data. To do this we will create a function which uses Kfold cross-validation to find the 'best' algorithms, based on how accurate the algorithms' predictions are.</p>
<p>This function will take in a list of classifiers, which we will define below, as well as the training set and it's outcome, and output a DataFrame with the mean and std of the accuracy of each algorithm. Let's jump into it!</p>
<pre><code class="language-python"># Create a list of standard classifiers
classifiers = [
    #Ensemble Methods
    ensemble.AdaBoostClassifier(),
    ensemble.BaggingClassifier(),
    ensemble.ExtraTreesClassifier(),
    ensemble.GradientBoostingClassifier(),
    ensemble.RandomForestClassifier(),

    #Gaussian Processes
    gaussian_process.GaussianProcessClassifier(),

    #GLM
    linear_model.LogisticRegressionCV(),

    #Navies Bayes
    naive_bayes.BernoulliNB(),
    naive_bayes.GaussianNB(),

    #SVM
    svm.SVC(probability=True),
    svm.NuSVC(probability=True),

    #Discriminant Analysis
    discriminant_analysis.LinearDiscriminantAnalysis(),
    discriminant_analysis.QuadraticDiscriminantAnalysis(),

    #xgboost: http://xgboost.readthedocs.io/en/latest/model.html
#     XGBClassifier()    
]

# Define a functiom which finds the best algorithms for our modelling task
def find_best_algorithms(classifier_list, X, y):
    # This function is adapted from https://www.kaggle.com/yassineghouzam/titanic-top-4-with-ensemble-modeling
    # Cross validate model with Kfold stratified cross validation
    kfold = StratifiedKFold(n_splits=5)

    # Grab the cross validation scores for each algorithm
    cv_results = [cross_val_score(classifier, X, y, scoring = &quot;neg_log_loss&quot;, cv = kfold) for classifier in classifier_list]
    cv_means = [cv_result.mean() * -1 for cv_result in cv_results]
    cv_std = [cv_result.std() for cv_result in cv_results]
    algorithm_names = [alg.__class__.__name__ for alg in classifiers]

    # Create a DataFrame of all the CV results
    cv_results = pd.DataFrame({
        &quot;Mean Log Loss&quot;: cv_means,
        &quot;Log Loss Std&quot;: cv_std,
        &quot;Algorithm&quot;: algorithm_names
    })

    return cv_results.sort_values(by='Mean Log Loss').reset_index(drop=True)
</code></pre>
<pre><code class="language-python">best_algos = find_best_algorithms(classifiers, X, y)
best_algos
</code></pre>
<table>
<thead>
<tr>
<th></th>
<th>Mean Log Loss</th>
<th>Log Loss Std</th>
<th>Algorithm</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>0.539131</td>
<td>3.640578e-02</td>
<td>LogisticRegressionCV</td>
</tr>
<tr>
<td>1</td>
<td>0.551241</td>
<td>5.775685e-02</td>
<td>LinearDiscriminantAnalysis</td>
</tr>
<tr>
<td>2</td>
<td>0.630994</td>
<td>8.257481e-02</td>
<td>GradientBoostingClassifier</td>
</tr>
<tr>
<td>3</td>
<td>0.670041</td>
<td>9.205780e-03</td>
<td>AdaBoostClassifier</td>
</tr>
<tr>
<td>4</td>
<td>0.693147</td>
<td>2.360121e-08</td>
<td>GaussianProcessClassifier</td>
</tr>
<tr>
<td>5</td>
<td>0.712537</td>
<td>2.770864e-02</td>
<td>SVC</td>
</tr>
<tr>
<td>6</td>
<td>0.712896</td>
<td>2.440755e-02</td>
<td>NuSVC</td>
</tr>
<tr>
<td>7</td>
<td>0.836191</td>
<td>2.094224e-01</td>
<td>ExtraTreesClassifier</td>
</tr>
<tr>
<td>8</td>
<td>0.874307</td>
<td>1.558144e-01</td>
<td>RandomForestClassifier</td>
</tr>
<tr>
<td>9</td>
<td>1.288174</td>
<td>3.953037e-01</td>
<td>BaggingClassifier</td>
</tr>
<tr>
<td>10</td>
<td>1.884019</td>
<td>4.769589e-01</td>
<td>QuadraticDiscriminantAnalysis</td>
</tr>
<tr>
<td>11</td>
<td>2.652161</td>
<td>6.886897e-01</td>
<td>BernoulliNB</td>
</tr>
<tr>
<td>12</td>
<td>3.299651</td>
<td>6.427551e-01</td>
<td>GaussianNB</td>
</tr>
</tbody>
</table>
<pre><code class="language-python"># Try a logistic regression model and see how it performs in terms of accuracy
kfold = StratifiedKFold(n_splits=5)
cv_scores = cross_val_score(linear_model.LogisticRegressionCV(), X, y, scoring='accuracy', cv=kfold)
cv_scores.mean()
    0.7452268937025035
</code></pre>
<h3 id="choosing-our-algorithms">Choosing Our Algorithms</h3>
<p>As we can see from above, there are some pretty poor algorithms for predicting the winner. On the other hand, whilst attaining an accuracy of 74.5% (at the time of writing) may seem like a decent result; we must first establish a baseline to judge our performance on. In this case, we will have two baselines; the proportion of games won by the home team and what the odds predict. If we can beat the odds we have created a very powerful model.</p>
<p>Note that a baseline for the log loss can also be both the odds log loss and randomly guessing. Randomly guessing between two teams attains a log loss of log(2) = 0.69, so we have beaten this result.</p>
<p>Once we establish our baseline, we will choose the top algorithms from above and tune their hyperparameters, as well as automatically selecting the best features to be used in our model.</p>
<hr />
<h2 id="defining-our-baseline">Defining Our Baseline</h2>
<p>As stated above, we must define our baseline so that we have a measure to beat. We will use the proportion of games won by the home team, as well as the proportion of favourites who won, based off the odds. To establish this baseline we will use our feature_df, as this has no dropped rows.</p>
<pre><code class="language-python"># Find the percentage chance of winning at home in each season.
afl_data = afl_data_cleaning_v2.prepare_afl_data()
afl_data['home_win'] = afl_data.apply(lambda x: 1 if x['f_margin'] &gt; 0 else 0, axis=1)
home_games = afl_data[afl_data['home_game'] == 1]
home_games[[&quot;home_win&quot;, 'season']].groupby(['season']).mean()
</code></pre>
<table>
<thead>
<tr>
<th>season</th>
<th>home_win</th>
</tr>
</thead>
<tbody>
<tr>
<td>2011</td>
<td>0.561856</td>
</tr>
<tr>
<td>2012</td>
<td>0.563725</td>
</tr>
<tr>
<td>2013</td>
<td>0.561576</td>
</tr>
<tr>
<td>2014</td>
<td>0.574257</td>
</tr>
<tr>
<td>2015</td>
<td>0.539604</td>
</tr>
<tr>
<td>2016</td>
<td>0.606742</td>
</tr>
<tr>
<td>2017</td>
<td>0.604061</td>
</tr>
<tr>
<td>2018</td>
<td>0.540404</td>
</tr>
</tbody>
</table>
<pre><code class="language-python"># Find the proportion of favourites who have won

# Define a function which finds if the odds correctly guessed the response
def find_odds_prediction(a_row):
    if a_row['f_odds'] &lt;= a_row['f_odds_away'] and a_row['home_win'] == 1:
        return 1
    elif a_row['f_odds_away'] &lt; a_row['f_odds'] and a_row['home_win'] == 0:
        return 1
    else:
        return 0

# Define a function which splits our DataFrame so each game is on one row instead of two
def get_df_on_one_line(df):
    cols_to_drop = ['date', 'home_game', 'opponent', 
       'f_opponent_behinds', 'f_opponent_goals', 'f_opponent_points', 'f_points',
       'round', 'venue', 'season']

    home_df = df[df['home_game'] == 1].rename(columns={'team': 'home_team'})
    away_df = df[df['home_game'] == 0].rename(columns={'team': 'away_team'})
    away_df = away_df.drop(columns=cols_to_drop)

    # Rename away_df columns
    away_df_renamed = away_df.rename(columns={col: col + '_away' for col in away_df.columns if col != 'game'})
    merged_df = pd.merge(home_df, away_df_renamed, on='game')

    merged_df['home_win'] = merged_df.f_margin.apply(lambda x: 1 if x &gt; 0 else 0)
    return merged_df

afl_data_one_line = get_df_on_one_line(afl_data)
afl_data_one_line['odds_prediction'] = afl_data_one_line.apply(find_odds_prediction, axis=1)
print('The overall mean accuracy of choosing the favourite based on the odds is {}%'.format(
    round(afl_data_one_line['odds_prediction'].mean() * 100, 2)))
afl_data_one_line[[&quot;odds_prediction&quot;, 'season']].groupby(['season']).mean()
</code></pre>
<pre><code>The overall mean accuracy of choosing the favourite based on the odds is 73.15%
</code></pre>
<table>
<thead>
<tr>
<th>season</th>
<th>odds_prediction</th>
</tr>
</thead>
<tbody>
<tr>
<td>2011</td>
<td>0.784615</td>
</tr>
<tr>
<td>2012</td>
<td>0.774510</td>
</tr>
<tr>
<td>2013</td>
<td>0.748768</td>
</tr>
<tr>
<td>2014</td>
<td>0.727723</td>
</tr>
<tr>
<td>2015</td>
<td>0.727723</td>
</tr>
<tr>
<td>2016</td>
<td>0.713483</td>
</tr>
<tr>
<td>2017</td>
<td>0.659898</td>
</tr>
<tr>
<td>2018</td>
<td>0.712121</td>
</tr>
</tbody>
</table>
<pre><code class="language-python">## Get a baseline log loss score from the odds
afl_data_one_line['odds_home_prob'] = 1 / afl_data_one_line.f_odds
afl_data_one_line['odds_away_prob'] = 1 / afl_data_one_line.f_odds_away
</code></pre>
<pre><code class="language-python">metrics.log_loss(afl_data_one_line.home_win, afl_data_one_line[['odds_away_prob', 'odds_home_prob']])
    0.5375306549682837
</code></pre>
<p>We can see that the odds are MUCH more accurate than just choosing the home team to win. We can also see that the mean accuracy of choosing the favourite is around 73%. That means that this is the score we need to beat. Similarly, the log loss of the odds is around 0.5385, whilst our model scores around 0.539 (at the time of writing), without hyperparamter optimisation. Let's choose only the algorithms with log losses below 0.67</p>
<pre><code class="language-python">chosen_algorithms = best_algos.loc[best_algos['Mean Log Loss'] &lt; 0.67, 'Algorithm'].tolist()
chosen_algorithms
    ['LogisticRegressionCV',
     'LinearDiscriminantAnalysis',
     'GradientBoostingClassifier']
</code></pre>
<hr />
<h2 id="using-grid-search-to-tune-hyperparameters">Using Grid Search To Tune Hyperparameters</h2>
<p>Now that we have our best models, we can use <a href="https://en.wikipedia.org/wiki/Hyperparameter_optimization#Grid_search">Grid Search</a> to optimise our hyperparameters. Grid search basically involves searching through a range of different algorithm hyperparameters, and choosing those which result in the best score from some metrics, which in our case is accuracy. Let's do this for the algorithms which have hyperparameters which can be tuned. Note that if you are running this on your own computer it may take up to 10 minutes.</p>
<pre><code class="language-python"># Define a function which optimises the hyperparameters of our chosen algorithms
def optimise_hyperparameters(train_x, train_y, algorithms, parameters):
    kfold = StratifiedKFold(n_splits=5)
    best_estimators = []

    for alg, params in zip(algorithms, parameters):
        gs = GridSearchCV(alg, param_grid=params, cv=kfold, scoring='neg_log_loss', verbose=1)
        gs.fit(train_x, train_y)
        best_estimators.append(gs.best_estimator_)
    return best_estimators

# Define our parameters to run a grid search over
lr_grid = {
    &quot;C&quot;: [0.0001, 0.001, 0.01, 0.05, 0.2, 0.5],
    &quot;solver&quot;: [&quot;newton-cg&quot;, &quot;lbfgs&quot;, &quot;liblinear&quot;]
}

# Add our algorithms and parameters to lists to be used in our function
alg_list = [LogisticRegression()]
param_list = [lr_grid]
</code></pre>
<pre><code class="language-python"># Find the best estimators, then add our other estimators which don't need optimisation
best_estimators = optimise_hyperparameters(X, y, alg_list, param_list)
</code></pre>
<pre><code>Fitting 5 folds for each of 18 candidates, totalling 90 fits

[Parallel(n_jobs=1)]: Done  90 out of  90 | elapsed:    5.2s finished
</code></pre>
<pre><code class="language-python">lr_best_params = best_estimators[0].get_params()
lr_best_params
    {'C': 0.01,
     'class_weight': None,
     'dual': False,
     'fit_intercept': True,
     'intercept_scaling': 1,
     'max_iter': 100,
     'multi_class': 'ovr',
     'n_jobs': 1,
     'penalty': 'l2',
     'random_state': None,
     'solver': 'newton-cg',
     'tol': 0.0001,
     'verbose': 0,
     'warm_start': False}
</code></pre>
<pre><code class="language-python">kfold = StratifiedKFold(n_splits=10)
cv_scores = cross_val_score(linear_model.LogisticRegression(**lr_best_params), X, y, scoring='neg_log_loss', cv=kfold)
cv_scores.mean()
    -0.528741673153639
</code></pre>
<p>In the next iteration of this tutorial we will also optimise an XGB model and hopefully outperform our logistic regression model.</p>
<hr />
<h2 id="creating-predictions-for-the-2018-season">Creating Predictions for the 2018 Season</h2>
<p>Now that we have an optimised logistic regression model, let's see how it performs on predicting the 2018 season.</p>
<pre><code class="language-python">lr = LogisticRegression(**lr_best_params)
lr.fit(X, y)
final_predictions = lr.predict(test_x)

accuracy = (final_predictions == test_y).mean() * 100

print(&quot;Our accuracy in predicting the 2018 season is: {:.2f}%&quot;.format(accuracy))
</code></pre>
<pre><code>Our accuracy in predicting the 2018 season is: 67.68%
</code></pre>
<p>Now let's have a look at all the games which we incorrectly predicted.</p>
<pre><code class="language-python">game_ids = test_x[(final_predictions != test_y)].game
afl_data_one_line.loc[afl_data_one_line.game.isin(game_ids), ['date', 'home_team', 'opponent', 'f_odds', 'f_odds_away', 'f_margin']]
</code></pre>
<table>
<thead>
<tr>
<th></th>
<th>date</th>
<th>home_team</th>
<th>opponent</th>
<th>f_odds</th>
<th>f_odds_away</th>
<th>f_margin</th>
</tr>
</thead>
<tbody>
<tr>
<td>1386</td>
<td>2018-03-24</td>
<td>Gold Coast</td>
<td>North Melbourne</td>
<td>2.0161</td>
<td>1.9784</td>
<td>16</td>
</tr>
<tr>
<td>1388</td>
<td>2018-03-25</td>
<td>Melbourne</td>
<td>Geelong</td>
<td>1.7737</td>
<td>2.2755</td>
<td>-3</td>
</tr>
<tr>
<td>1391</td>
<td>2018-03-30</td>
<td>North Melbourne</td>
<td>St Kilda</td>
<td>3.5769</td>
<td>1.3867</td>
<td>52</td>
</tr>
<tr>
<td>1392</td>
<td>2018-03-31</td>
<td>Carlton</td>
<td>Gold Coast</td>
<td>1.5992</td>
<td>2.6620</td>
<td>-34</td>
</tr>
<tr>
<td>1396</td>
<td>2018-04-01</td>
<td>Western Bulldogs</td>
<td>West Coast</td>
<td>1.8044</td>
<td>2.2445</td>
<td>-51</td>
</tr>
<tr>
<td>1397</td>
<td>2018-04-01</td>
<td>Sydney</td>
<td>Port Adelaide</td>
<td>1.4949</td>
<td>3.0060</td>
<td>-23</td>
</tr>
<tr>
<td>1398</td>
<td>2018-04-02</td>
<td>Geelong</td>
<td>Hawthorn</td>
<td>1.7597</td>
<td>2.3024</td>
<td>-1</td>
</tr>
<tr>
<td>1406</td>
<td>2018-04-08</td>
<td>Western Bulldogs</td>
<td>Essendon</td>
<td>3.8560</td>
<td>1.3538</td>
<td>21</td>
</tr>
<tr>
<td>1408</td>
<td>2018-04-13</td>
<td>Adelaide</td>
<td>Collingwood</td>
<td>1.2048</td>
<td>5.9197</td>
<td>-48</td>
</tr>
<tr>
<td>1412</td>
<td>2018-04-14</td>
<td>North Melbourne</td>
<td>Carlton</td>
<td>1.5799</td>
<td>2.7228</td>
<td>86</td>
</tr>
<tr>
<td>1415</td>
<td>2018-04-15</td>
<td>Hawthorn</td>
<td>Melbourne</td>
<td>2.2855</td>
<td>1.7772</td>
<td>67</td>
</tr>
<tr>
<td>1417</td>
<td>2018-04-20</td>
<td>Sydney</td>
<td>Adelaide</td>
<td>1.2640</td>
<td>4.6929</td>
<td>-10</td>
</tr>
<tr>
<td>1420</td>
<td>2018-04-21</td>
<td>Port Adelaide</td>
<td>Geelong</td>
<td>1.5053</td>
<td>2.9515</td>
<td>-34</td>
</tr>
<tr>
<td>1422</td>
<td>2018-04-22</td>
<td>North Melbourne</td>
<td>Hawthorn</td>
<td>2.6170</td>
<td>1.6132</td>
<td>28</td>
</tr>
<tr>
<td>1423</td>
<td>2018-04-22</td>
<td>Brisbane</td>
<td>Gold Coast</td>
<td>1.7464</td>
<td>2.3277</td>
<td>-5</td>
</tr>
<tr>
<td>1425</td>
<td>2018-04-25</td>
<td>Collingwood</td>
<td>Essendon</td>
<td>1.8372</td>
<td>2.1754</td>
<td>49</td>
</tr>
<tr>
<td>1427</td>
<td>2018-04-28</td>
<td>Geelong</td>
<td>Sydney</td>
<td>1.5019</td>
<td>2.9833</td>
<td>-17</td>
</tr>
<tr>
<td>1434</td>
<td>2018-04-29</td>
<td>Fremantle</td>
<td>West Coast</td>
<td>2.4926</td>
<td>1.6531</td>
<td>-8</td>
</tr>
<tr>
<td>1437</td>
<td>2018-05-05</td>
<td>Essendon</td>
<td>Hawthorn</td>
<td>2.8430</td>
<td>1.5393</td>
<td>-23</td>
</tr>
<tr>
<td>1439</td>
<td>2018-05-05</td>
<td>Sydney</td>
<td>North Melbourne</td>
<td>1.2777</td>
<td>4.5690</td>
<td>-2</td>
</tr>
<tr>
<td>1444</td>
<td>2018-05-11</td>
<td>Hawthorn</td>
<td>Sydney</td>
<td>1.6283</td>
<td>2.5818</td>
<td>-8</td>
</tr>
<tr>
<td>1445</td>
<td>2018-05-12</td>
<td>GWS</td>
<td>West Coast</td>
<td>1.5425</td>
<td>2.8292</td>
<td>-25</td>
</tr>
<tr>
<td>1446</td>
<td>2018-05-12</td>
<td>Carlton</td>
<td>Essendon</td>
<td>3.1742</td>
<td>1.4570</td>
<td>13</td>
</tr>
<tr>
<td>1452</td>
<td>2018-05-13</td>
<td>Collingwood</td>
<td>Geelong</td>
<td>2.4127</td>
<td>1.7040</td>
<td>-21</td>
</tr>
<tr>
<td>1455</td>
<td>2018-05-19</td>
<td>North Melbourne</td>
<td>GWS</td>
<td>1.5049</td>
<td>2.9752</td>
<td>43</td>
</tr>
<tr>
<td>1456</td>
<td>2018-05-19</td>
<td>Essendon</td>
<td>Geelong</td>
<td>5.6530</td>
<td>1.2104</td>
<td>34</td>
</tr>
<tr>
<td>1460</td>
<td>2018-05-20</td>
<td>Brisbane</td>
<td>Hawthorn</td>
<td>3.2891</td>
<td>1.4318</td>
<td>56</td>
</tr>
<tr>
<td>1461</td>
<td>2018-05-20</td>
<td>West Coast</td>
<td>Richmond</td>
<td>1.9755</td>
<td>2.0154</td>
<td>47</td>
</tr>
<tr>
<td>1466</td>
<td>2018-05-26</td>
<td>GWS</td>
<td>Essendon</td>
<td>1.4364</td>
<td>3.2652</td>
<td>-35</td>
</tr>
<tr>
<td>1467</td>
<td>2018-05-27</td>
<td>Hawthorn</td>
<td>West Coast</td>
<td>2.2123</td>
<td>1.8133</td>
<td>-15</td>
</tr>
<tr>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr>
<td>1483</td>
<td>2018-06-10</td>
<td>Brisbane</td>
<td>Essendon</td>
<td>2.3018</td>
<td>1.7543</td>
<td>-22</td>
</tr>
<tr>
<td>1485</td>
<td>2018-06-11</td>
<td>Melbourne</td>
<td>Collingwood</td>
<td>1.6034</td>
<td>2.6450</td>
<td>-42</td>
</tr>
<tr>
<td>1492</td>
<td>2018-06-21</td>
<td>West Coast</td>
<td>Essendon</td>
<td>1.3694</td>
<td>3.6843</td>
<td>-28</td>
</tr>
<tr>
<td>1493</td>
<td>2018-06-22</td>
<td>Port Adelaide</td>
<td>Melbourne</td>
<td>1.7391</td>
<td>2.3426</td>
<td>10</td>
</tr>
<tr>
<td>1499</td>
<td>2018-06-29</td>
<td>Western Bulldogs</td>
<td>Geelong</td>
<td>6.2067</td>
<td>1.1889</td>
<td>2</td>
</tr>
<tr>
<td>1501</td>
<td>2018-06-30</td>
<td>Adelaide</td>
<td>West Coast</td>
<td>1.4989</td>
<td>2.9756</td>
<td>10</td>
</tr>
<tr>
<td>1504</td>
<td>2018-07-01</td>
<td>Melbourne</td>
<td>St Kilda</td>
<td>1.1405</td>
<td>7.7934</td>
<td>-2</td>
</tr>
<tr>
<td>1505</td>
<td>2018-07-01</td>
<td>Essendon</td>
<td>North Melbourne</td>
<td>2.0993</td>
<td>1.9022</td>
<td>17</td>
</tr>
<tr>
<td>1506</td>
<td>2018-07-01</td>
<td>Fremantle</td>
<td>Brisbane</td>
<td>1.2914</td>
<td>4.3743</td>
<td>-55</td>
</tr>
<tr>
<td>1507</td>
<td>2018-07-05</td>
<td>Sydney</td>
<td>Geelong</td>
<td>1.7807</td>
<td>2.2675</td>
<td>-12</td>
</tr>
<tr>
<td>1514</td>
<td>2018-07-08</td>
<td>Essendon</td>
<td>Collingwood</td>
<td>2.5442</td>
<td>1.6473</td>
<td>-16</td>
</tr>
<tr>
<td>1515</td>
<td>2018-07-08</td>
<td>West Coast</td>
<td>GWS</td>
<td>1.6790</td>
<td>2.4754</td>
<td>11</td>
</tr>
<tr>
<td>1516</td>
<td>2018-07-12</td>
<td>Adelaide</td>
<td>Geelong</td>
<td>2.0517</td>
<td>1.9444</td>
<td>15</td>
</tr>
<tr>
<td>1518</td>
<td>2018-07-14</td>
<td>Hawthorn</td>
<td>Brisbane</td>
<td>1.2281</td>
<td>5.4105</td>
<td>-33</td>
</tr>
<tr>
<td>1521</td>
<td>2018-07-14</td>
<td>GWS</td>
<td>Richmond</td>
<td>2.7257</td>
<td>1.5765</td>
<td>2</td>
</tr>
<tr>
<td>1522</td>
<td>2018-07-15</td>
<td>Collingwood</td>
<td>West Coast</td>
<td>1.5600</td>
<td>2.7815</td>
<td>-35</td>
</tr>
<tr>
<td>1523</td>
<td>2018-07-15</td>
<td>North Melbourne</td>
<td>Sydney</td>
<td>1.9263</td>
<td>2.0647</td>
<td>-6</td>
</tr>
<tr>
<td>1524</td>
<td>2018-07-15</td>
<td>Fremantle</td>
<td>Port Adelaide</td>
<td>5.9110</td>
<td>1.2047</td>
<td>9</td>
</tr>
<tr>
<td>1527</td>
<td>2018-07-21</td>
<td>Sydney</td>
<td>Gold Coast</td>
<td>1.0342</td>
<td>27.8520</td>
<td>-24</td>
</tr>
<tr>
<td>1529</td>
<td>2018-07-21</td>
<td>Brisbane</td>
<td>Adelaide</td>
<td>2.4614</td>
<td>1.6730</td>
<td>-5</td>
</tr>
<tr>
<td>1533</td>
<td>2018-07-22</td>
<td>Port Adelaide</td>
<td>GWS</td>
<td>1.6480</td>
<td>2.5452</td>
<td>-22</td>
</tr>
<tr>
<td>1538</td>
<td>2018-07-28</td>
<td>Gold Coast</td>
<td>Carlton</td>
<td>1.3933</td>
<td>3.5296</td>
<td>-35</td>
</tr>
<tr>
<td>1546</td>
<td>2018-08-04</td>
<td>Adelaide</td>
<td>Port Adelaide</td>
<td>2.0950</td>
<td>1.9135</td>
<td>3</td>
</tr>
<tr>
<td>1548</td>
<td>2018-08-04</td>
<td>St Kilda</td>
<td>Western Bulldogs</td>
<td>1.6120</td>
<td>2.6368</td>
<td>-35</td>
</tr>
<tr>
<td>1555</td>
<td>2018-08-11</td>
<td>Port Adelaide</td>
<td>West Coast</td>
<td>1.4187</td>
<td>3.3505</td>
<td>-4</td>
</tr>
<tr>
<td>1558</td>
<td>2018-08-12</td>
<td>North Melbourne</td>
<td>Western Bulldogs</td>
<td>1.3175</td>
<td>4.1239</td>
<td>-7</td>
</tr>
<tr>
<td>1559</td>
<td>2018-08-12</td>
<td>Melbourne</td>
<td>Sydney</td>
<td>1.3627</td>
<td>3.7445</td>
<td>-9</td>
</tr>
<tr>
<td>1564</td>
<td>2018-08-18</td>
<td>GWS</td>
<td>Sydney</td>
<td>1.8478</td>
<td>2.1672</td>
<td>-20</td>
</tr>
<tr>
<td>1576</td>
<td>2018-08-26</td>
<td>Brisbane</td>
<td>West Coast</td>
<td>2.3068</td>
<td>1.7548</td>
<td>-26</td>
</tr>
<tr>
<td>1578</td>
<td>2018-08-26</td>
<td>St Kilda</td>
<td>North Melbourne</td>
<td>3.5178</td>
<td>1.3936</td>
<td>-23</td>
</tr>
</tbody>
</table>
<p>Very interesting! Most of the games we got wrong were upsets. Let's have a look at the games we incorrectly predicted that weren't upsets.</p>
<pre><code class="language-python">(afl_data_one_line.loc[afl_data_one_line.game.isin(game_ids), ['date', 'home_team', 'opponent', 'f_odds', 'f_odds_away', 'f_margin']]
    .assign(home_favourite=lambda df: df.apply(lambda row: 1 if row.f_odds &lt; row.f_odds_away else 0, axis=1))
    .assign(upset=lambda df: df.apply(lambda row: 1 if row.home_favourite == 1 and row.f_margin &lt; 0 else 
                                      (1 if row.home_favourite == 0 and row.f_margin &gt; 0 else 0), axis=1))
    .query('upset == 0'))
</code></pre>
<table>
<thead>
<tr>
<th></th>
<th>date</th>
<th>home_team</th>
<th>opponent</th>
<th>f_odds</th>
<th>f_odds_away</th>
<th>f_margin</th>
<th>home_favourite</th>
<th>upset</th>
</tr>
</thead>
<tbody>
<tr>
<td>1412</td>
<td>2018-04-14</td>
<td>North Melbourne</td>
<td>Carlton</td>
<td>1.5799</td>
<td>2.7228</td>
<td>86</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>1425</td>
<td>2018-04-25</td>
<td>Collingwood</td>
<td>Essendon</td>
<td>1.8372</td>
<td>2.1754</td>
<td>49</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>1434</td>
<td>2018-04-29</td>
<td>Fremantle</td>
<td>West Coast</td>
<td>2.4926</td>
<td>1.6531</td>
<td>-8</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>1437</td>
<td>2018-05-05</td>
<td>Essendon</td>
<td>Hawthorn</td>
<td>2.8430</td>
<td>1.5393</td>
<td>-23</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>1452</td>
<td>2018-05-13</td>
<td>Collingwood</td>
<td>Geelong</td>
<td>2.4127</td>
<td>1.7040</td>
<td>-21</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>1455</td>
<td>2018-05-19</td>
<td>North Melbourne</td>
<td>GWS</td>
<td>1.5049</td>
<td>2.9752</td>
<td>43</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>1461</td>
<td>2018-05-20</td>
<td>West Coast</td>
<td>Richmond</td>
<td>1.9755</td>
<td>2.0154</td>
<td>47</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>1467</td>
<td>2018-05-27</td>
<td>Hawthorn</td>
<td>West Coast</td>
<td>2.2123</td>
<td>1.8133</td>
<td>-15</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>1479</td>
<td>2018-06-08</td>
<td>Port Adelaide</td>
<td>Richmond</td>
<td>1.7422</td>
<td>2.3420</td>
<td>14</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>1483</td>
<td>2018-06-10</td>
<td>Brisbane</td>
<td>Essendon</td>
<td>2.3018</td>
<td>1.7543</td>
<td>-22</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>1493</td>
<td>2018-06-22</td>
<td>Port Adelaide</td>
<td>Melbourne</td>
<td>1.7391</td>
<td>2.3426</td>
<td>10</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>1501</td>
<td>2018-06-30</td>
<td>Adelaide</td>
<td>West Coast</td>
<td>1.4989</td>
<td>2.9756</td>
<td>10</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>1514</td>
<td>2018-07-08</td>
<td>Essendon</td>
<td>Collingwood</td>
<td>2.5442</td>
<td>1.6473</td>
<td>-16</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>1515</td>
<td>2018-07-08</td>
<td>West Coast</td>
<td>GWS</td>
<td>1.6790</td>
<td>2.4754</td>
<td>11</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>1529</td>
<td>2018-07-21</td>
<td>Brisbane</td>
<td>Adelaide</td>
<td>2.4614</td>
<td>1.6730</td>
<td>-5</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>1576</td>
<td>2018-08-26</td>
<td>Brisbane</td>
<td>West Coast</td>
<td>2.3068</td>
<td>1.7548</td>
<td>-26</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>1578</td>
<td>2018-08-26</td>
<td>St Kilda</td>
<td>North Melbourne</td>
<td>3.5178</td>
<td>1.3936</td>
<td>-23</td>
<td>0</td>
<td>0</td>
</tr>
</tbody>
</table>
<p>Let's now look at our model's log loss for the 2018 season compared to the odds.</p>
<pre><code class="language-python">predictions_probs = lr.predict_proba(test_x)
</code></pre>
<pre><code class="language-python">metrics.log_loss(test_y, predictions_probs)
    0.584824211055384
</code></pre>
<pre><code class="language-python">test_x_unscaled = feature_df.loc[feature_df.season == 2018, ['game'] + feature_columns]

metrics.log_loss(test_y, test_x_unscaled[['f_current_odds_prob_away', 'f_current_odds_prob']])
    0.5545776633924343
</code></pre>
<p>So whilst our model performs decently, it doesn't beat the odds in terms of log loss. That's okay, it's still a decent start. In future iterations we can implement other algorithms and create new features which may improve performance.</p>
<hr />
<h2 id="next-steps">Next Steps</h2>
<p>Now that we have a model up and running, the next steps are to implement the model on a week to week basis.</p>
<hr />
<h1 id="04-weekly-predictions">04. Weekly Predictions</h1>
<p>Now that we have explored different algorithms for modelling, we can implement our chosen model and predict this week's AFL games! All you need to do is run the afl_modelling script each Thursday or Friday to predict the following week's games.</p>
<pre><code class="language-python"># Import Modules
from afl_feature_creation_v2 import prepare_afl_features
import afl_data_cleaning_v2
import afl_feature_creation_v2
import afl_modelling_v2
import datetime
import pandas as pd
import numpy as np
pd.set_option('display.max_columns', None)
from sklearn.linear_model import LogisticRegression
from sklearn.preprocessing import StandardScaler
import warnings
warnings.filterwarnings('ignore')
</code></pre>
<hr />
<h2 id="creating-the-features-for-this-weekends-games">Creating The Features For This Weekend's Games</h2>
<p>To actually predict this weekend's games, we need to create the same features that we have created in the previous tutorials for the games that will be played this weekend. This includes all the rolling averages, efficiency features, elo features etc. So the majority of this tutorial will be using previously defined functions to create features for the following weekend's games.</p>
<h3 id="create-next-weeks-dataframe">Create Next Week's DataFrame</h3>
<p>Let's first get our cleaned afl_data dataset, as well as the odds for next weekend and the 2018 fixture.</p>
<pre><code class="language-python"># Grab the cleaned AFL dataset and the column order
afl_data = afl_data_cleaning_v2.prepare_afl_data()
ordered_cols = afl_data.columns

# Define a function which grabs the odds for each game for the following weekend
def get_next_week_odds(path):
    # Get next week's odds
    next_week_odds = pd.read_csv(path)
    next_week_odds = next_week_odds.rename(columns={&quot;team_1&quot;: &quot;home_team&quot;, 
                                                &quot;team_2&quot;: &quot;away_team&quot;, 
                                                &quot;team_1_odds&quot;: &quot;odds&quot;, 
                                                &quot;team_2_odds&quot;: &quot;odds_away&quot;
                                               })
    return next_week_odds

# Import the fixture
# Define a function which gets the fixture and cleans it up
def get_fixture(path):
    # Get the afl fixture
    fixture = pd.read_csv(path)

    # Replace team names and reformat
    fixture = fixture.replace({'Brisbane Lions': 'Brisbane', 'Footscray': 'Western Bulldogs'})
    fixture['Date'] = pd.to_datetime(fixture['Date']).dt.date.astype(str)
    fixture = fixture.rename(columns={&quot;Home.Team&quot;: &quot;home_team&quot;, &quot;Away.Team&quot;: &quot;away_team&quot;})
    return fixture

next_week_odds = get_next_week_odds(&quot;data/weekly_odds.csv&quot;)
fixture = get_fixture(&quot;data/afl_fixture_2018.csv&quot;)
</code></pre>
<pre><code class="language-python">fixture.tail()
</code></pre>
<table>
<thead>
<tr>
<th></th>
<th>Date</th>
<th>Season</th>
<th>Season.Game</th>
<th>Round</th>
<th>home_team</th>
<th>away_team</th>
<th>Venue</th>
</tr>
</thead>
<tbody>
<tr>
<td>202</td>
<td>2018-09-14</td>
<td>2018</td>
<td>1</td>
<td>26</td>
<td>Hawthorn</td>
<td>Melbourne</td>
<td>MCG</td>
</tr>
<tr>
<td>203</td>
<td>2018-09-15</td>
<td>2018</td>
<td>1</td>
<td>26</td>
<td>Collingwood</td>
<td>GWS</td>
<td>MCG</td>
</tr>
<tr>
<td>204</td>
<td>2018-09-21</td>
<td>2018</td>
<td>1</td>
<td>27</td>
<td>Richmond</td>
<td>Collingwood</td>
<td>MCG</td>
</tr>
<tr>
<td>205</td>
<td>2018-09-22</td>
<td>2018</td>
<td>1</td>
<td>27</td>
<td>West Coast</td>
<td>Melbourne</td>
<td>Optus Stadium</td>
</tr>
<tr>
<td>206</td>
<td>2018-09-29</td>
<td>2018</td>
<td>1</td>
<td>28</td>
<td>West Coast</td>
<td>Collingwood</td>
<td>MCG</td>
</tr>
</tbody>
</table>
<pre><code class="language-python">next_week_odds
</code></pre>
<table>
<thead>
<tr>
<th></th>
<th>home_team</th>
<th>away_team</th>
<th>odds</th>
<th>odds_away</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>West Coast</td>
<td>Collingwood</td>
<td>2.34</td>
<td>1.75</td>
</tr>
</tbody>
</table>
<p>Now that we have these DataFrames, we will define a function which combines the fixture and next week's odds to create a single DataFrame for the games over the next 7 days. To use this function we will need Game IDs for next week. So we will create another function which creates Game IDs by using the Game ID from the last game played and adding 1 to it.</p>
<pre><code class="language-python"># Define a function which creates game IDs for this week's footy games
def create_next_weeks_game_ids(afl_data):
    odds = get_next_week_odds(&quot;data/weekly_odds.csv&quot;)

    # Get last week's Game ID
    last_afl_data_game = afl_data['game'].iloc[-1]

    # Create Game IDs for next week
    game_ids = [(i+1) + last_afl_data_game for i in range(odds.shape[0])]
    return game_ids

# Define a function which creates this week's footy game DataFrame
def get_next_week_df(afl_data):
    # Get the fixture and the odds for next week's footy games
    fixture = get_fixture(&quot;data/afl_fixture_2018.csv&quot;)
    next_week_odds = get_next_week_odds(&quot;data/weekly_odds.csv&quot;)
    next_week_odds['game'] = create_next_weeks_game_ids(afl_data)

    # Get today's date and next week's date and create a DataFrame for next week's games
#     todays_date = datetime.datetime.today().strftime('%Y-%m-%d')

#     date_in_7_days = (datetime.datetime.today() + datetime.timedelta(days=7)).strftime('%Y-%m-%d')
    todays_date = '2018-09-27'
    date_in_7_days = '2018-10-04'
    fixture = fixture[(fixture['Date'] &gt;= todays_date) &amp; (fixture['Date'] &lt; date_in_7_days)].drop(columns=['Season.Game'])
    next_week_df = pd.merge(fixture, next_week_odds, on=['home_team', 'away_team'])

    # Split the DataFrame onto two rows for each game
    h_df = (next_week_df[['Date', 'game', 'home_team', 'away_team', 'odds', 'Season', 'Round', 'Venue']]
               .rename(columns={'home_team': 'team', 'away_team': 'opponent'})
               .assign(home_game=1))

    a_df = (next_week_df[['Date', 'game', 'home_team', 'away_team', 'odds_away', 'Season', 'Round', 'Venue']]
                .rename(columns={'odds_away': 'odds', 'home_team': 'opponent', 'away_team': 'team'})
                .assign(home_game=0))

    next_week = a_df.append(h_df).sort_values(by='game').rename(columns={
        'Date': 'date',
        'Season': 'season',
        'Round': 'round',
        'Venue': 'venue'
    })
    next_week['date'] = pd.to_datetime(next_week.date)
    next_week['round'] = afl_data['round'].iloc[-1] + 1
    return next_week
</code></pre>
<pre><code class="language-python">next_week_df = get_next_week_df(afl_data)
game_ids_next_round = create_next_weeks_game_ids(afl_data)
next_week_df
</code></pre>
<table>
<thead>
<tr>
<th></th>
<th>date</th>
<th>round</th>
<th>season</th>
<th>venue</th>
<th>game</th>
<th>home_game</th>
<th>odds</th>
<th>opponent</th>
<th>team</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>2018-09-29</td>
<td>27</td>
<td>2018</td>
<td>MCG</td>
<td>15407</td>
<td>0</td>
<td>1.75</td>
<td>West Coast</td>
<td>Collingwood</td>
</tr>
<tr>
<td>0</td>
<td>2018-09-29</td>
<td>27</td>
<td>2018</td>
<td>MCG</td>
<td>15407</td>
<td>1</td>
<td>2.34</td>
<td>Collingwood</td>
<td>West Coast</td>
</tr>
</tbody>
</table>
<pre><code class="language-python">fixture.tail()
</code></pre>
<table>
<thead>
<tr>
<th></th>
<th>Date</th>
<th>Season</th>
<th>Season.Game</th>
<th>Round</th>
<th>home_team</th>
<th>away_team</th>
<th>Venue</th>
</tr>
</thead>
<tbody>
<tr>
<td>202</td>
<td>2018-09-14</td>
<td>2018</td>
<td>1</td>
<td>26</td>
<td>Hawthorn</td>
<td>Melbourne</td>
<td>MCG</td>
</tr>
<tr>
<td>203</td>
<td>2018-09-15</td>
<td>2018</td>
<td>1</td>
<td>26</td>
<td>Collingwood</td>
<td>GWS</td>
<td>MCG</td>
</tr>
<tr>
<td>204</td>
<td>2018-09-21</td>
<td>2018</td>
<td>1</td>
<td>27</td>
<td>Richmond</td>
<td>Collingwood</td>
<td>MCG</td>
</tr>
<tr>
<td>205</td>
<td>2018-09-22</td>
<td>2018</td>
<td>1</td>
<td>27</td>
<td>West Coast</td>
<td>Melbourne</td>
<td>Optus Stadium</td>
</tr>
<tr>
<td>206</td>
<td>2018-09-29</td>
<td>2018</td>
<td>1</td>
<td>28</td>
<td>West Coast</td>
<td>Collingwood</td>
<td>MCG</td>
</tr>
</tbody>
</table>
<h3 id="create-each-feature">Create Each Feature</h3>
<p>Now let's append next week's DataFrame to our afl_data, match_results and odds DataFrames and then create all the features we used in the <a href="/modelling/AFLmodelPart2">AFL Feature Creation Tutorial</a>. We need to append the games and then feed them into our function so that we can create features for upcoming games.</p>
<pre><code class="language-python"># Append next week's games to our afl_data DataFrame
afl_data = afl_data.append(next_week_df).reset_index(drop=True)

# Append next week's games to match results (we need to do this for our feature creation to run)
match_results = afl_data_cleaning_v2.get_cleaned_match_results().append(next_week_df)

# Append next week's games to odds
odds = (afl_data_cleaning_v2.get_cleaned_odds().pipe(lambda df: df.append(next_week_df[df.columns]))
       .reset_index(drop=True))
</code></pre>
<pre><code class="language-python">features_df = afl_feature_creation_v2.prepare_afl_features(afl_data=afl_data, match_results=match_results, odds=odds)
</code></pre>
<pre><code class="language-python">features_df.tail()
</code></pre>
<table>
<thead>
<tr>
<th></th>
<th>game</th>
<th>home_team</th>
<th>away_team</th>
<th>date</th>
<th>round</th>
<th>venue</th>
<th>season</th>
<th>f_odds</th>
<th>f_form_margin_btwn_teams</th>
<th>f_form_past_5_btwn_teams</th>
<th>f_odds_away</th>
<th>f_elo_home</th>
<th>f_elo_away</th>
<th>f_I50_efficiency_home</th>
<th>f_R50_efficiency_home</th>
<th>f_I50_efficiency_away</th>
<th>f_R50_efficiency_away</th>
<th>f_AF_diff</th>
<th>f_B_diff</th>
<th>f_BO_diff</th>
<th>f_CCL_diff</th>
<th>f_CG_diff</th>
<th>f_CL_diff</th>
<th>f_CM_diff</th>
<th>f_CP_diff</th>
<th>f_D_diff</th>
<th>f_ED_diff</th>
<th>f_FA_diff</th>
<th>f_FF_diff</th>
<th>f_G_diff</th>
<th>f_GA_diff</th>
<th>f_GA1_diff</th>
<th>f_HB_diff</th>
<th>f_HO_diff</th>
<th>f_I50_diff</th>
<th>f_ITC_diff</th>
<th>f_K_diff</th>
<th>f_M_diff</th>
<th>f_MG_diff</th>
<th>f_MI5_diff</th>
<th>f_One.Percenters_diff</th>
<th>f_R50_diff</th>
<th>f_SC_diff</th>
<th>f_SCL_diff</th>
<th>f_SI_diff</th>
<th>f_T_diff</th>
<th>f_T5_diff</th>
<th>f_TO_diff</th>
<th>f_UP_diff</th>
<th>f_Unnamed: 0_diff</th>
<th>f_behinds_diff</th>
<th>f_goals_diff</th>
<th>f_margin_diff</th>
<th>f_opponent_behinds_diff</th>
<th>f_opponent_goals_diff</th>
<th>f_opponent_points_diff</th>
<th>f_points_diff</th>
<th>f_current_odds_prob</th>
<th>f_current_odds_prob_away</th>
</tr>
</thead>
<tbody>
<tr>
<td>1065</td>
<td>15397</td>
<td>Melbourne</td>
<td>GWS</td>
<td>2018-08-26</td>
<td>23</td>
<td>M.C.G.</td>
<td>2018</td>
<td>1.966936</td>
<td>-23.2</td>
<td>2.0</td>
<td>1.813998</td>
<td>1523.456734</td>
<td>1609.444874</td>
<td>0.653525</td>
<td>0.680168</td>
<td>0.704767</td>
<td>0.749812</td>
<td>140.535514</td>
<td>0.605144</td>
<td>-9.771981</td>
<td>5.892176</td>
<td>7.172376</td>
<td>6.614609</td>
<td>-1.365211</td>
<td>30.766262</td>
<td>21.998618</td>
<td>0.067228</td>
<td>-1.404730</td>
<td>-3.166732</td>
<td>6.933998</td>
<td>6.675576</td>
<td>0.000000</td>
<td>38.708158</td>
<td>24.587333</td>
<td>12.008987</td>
<td>10.482382</td>
<td>-16.709540</td>
<td>-15.415060</td>
<td>289.188486</td>
<td>6.350287</td>
<td>-2.263536</td>
<td>-20.966818</td>
<td>50.388632</td>
<td>0.723637</td>
<td>15.537783</td>
<td>22.912269</td>
<td>2.065039</td>
<td>10.215523</td>
<td>-6.689429</td>
<td>3259.163465</td>
<td>-0.136383</td>
<td>3.553795</td>
<td>16.563721</td>
<td>-2.353514</td>
<td>1.162696</td>
<td>4.622664</td>
<td>21.186385</td>
<td>0.661551</td>
<td>0.340379</td>
</tr>
<tr>
<td>1066</td>
<td>15398</td>
<td>St Kilda</td>
<td>North Melbourne</td>
<td>2018-08-26</td>
<td>23</td>
<td>Docklands</td>
<td>2018</td>
<td>5.089084</td>
<td>-3.2</td>
<td>2.0</td>
<td>2.577161</td>
<td>1397.237139</td>
<td>1499.366007</td>
<td>0.725980</td>
<td>0.655749</td>
<td>0.723949</td>
<td>0.677174</td>
<td>51.799992</td>
<td>3.399035</td>
<td>6.067393</td>
<td>-2.189489</td>
<td>-10.475859</td>
<td>1.154766</td>
<td>-8.883840</td>
<td>-21.810962</td>
<td>33.058382</td>
<td>40.618410</td>
<td>2.286314</td>
<td>-0.345734</td>
<td>-3.778445</td>
<td>-2.182673</td>
<td>0.000000</td>
<td>19.816372</td>
<td>-21.562916</td>
<td>2.678384</td>
<td>-14.777698</td>
<td>13.242010</td>
<td>12.065594</td>
<td>-82.381996</td>
<td>-2.176564</td>
<td>2.335825</td>
<td>-4.952336</td>
<td>45.719406</td>
<td>3.344217</td>
<td>-2.095613</td>
<td>-3.929084</td>
<td>-3.182381</td>
<td>-12.832197</td>
<td>57.226776</td>
<td>-20221.371526</td>
<td>1.968709</td>
<td>-1.897958</td>
<td>-15.177001</td>
<td>1.067099</td>
<td>0.781811</td>
<td>5.757963</td>
<td>-9.419038</td>
<td>0.284269</td>
<td>0.717566</td>
</tr>
<tr>
<td>1067</td>
<td>15404</td>
<td>Collingwood</td>
<td>GWS</td>
<td>2018-09-15</td>
<td>25</td>
<td>M.C.G.</td>
<td>2018</td>
<td>1.882301</td>
<td>12.6</td>
<td>3.0</td>
<td>2.018344</td>
<td>1546.000498</td>
<td>1590.806454</td>
<td>0.693185</td>
<td>0.706222</td>
<td>0.718446</td>
<td>0.727961</td>
<td>205.916671</td>
<td>-1.642954</td>
<td>-2.980828</td>
<td>-0.266023</td>
<td>8.547225</td>
<td>-3.751909</td>
<td>-0.664977</td>
<td>10.563513</td>
<td>48.175985</td>
<td>43.531908</td>
<td>-5.836979</td>
<td>5.388668</td>
<td>4.395675</td>
<td>2.555152</td>
<td>0.000000</td>
<td>51.588962</td>
<td>11.558254</td>
<td>4.276481</td>
<td>11.284445</td>
<td>-3.412977</td>
<td>-2.206815</td>
<td>-234.577304</td>
<td>2.637758</td>
<td>-10.537765</td>
<td>-11.127876</td>
<td>125.607377</td>
<td>-3.485896</td>
<td>3.532031</td>
<td>15.102292</td>
<td>-2.500685</td>
<td>8.187543</td>
<td>38.053445</td>
<td>12500.525732</td>
<td>-1.006173</td>
<td>2.520135</td>
<td>18.634835</td>
<td>-2.159882</td>
<td>-0.393386</td>
<td>-4.520198</td>
<td>14.114637</td>
<td>0.608495</td>
<td>0.393856</td>
</tr>
<tr>
<td>1068</td>
<td>15406</td>
<td>West Coast</td>
<td>Melbourne</td>
<td>2018-09-22</td>
<td>26</td>
<td>Perth Stadium</td>
<td>2018</td>
<td>2.013572</td>
<td>21.2</td>
<td>3.0</td>
<td>1.884148</td>
<td>1577.888606</td>
<td>1542.095154</td>
<td>0.688877</td>
<td>0.708941</td>
<td>0.649180</td>
<td>0.698319</td>
<td>-118.135184</td>
<td>-3.005709</td>
<td>2.453190</td>
<td>-5.103869</td>
<td>-14.368949</td>
<td>-12.245458</td>
<td>2.771411</td>
<td>-45.364271</td>
<td>-60.210182</td>
<td>-24.049523</td>
<td>-2.791277</td>
<td>6.115918</td>
<td>-5.041030</td>
<td>-5.335746</td>
<td>0.000000</td>
<td>-78.816902</td>
<td>-18.784547</td>
<td>-13.957754</td>
<td>-5.527613</td>
<td>18.606721</td>
<td>25.366778</td>
<td>-910.988860</td>
<td>-5.515812</td>
<td>-9.483590</td>
<td>8.914093</td>
<td>-131.380758</td>
<td>-7.142529</td>
<td>-49.484957</td>
<td>-13.718798</td>
<td>-4.862994</td>
<td>-9.834616</td>
<td>-23.673638</td>
<td>-3178.282073</td>
<td>-1.785349</td>
<td>-2.569957</td>
<td>-20.008787</td>
<td>0.476202</td>
<td>0.387915</td>
<td>2.803694</td>
<td>-17.205093</td>
<td>0.543774</td>
<td>0.457875</td>
</tr>
<tr>
<td>1069</td>
<td>15407</td>
<td>West Coast</td>
<td>Collingwood</td>
<td>2018-09-29</td>
<td>27</td>
<td>MCG</td>
<td>2018</td>
<td>1.981832</td>
<td>17.2</td>
<td>3.0</td>
<td>1.838864</td>
<td>1591.348723</td>
<td>1562.924273</td>
<td>0.679011</td>
<td>0.724125</td>
<td>0.711352</td>
<td>0.709346</td>
<td>159.522670</td>
<td>0.893421</td>
<td>-0.475725</td>
<td>3.391070</td>
<td>-5.088751</td>
<td>5.875388</td>
<td>5.352234</td>
<td>7.729063</td>
<td>-7.358202</td>
<td>-4.719968</td>
<td>6.113565</td>
<td>4.822252</td>
<td>2.871241</td>
<td>2.690270</td>
<td>3.636364</td>
<td>-64.238180</td>
<td>-0.631102</td>
<td>2.078832</td>
<td>6.005613</td>
<td>56.879978</td>
<td>34.373271</td>
<td>1016.491933</td>
<td>1.199751</td>
<td>2.454685</td>
<td>12.197047</td>
<td>219.666562</td>
<td>2.484363</td>
<td>0.379162</td>
<td>2.566991</td>
<td>0.639666</td>
<td>2.258377</td>
<td>-23.841529</td>
<td>-368920.360240</td>
<td>-0.646160</td>
<td>0.892051</td>
<td>3.040850</td>
<td>1.589568</td>
<td>0.012622</td>
<td>1.665299</td>
<td>4.706148</td>
<td>0.427350</td>
<td>0.571429</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="create-predictions-for-the-upcoming-round">Create Predictions For the Upcoming Round</h2>
<p>Now that we have our features, we can use our model that we created in <a href="/modelling/AFLmodelPart3">part 3</a> to predict the next round. First we need to filter our features_df into a training df and a df with next round's features/matches. Then we can use the model created in the last tutorial to create predictions. For simplicity, I have hardcoded the parameters we used in the last tutorial.</p>
<pre><code class="language-python"># Get the train df by only taking the games IDs which aren't in the next week df
train_df = features_df[~features_df.game.isin(next_week_df.game)]

# Get the result and merge to the feature_df
match_results = (pd.read_csv(&quot;data/afl_match_results.csv&quot;)
                    .rename(columns={'Game': 'game'})
                    .assign(result=lambda df: df.apply(lambda row: 1 if row['Home.Points'] &gt; row['Away.Points'] else 0, axis=1)))

train_df = pd.merge(train_df,  match_results[['game', 'result']], on='game')

train_x = train_df.drop(columns=['result'])
train_y = train_df.result

next_round_x = features_df[features_df.game.isin(next_week_df.game)]
</code></pre>
<pre><code class="language-python"># Fit out logistic regression model - note that our predictions come out in the order of [away_team_prob, home_team_prob]

lr_best_params = {'C': 0.01,
 'class_weight': None,
 'dual': False,
 'fit_intercept': True,
 'intercept_scaling': 1,
 'max_iter': 100,
 'multi_class': 'ovr',
 'n_jobs': 1,
 'penalty': 'l2',
 'random_state': None,
 'solver': 'newton-cg',
 'tol': 0.0001,
 'verbose': 0,
 'warm_start': False}

feature_cols = [col for col in train_df if col.startswith('f_')]

# Scale features
scaler = StandardScaler()
train_x[feature_cols] = scaler.fit_transform(train_x[feature_cols])
next_round_x[feature_cols] = scaler.transform(next_round_x[feature_cols])

lr = LogisticRegression(**lr_best_params)
lr.fit(train_x[feature_cols], train_y)
prediction_probs = lr.predict_proba(next_round_x[feature_cols])

modelled_home_odds = [1/i[1] for i in prediction_probs]
modelled_away_odds = [1/i[0] for i in prediction_probs]
</code></pre>
<pre><code class="language-python"># Create a predictions df
preds_df = (next_round_x[['date', 'home_team', 'away_team', 'venue', 'game']].copy()
               .assign(modelled_home_odds=modelled_home_odds,
                      modelled_away_odds=modelled_away_odds)
               .pipe(pd.merge, next_week_odds, on=['home_team', 'away_team'])
               .pipe(pd.merge, features_df[['game', 'f_elo_home', 'f_elo_away']], on='game')
               .drop(columns='game')
           )
</code></pre>
<pre><code class="language-python">preds_df
</code></pre>
<table>
<thead>
<tr>
<th></th>
<th>date</th>
<th>home_team</th>
<th>away_team</th>
<th>venue</th>
<th>modelled_home_odds</th>
<th>modelled_away_odds</th>
<th>odds</th>
<th>odds_away</th>
<th>f_elo_home</th>
<th>f_elo_away</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>2018-09-29</td>
<td>West Coast</td>
<td>Collingwood</td>
<td>MCG</td>
<td>2.326826</td>
<td>1.753679</td>
<td>2.34</td>
<td>1.75</td>
<td>1591.348723</td>
<td>1562.924273</td>
</tr>
</tbody>
</table>
<p>Alternatively, if you want to generate predictions using a script which uses all the above code, just run the following:</p>
<pre><code class="language-python">print(afl_modelling_v2.create_predictions())
</code></pre>
<pre><code>        date   home_team    away_team venue  modelled_home_odds  \
0 2018-09-29  West Coast  Collingwood   MCG            2.326826

   modelled_away_odds  odds  odds_away   f_elo_home   f_elo_away  
0            1.753679  2.34       1.75  1591.348723  1562.924273
</code></pre>
<hr />
<h2 id="conclusion">Conclusion</h2>
<p>Congratulations! You have created AFL predictions for this week. If you are beginner to this, don't be overwhelmed. The process gets easier each time you do it. And it is super rewarding. In future iterations we will update this tutorial to predict actual odds, and then integrate this with <a href="../../api/apiappkey">Betfair's API</a> so that you can create an automated betting strategy using Machine Learning to create your predictions!</p>
<hr />
<h3 id="disclaimer">Disclaimer</h3>
<p>Note that whilst models and automated strategies are fun and rewarding to create, we can't promise that your model or betting strategy will be profitable, and we make no representations in relation to the code shared or information on this page. If you're using this code or implementing your own strategies, you do so entirely at your own risk and you are responsible for any winnings/losses incurred. Under no circumstances will Betfair be liable for any loss or damage you suffer.</p>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
    
      <nav class="md-footer__inner md-grid" aria-label="Footer">
        
          
          <a href="../EPLmlPython/" class="md-footer__link md-footer__link--prev" aria-label="Previous: EPL ML walk through in Python" rel="prev">
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer__title">
              <div class="md-ellipsis">
                <span class="md-footer__direction">
                  Previous
                </span>
                EPL ML walk through in Python
              </div>
            </div>
          </a>
        
        
          
          <a href="../brownlowModelTutorial/" class="md-footer__link md-footer__link--next" aria-label="Next: Modelling the Brownlow Medal in Python" rel="next">
            <div class="md-footer__title">
              <div class="md-ellipsis">
                <span class="md-footer__direction">
                  Next
                </span>
                Modelling the Brownlow Medal in Python
              </div>
            </div>
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    
    <div class="md-footer-meta md-typeset">
      <div class="md-footer-meta__inner md-grid">
        <div class="md-copyright">
  
  
</div>
        
          <div class="md-social">
  
    
    
      
      
    
    <a href="https://twitter.com/Betfair_Aus" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://linkedin.com/company/betfair-australia" target="_blank" rel="noopener" title="linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://facebook.com/betfairaustralia" target="_blank" rel="noopener" title="facebook.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14 0 55.52 4.84 55.52 4.84v61h-31.28c-30.8 0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://youtube.com/user/betfairaus" target="_blank" rel="noopener" title="youtube.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://github.com/betfair-datascientists" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
</div>
        
      </div>

      <div class="bf-footer">
          <div class="bf-footer-inner">
              <p class="bf-light">Betfair Pty Limited is licensed and regulated by the Northern Territory Government of Australia.</p>
              <p class="bf-dark">Betfair Pty Limited's gambling operations are governed by its Responsible Gambling Code of Conduct and for South
              Australian residents by the South Australian Responsible Gambling Code of Practice.<br /> Think! About your choices. Don’t let the game play you. Stay in control. Gamble responsibly. Call Gambling Help 1800 858 858 <a href="https://gamblinghelponline.org.au">www.gamblinghelponline.org.au</a></p>
          
              <ul class="bf-links">
                <li><a href="https://www.betfair.com.au/hub/help/account-help/responsible-gambling/">Responsible Gambling</a><span>|</span></li>
                <li><a href="http://www.betfair.com/AUS_NZL/aboutUs/Terms.and.Conditions/">Terms & Conditions</a><span>|</span></li>
                <li><a href="https://www.betfair.com.au/info/privacy-policy/">Privacy Policy</a><span>|</span></li>
                <li><a href="http://www.betfair.com/en/aboutUs/Rules.and.Regulations/">Rules & Regulations</a><span>|</span></li>
                <li><a href="https://www.betfair.com/AUS_NZL/aboutUs/Dispute.Resolution">Dispute Resolution</a></li>
              </ul>
          </div>
      </div>
    </div>

    <script src="https://js.adsrvr.org/up_loader.1.1.0.js" type="text/javascript"></script>
    <script type="text/javascript">
        ttd_dom_ready( function() {
            if (typeof TTDUniversalPixelApi === 'function') {
                var universalPixelApi = new TTDUniversalPixelApi();
                universalPixelApi.init("y12d1ir", ["8ml4f17"], "https://insight.adsrvr.org/track/up");
            }
        });
    </script>

</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../assets/javascripts/workers/search.22074ed6.min.js"}</script>
    
    
      <script src="../../assets/javascripts/bundle.1514a9a0.min.js"></script>
      
    
  </body>
</html>