



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Documentation, guides and articles on creating, developing and implementing automated betting strategies, using data analysis to inform betting models and how to interact with the Betfair API.">
      
      
        <link rel="canonical" href="https://betfair-datascientists.github.io/modelling/AusOpenPythonTutorial/">
      
      
        <meta name="author" content="Betfair Data Scientists">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../img/BetfairFavicon.ico">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-3.0.4">
    
    
      
        <title>Aus Open Python Tutorial - The Automation Hub</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.0028e27e.css">
      
      
    
    
      <script src="../../assets/javascripts/modernizr.dd00d4b7.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    <link rel="stylesheet" href="../../assets/fonts/clarke-regular.css">
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#australian-open-datathon-r-tutorial" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://betfair-datascientists.github.io" title="The Automation Hub" class="md-header-nav__button md-logo">
          
            <img src="../../img/logo.svg" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                The Automation Hub
              </span>
              <span class="md-header-nav__topic">
                Aus Open Python Tutorial
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      <div class="bf-nav md-flex__cell">
        <a class="bf-hidable" href="https://www.betfair.com.au/exchange/plus/"><svg class="exchangeLogo" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 38.775 4.59" width="24" height="17">
          <path class="st1" d="m 160.3,-136.95 v 26"/>
          <g transform="translate(18.8,-137.15)">
            <path d="m 2.2901089,126.53441 v 5.20093 H -3.3107216 L 7.4888397,144.33446 18.2884,131.73534 h -5.598633 v -5.20093 z m -8.6000974,8.10132 -10.8017585,12.59913 h 5.60083 v 5.2998 h 10.3996581 v -5.2998 h 5.6008306 z"/>
          </g>
        </svg><span> Exchange</span></a>
        <a href="https://www.betfair.com.au/hub/">Hub</a>
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../.." title="Home" class="md-tabs__link">
          Home
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../thirdPartyTools/overview/" title="Tutorials" class="md-tabs__link">
          Tutorials
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../api/apiappkey/" title="API" class="md-tabs__link">
          API
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../historicData/dataSources/" title="Historic Data" class="md-tabs__link">
          Historic Data
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../howToModel/" title="Modelling" class="md-tabs__link md-tabs__link--active">
          Modelling
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://betfair-datascientists.github.io" title="The Automation Hub" class="md-nav__button md-logo">
      
        <img src="../../img/logo.svg" width="48" height="48">
      
    </a>
    The Automation Hub
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1">
    
    <label class="md-nav__link" for="nav-1">
      Home
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-1">
        Home
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../.." title="The Automation Hub" class="md-nav__link">
      The Automation Hub
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Tutorials
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Tutorials
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/overview/" title="Tools Overview" class="md-nav__link">
      Tools Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-2" type="checkbox" id="nav-2-2">
    
    <label class="md-nav__link" for="nav-2-2">
      Bet Angel Professional
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-2">
        Bet Angel Professional
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/betAngel/betAngel/" title="Overview - Bet Angel Pro" class="md-nav__link">
      Overview - Bet Angel Pro
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/betAngelbeginners/" title="Bet Angel - A beginner's guide" class="md-nav__link">
      Bet Angel - A beginner's guide
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/betAngelintermediate/" title="Bet Angel - An intermediate guide" class="md-nav__link">
      Bet Angel - An intermediate guide
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/betAngeladvanced/" title="Bet Angel - An advanced guide" class="md-nav__link">
      Bet Angel - An advanced guide
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/betAngelRatingsAutomation/" title="Ratings automation" class="md-nav__link">
      Ratings automation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/betAngelMarketFavouriteAutomation/" title="Market favourite automation" class="md-nav__link">
      Market favourite automation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/betAngelTippingAutomation/" title="Tipping automation" class="md-nav__link">
      Tipping automation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/betAngelSimultaneousMarkets/" title="Simultaneous markets" class="md-nav__link">
      Simultaneous markets
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/betAngelKellyStake/" title="Kelly Criterion staking" class="md-nav__link">
      Kelly Criterion staking
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-3" type="checkbox" id="nav-2-3">
    
    <label class="md-nav__link" for="nav-2-3">
      Gruss Betting Assistant
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-3">
        Gruss Betting Assistant
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/Gruss/Gruss/" title="Overview - Gruss" class="md-nav__link">
      Overview - Gruss
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/grussRatingsAutomation/" title="Ratings automation" class="md-nav__link">
      Ratings automation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/grussMarketFavouriteAutomation/" title="Market favourite automation" class="md-nav__link">
      Market favourite automation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/grusslSimultaneousMarkets/" title="Simultaneous markets" class="md-nav__link">
      Simultaneous markets
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/grussKellyStake/" title="Kelly Criterion staking" class="md-nav__link">
      Kelly Criterion staking
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-4" type="checkbox" id="nav-2-4">
    
    <label class="md-nav__link" for="nav-2-4">
      Cymatic Trader
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-4">
        Cymatic Trader
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/CymaticTrader/CymaticTrader/" title="Overview - Cymatic Trader" class="md-nav__link">
      Overview - Cymatic Trader
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/cymaticTraderRatingsAutomation/" title="Ratings automation" class="md-nav__link">
      Ratings automation
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      API
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        API
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../api/apiappkey/" title="How to access the Betfair API" class="md-nav__link">
      How to access the Betfair API
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../api/apiRtutorial/" title="API tutorials in R" class="md-nav__link">
      API tutorials in R
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../api/apiPythontutorial/" title="API tutorial in Python" class="md-nav__link">
      API tutorial in Python
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Historic Data
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Historic Data
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../historicData/dataSources/" title="Historic Data Sources" class="md-nav__link">
      Historic Data Sources
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../historicData/usingHistoricDataSite/" title="Downloading from the Historic Data site" class="md-nav__link">
      Downloading from the Historic Data site
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5" checked>
    
    <label class="md-nav__link" for="nav-5">
      Modelling
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Modelling
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../howToModel/" title="Intro to modelling" class="md-nav__link">
      Intro to modelling
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../howToModelTheAusOpen/" title="How to model the Australian Open" class="md-nav__link">
      How to model the Australian Open
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../AusOpenRTutorial/" title="Aus Open R Tutorial" class="md-nav__link">
      Aus Open R Tutorial
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Aus Open Python Tutorial
      </label>
    
    <a href="./" title="Aus Open Python Tutorial" class="md-nav__link md-nav__link--active">
      Aus Open Python Tutorial
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" title="Overview" class="md-nav__link">
    Overview
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-task" title="The Task" class="md-nav__link">
    The Task
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prizes" title="Prizes" class="md-nav__link">
    Prizes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#submission" title="Submission" class="md-nav__link">
    Submission
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#intention" title="Intention" class="md-nav__link">
    Intention
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#data-preprocessing" title="Data preprocessing" class="md-nav__link">
    Data preprocessing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#feature-engineering" title="Feature Engineering" class="md-nav__link">
    Feature Engineering
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#convert-the-raw-dataframes-into-long-format" title="Convert the raw dataframes into long format:" class="md-nav__link">
    Convert the raw dataframes into long format:
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-some-new-features" title="Create some new features" class="md-nav__link">
    Create some new features
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#take-the-rolling-average-for-each-player-and-each-match" title="Take the rolling average for each player and each match" class="md-nav__link">
    Take the rolling average for each player and each match
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#calculate-the-difference-of-averages-for-each-match-in-the-data-frames" title="Calculate the difference of averages for each match in the data frames" class="md-nav__link">
    Calculate the difference of averages for each match in the data frames
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modelling" title="Modelling" class="md-nav__link">
    Modelling
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#h2o-model-for-atp" title="H2O model for ATP" class="md-nav__link">
    H2O model for ATP
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#use-the-models-to-predict-and-make-submissions" title="Use the models to predict and make submissions" class="md-nav__link">
    Use the models to predict and make submissions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#get-the-features-for-the-predict-df" title="Get the features for the predict df" class="md-nav__link">
    Get the features for the predict df
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#make-the-prediction" title="Make the prediction" class="md-nav__link">
    Make the prediction
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../EPLmodelPart1/" title="EPL 01. Data acquisition & exploration" class="md-nav__link">
      EPL 01. Data acquisition & exploration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../EPLmodelPart2/" title="EPL 02. Data preparation & feature engineering" class="md-nav__link">
      EPL 02. Data preparation & feature engineering
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../EPLmodelPart3/" title="EPL 03. Model building & hyperparameter tuning" class="md-nav__link">
      EPL 03. Model building & hyperparameter tuning
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../EPLmodelPart4/" title="EPL 04. Weekly predictions" class="md-nav__link">
      EPL 04. Weekly predictions
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../AFLmodelPart1/" title="AFL 01. Data cleaning" class="md-nav__link">
      AFL 01. Data cleaning
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../AFLmodelPart2/" title="AFL 02. Feature creation" class="md-nav__link">
      AFL 02. Feature creation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../AFLmodelPart3/" title="AFL 03. Modelling" class="md-nav__link">
      AFL 03. Modelling
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../AFLmodelPart4/" title="AFL 04. Weekly predictions" class="md-nav__link">
      AFL 04. Weekly predictions
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../brownlowModelTutorial/" title="Modelling the Brownlow Medal" class="md-nav__link">
      Modelling the Brownlow Medal
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" title="Overview" class="md-nav__link">
    Overview
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-task" title="The Task" class="md-nav__link">
    The Task
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prizes" title="Prizes" class="md-nav__link">
    Prizes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#submission" title="Submission" class="md-nav__link">
    Submission
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#intention" title="Intention" class="md-nav__link">
    Intention
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#data-preprocessing" title="Data preprocessing" class="md-nav__link">
    Data preprocessing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#feature-engineering" title="Feature Engineering" class="md-nav__link">
    Feature Engineering
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#convert-the-raw-dataframes-into-long-format" title="Convert the raw dataframes into long format:" class="md-nav__link">
    Convert the raw dataframes into long format:
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-some-new-features" title="Create some new features" class="md-nav__link">
    Create some new features
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#take-the-rolling-average-for-each-player-and-each-match" title="Take the rolling average for each player and each match" class="md-nav__link">
    Take the rolling average for each player and each match
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#calculate-the-difference-of-averages-for-each-match-in-the-data-frames" title="Calculate the difference of averages for each match in the data frames" class="md-nav__link">
    Calculate the difference of averages for each match in the data frames
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#modelling" title="Modelling" class="md-nav__link">
    Modelling
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#h2o-model-for-atp" title="H2O model for ATP" class="md-nav__link">
    H2O model for ATP
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#use-the-models-to-predict-and-make-submissions" title="Use the models to predict and make submissions" class="md-nav__link">
    Use the models to predict and make submissions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#get-the-features-for-the-predict-df" title="Get the features for the predict df" class="md-nav__link">
    Get the features for the predict df
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#make-the-prediction" title="Make the prediction" class="md-nav__link">
    Make the prediction
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="australian-open-datathon-r-tutorial">Australian Open Datathon R Tutorial<a class="headerlink" href="#australian-open-datathon-r-tutorial" title="Permanent link">&para;</a></h1>
<h2 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">&para;</a></h2>
<h3 id="the-task">The Task<a class="headerlink" href="#the-task" title="Permanent link">&para;</a></h3>
<p>This notebook will outline how the Betfair Data Scientists went about modelling the Australian Open for Betfair's Australian Open Datathon. The task is simple: we ask you to predict the winner of every possible Australian Open matchup using data which we provide.</p>
<p>The metric used to determine the winner will be log loss, based on the actual matchups that happen in the Open. For more information on log loss, click <a href="http://wiki.fast.ai/index.php/Log_Loss">here</a>.</p>
<p>For a detailed outline of the task, the prizes, and to sign up, click <a href="https://www.betfair.com.au/hub/australian-open-datathon/">here</a>.</p>
<p>How an outline of our methodoly and thought process, read <a href="/modelling/howToModelTheAusOpen">this</a> article.</p>
<h3 id="prizes">Prizes<a class="headerlink" href="#prizes" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Place</th>
<th>Prize</th>
<th>Place</th>
<th>Prize</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>$5000</td>
<td>9</td>
<td>$500</td>
</tr>
<tr>
<td>2</td>
<td>$3000</td>
<td>10</td>
<td>$500</td>
</tr>
<tr>
<td>3</td>
<td>$2000</td>
<td>11</td>
<td>$200</td>
</tr>
<tr>
<td>4</td>
<td>$1000</td>
<td>12</td>
<td>$200</td>
</tr>
<tr>
<td>5</td>
<td>$750</td>
<td>13</td>
<td>$200</td>
</tr>
<tr>
<td>6</td>
<td>$500</td>
<td>14</td>
<td>$200</td>
</tr>
<tr>
<td>7</td>
<td>$500</td>
<td>15</td>
<td>$200</td>
</tr>
<tr>
<td>8</td>
<td>$500</td>
<td>Total</td>
<td>$15250</td>
</tr>
</tbody>
</table>
<h3 id="submission">Submission<a class="headerlink" href="#submission" title="Permanent link">&para;</a></h3>
<ul>
<li>To submit your model, email your final submission to <a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#100;&#97;&#116;&#97;&#116;&#104;&#111;&#110;&#64;&#98;&#101;&#116;&#102;&#97;&#105;&#114;&#46;&#99;&#111;&#109;&#46;&#97;&#117;">&#100;&#97;&#116;&#97;&#116;&#104;&#111;&#110;&#64;&#98;&#101;&#116;&#102;&#97;&#105;&#114;&#46;&#99;&#111;&#109;&#46;&#97;&#117;</a>. Note that you don't need to email your code, just your predictions in the format that we have specified</li>
<li>No submissions will be accepted prior to the Australian Open qualifying matches being completed and the final draw list being shared with registered participants (12 January 2019)</li>
<li>Submissions need to include all potential match ups during the Australian Open, i.e. all possible combinations for each men's and women's tournaments (this will be provided after the draw is announced and the Australian Open qualifying matches are completed (Jan 12<sup>th</sup> 2019))</li>
<li>Submissions must follow the format outlined above and shown in the 'Dummy Submission File'. Any submissions that are not in the correct format will not be accepted.</li>
<li>Submissions need to include the player names for the hypothetical match up and the probability of the first player winning
i.e. player_1,player_2,probability_of_player_1_winning,</li>
<li>Submissions must be in a csv format</li>
<li>Only two models will be accepted per participant (one model for the men's draw, one model for the women's draw)</li>
</ul>
<h3 id="intention">Intention<a class="headerlink" href="#intention" title="Permanent link">&para;</a></h3>
<p>This notebook will demostrate how to:</p>
<ul>
<li>Process the raw data sets</li>
<li>Produce simple features</li>
<li>Run a predictive model on H2O</li>
<li>Outputs the final predictions for the submissions</li>
<li>Load the data and required packages</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">import</span> <span class="n">numpy</span> <span class="n">as</span> <span class="n">np</span>
<span class="n">import</span> <span class="n">pandas</span> <span class="n">as</span> <span class="n">pd</span>
<span class="n">import</span> <span class="n">os</span>
<span class="n">import</span> <span class="n">gc</span>
<span class="n">import</span> <span class="n">sys</span>
<span class="n">import</span> <span class="n">warnings</span>
<span class="nf">warnings.filterwarnings</span><span class="p">(</span><span class="s">&#39;ignore&#39;</span><span class="p">)</span>
<span class="n">import</span> <span class="n">h2o</span>
<span class="n">from</span> <span class="n">h2o.automl</span> <span class="n">import</span> <span class="n">H2OAutoML</span>


<span class="n">pd.options.display.max_columns</span> <span class="o">=</span> <span class="m">999</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># We are loading both the mens and womens match csvs</span>
<span class="n">df_atp</span> <span class="o">=</span> <span class="nf">pd.read_csv</span><span class="p">(</span><span class="s">&quot;data/ATP_matches.csv&quot;</span><span class="p">)</span>
<span class="n">df_wta</span> <span class="o">=</span> <span class="nf">pd.read_csv</span><span class="p">(</span><span class="s">&quot;data/WTA_matches.csv&quot;</span><span class="p">)</span>
</code></pre></div>
<hr />
<h2 id="data-preprocessing">Data preprocessing<a class="headerlink" href="#data-preprocessing" title="Permanent link">&para;</a></h2>
<p>Filter the matches to hard and indoor hard only due to the fact that Australian Open is on hard surface and we want the models to train specifically for hard surfaces matches</p>
<p>Convert the columns in both datasets to the correct types. For example, we want to make sure the date columns are in the datetime format and numerial columns are either interger or floats. This will help reduce the memory in use and make the feature engineering process easier</p>
<div class="highlight"><pre><span></span><code><span class="c1">### Include hard and indoor hard only</span>
<span class="n">df_atp</span> <span class="o">=</span> <span class="n">df_atp.loc</span><span class="p">[</span><span class="nf">df_atp.Court_Surface.isin</span><span class="p">([</span><span class="s">&#39;Hard&#39;</span><span class="p">,</span><span class="s">&#39;Indoor Hard&#39;</span><span class="p">])]</span>
<span class="n">df_wta</span> <span class="o">=</span> <span class="n">df_wta.loc</span><span class="p">[</span><span class="nf">df_wta.Court_Surface.isin</span><span class="p">([</span><span class="s">&#39;Hard&#39;</span><span class="p">,</span><span class="s">&#39;Indoor Hard&#39;</span><span class="p">])]</span>

<span class="c1">### Exclude qualifying rounds</span>
<span class="n">df_atp</span> <span class="o">=</span> <span class="n">df_atp.loc</span><span class="p">[</span><span class="n">df_atp.Round_Description</span> <span class="o">!=</span> <span class="s">&#39;Qualifying&#39;</span><span class="p">]</span>
<span class="n">df_wta</span> <span class="o">=</span> <span class="n">df_wta.loc</span><span class="p">[</span><span class="n">df_wta.Round_Description</span> <span class="o">!=</span> <span class="s">&#39;Qualifying&#39;</span><span class="p">]</span>

<span class="c1"># Store the shape of the data for reference check later</span>
<span class="n">atp_shape</span> <span class="o">=</span> <span class="n">df_atp.shape</span>
<span class="n">wta_shape</span> <span class="o">=</span> <span class="n">df_wta.shape</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">numeric_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Winner_Rank&#39;</span><span class="p">,</span> <span class="s">&#39;Loser_Rank&#39;</span><span class="p">,</span> <span class="s">&#39;Retirement_Ind&#39;</span><span class="p">,</span>
                   <span class="s">&#39;Winner_Sets_Won&#39;</span><span class="p">,</span> <span class="s">&#39;Winner_Games_Won&#39;</span><span class="p">,</span> <span class="s">&#39;Winner_Aces&#39;</span><span class="p">,</span>
                   <span class="s">&#39;Winner_DoubleFaults&#39;</span><span class="p">,</span> <span class="s">&#39;Winner_FirstServes_Won&#39;</span><span class="p">,</span>
                   <span class="s">&#39;Winner_FirstServes_In&#39;</span><span class="p">,</span> <span class="s">&#39;Winner_SecondServes_Won&#39;</span><span class="p">,</span>
                   <span class="s">&#39;Winner_SecondServes_In&#39;</span><span class="p">,</span> <span class="s">&#39;Winner_BreakPoints_Won&#39;</span><span class="p">,</span>
                   <span class="s">&#39;Winner_BreakPoints&#39;</span><span class="p">,</span> <span class="s">&#39;Winner_ReturnPoints_Won&#39;</span><span class="p">,</span>
                   <span class="s">&#39;Winner_ReturnPoints_Faced&#39;</span><span class="p">,</span> <span class="s">&#39;Winner_TotalPoints_Won&#39;</span><span class="p">,</span> <span class="s">&#39;Loser_Sets_Won&#39;</span><span class="p">,</span>
                   <span class="s">&#39;Loser_Games_Won&#39;</span><span class="p">,</span> <span class="s">&#39;Loser_Aces&#39;</span><span class="p">,</span> <span class="s">&#39;Loser_DoubleFaults&#39;</span><span class="p">,</span>
                   <span class="s">&#39;Loser_FirstServes_Won&#39;</span><span class="p">,</span> <span class="s">&#39;Loser_FirstServes_In&#39;</span><span class="p">,</span>
                   <span class="s">&#39;Loser_SecondServes_Won&#39;</span><span class="p">,</span> <span class="s">&#39;Loser_SecondServes_In&#39;</span><span class="p">,</span>
                   <span class="s">&#39;Loser_BreakPoints_Won&#39;</span><span class="p">,</span> <span class="s">&#39;Loser_BreakPoints&#39;</span><span class="p">,</span> <span class="s">&#39;Loser_ReturnPoints_Won&#39;</span><span class="p">,</span>
                   <span class="s">&#39;Loser_ReturnPoints_Faced&#39;</span><span class="p">,</span> <span class="s">&#39;Loser_TotalPoints_Won&#39;</span><span class="p">]</span>

<span class="n">text_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Winner&#39;</span><span class="p">,</span> <span class="s">&#39;Loser&#39;</span><span class="p">,</span>  <span class="s">&#39;Tournament&#39;</span><span class="p">,</span> <span class="s">&#39;Court_Surface&#39;</span><span class="p">,</span><span class="s">&#39;Round_Description&#39;</span><span class="p">]</span> 

<span class="n">date_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Tournament_Date&#39;</span><span class="p">]</span>

<span class="c1"># we set the **erros** to coerce so any non-numerical values (text,special characters) will return an NA</span>
<span class="n">df_atp</span><span class="p">[</span><span class="n">numeric_columns</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_atp</span><span class="p">[</span><span class="n">numeric_columns</span><span class="p">]</span><span class="nf">.apply</span><span class="p">(</span><span class="n">pd.to_numeric</span><span class="p">,</span><span class="n">errors</span> <span class="o">=</span> <span class="s">&#39;coerce&#39;</span><span class="p">)</span>
<span class="n">df_wta</span><span class="p">[</span><span class="n">numeric_columns</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_wta</span><span class="p">[</span><span class="n">numeric_columns</span><span class="p">]</span><span class="nf">.apply</span><span class="p">(</span><span class="n">pd.to_numeric</span><span class="p">,</span><span class="n">errors</span> <span class="o">=</span> <span class="s">&#39;coerce&#39;</span><span class="p">)</span>


<span class="n">df_atp</span><span class="p">[</span><span class="n">date_columns</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_atp</span><span class="p">[</span><span class="n">date_columns</span><span class="p">]</span><span class="nf">.apply</span><span class="p">(</span><span class="n">pd.to_datetime</span><span class="p">)</span> 
<span class="n">df_wta</span><span class="p">[</span><span class="n">date_columns</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_wta</span><span class="p">[</span><span class="n">date_columns</span><span class="p">]</span><span class="nf">.apply</span><span class="p">(</span><span class="n">pd.to_datetime</span><span class="p">)</span>
</code></pre></div>
<hr />
<h2 id="feature-engineering">Feature Engineering<a class="headerlink" href="#feature-engineering" title="Permanent link">&para;</a></h2>
<p>The raw datasets are constructed in a way that each row will have the seperate stats for both the winner and loser of that match. However, we want to reshape the data so that each row we will only have one player randomly selected from the winner/loser columns and the features are the difference between opponents statistics (Difference of Averages), such as the difference between average first serve % in a single column rather than Player 1’s first serve % and Player 2’s first serve % in two separate columns.</p>
<p>In addition, for the features, we will take the rolling average of the player's most recent 15 matches before the particular tournament starts. For example, if the match is the second round of the Australian Open 2018, the features will be the last 15 matches before the first round of Australian Open 2018. The reason of not including the stats in the first round is that we would not have known the player's stats in the first round for the final submissions</p>
<p>A typical row of the transformed data will look like this – For a match between Player A – Roger Federer and Player B – Rafael Nadal, we will have a bunch of features like the difference in first serve %, difference in ELO rating etc. The target variable will be whether or not Player A wins (1=Player A wins and 0=lose).</p>
<p>The steps we take are:</p>
<ul>
<li>Convert the raw dataframes into long format:</li>
<li>Create some new features</li>
<li>
<p>Take the rolling average for each player and each match
    Since we will be only training our models on US Open and Australian Open, we will only be creating features for those matches. However, the rolling average will take into account any hard surface matches before those tournaments</p>
</li>
<li>
<p>Calculate the difference of averages for each match in the data frames</p>
</li>
</ul>
<hr />
<h2 id="convert-the-raw-dataframes-into-long-format">Convert the raw dataframes into long format:<a class="headerlink" href="#convert-the-raw-dataframes-into-long-format" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><span class="c1"># Before we split the dataframe into winner and loser, we want to create a feature that captures the total number of games the match takes.</span>
<span class="c1"># We have to do it before the split or we will lose this information</span>
<span class="n">df_atp</span><span class="p">[</span><span class="s">&#39;Total_Games&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_atp.Winner_Games_Won</span> <span class="o">+</span> <span class="n">df_atp.Loser_Games_Won</span>
<span class="n">df_wta</span><span class="p">[</span><span class="s">&#39;Total_Games&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_wta.Winner_Games_Won</span> <span class="o">+</span> <span class="n">df_wta.Loser_Games_Won</span>


<span class="c1"># Get the column names for the winner and loser stats</span>
<span class="n">winner_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="n">for</span> <span class="n">col</span> <span class="n">in</span> <span class="n">df_atp.columns</span> <span class="n">if</span> <span class="nf">col.startswith</span><span class="p">(</span><span class="s">&#39;Winner&#39;</span><span class="p">)]</span>
<span class="n">loser_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="n">for</span> <span class="n">col</span> <span class="n">in</span> <span class="n">df_atp.columns</span> <span class="n">if</span> <span class="nf">col.startswith</span><span class="p">(</span><span class="s">&#39;Loser&#39;</span><span class="p">)]</span>

<span class="c1"># create a winner dataframe to store the winner stats and a loser dataframe for the losers</span>
<span class="c1"># In addition to the winner and loser columns, we are adding common columns as well (e.g. tournamnt dates)</span>
<span class="n">common_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Total_Games&#39;</span><span class="p">,</span><span class="s">&#39;Tournament&#39;</span><span class="p">,</span><span class="s">&#39;Tournament_Date&#39;</span><span class="p">,</span> <span class="s">&#39;Court_Surface&#39;</span><span class="p">,</span><span class="s">&#39;Round_Description&#39;</span><span class="p">]</span>
<span class="n">df_winner_atp</span> <span class="o">=</span> <span class="n">df_atp</span><span class="p">[</span><span class="n">winner_cols</span> <span class="o">+</span> <span class="n">common_cols</span><span class="p">]</span>
<span class="n">df_loser_atp</span> <span class="o">=</span> <span class="n">df_atp</span><span class="p">[</span><span class="n">loser_cols</span> <span class="o">+</span> <span class="n">common_cols</span><span class="p">]</span>
<span class="n">df_winner_wta</span> <span class="o">=</span> <span class="n">df_wta</span><span class="p">[</span><span class="n">winner_cols</span> <span class="o">+</span> <span class="n">common_cols</span><span class="p">]</span>
<span class="n">df_loser_wta</span> <span class="o">=</span> <span class="n">df_wta</span><span class="p">[</span><span class="n">loser_cols</span> <span class="o">+</span> <span class="n">common_cols</span><span class="p">]</span>

<span class="c1"># Create a new column to show whether the player has won or not. </span>
<span class="n">df_winner_atp</span><span class="p">[</span><span class="s">&quot;won&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="m">1</span>
<span class="n">df_loser_atp</span><span class="p">[</span><span class="s">&quot;won&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="m">0</span>

<span class="n">df_winner_wta</span><span class="p">[</span><span class="s">&quot;won&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="m">1</span>
<span class="n">df_loser_wta</span><span class="p">[</span><span class="s">&quot;won&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="m">0</span>


<span class="c1"># Rename the columns for the winner and loser data frames so we can append them later on.</span>
<span class="c1"># We will rename the Winner_ / Loser_ columns to Player_</span>

<span class="n">new_column_names</span> <span class="o">=</span> <span class="p">[</span><span class="nf">col.replace</span><span class="p">(</span><span class="s">&#39;Winner&#39;</span><span class="p">,</span><span class="s">&#39;Player&#39;</span><span class="p">)</span> <span class="n">for</span> <span class="n">col</span> <span class="n">in</span> <span class="n">winner_cols</span><span class="p">]</span>

<span class="n">df_winner_atp.columns</span> <span class="o">=</span> <span class="n">new_column_names</span> <span class="o">+</span> <span class="n">common_cols</span> <span class="o">+</span> <span class="p">[</span><span class="s">&#39;won&#39;</span><span class="p">]</span>

<span class="c1"># They all should be the same</span>
<span class="n">df_loser_atp.columns</span>  <span class="o">=</span> <span class="n">df_winner_atp.columns</span>
<span class="n">df_winner_wta.columns</span>  <span class="o">=</span> <span class="n">df_winner_atp.columns</span>
<span class="n">df_loser_wta.columns</span>  <span class="o">=</span> <span class="n">df_winner_atp.columns</span>


<span class="c1"># append the winner and loser dataframes </span>

<span class="n">df_long_atp</span><span class="o">=</span> <span class="nf">df_winner_atp.append</span><span class="p">(</span><span class="n">df_loser_atp</span><span class="p">)</span>
<span class="n">df_long_wta</span><span class="o">=</span> <span class="nf">df_winner_wta.append</span><span class="p">(</span><span class="n">df_loser_wta</span><span class="p">)</span>
</code></pre></div>
<p>So now our dataframes are in long format and should looks like this</p>
<div class="highlight"><pre><span></span><code><span class="nf">df_long_atp.head</span><span class="p">()</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>Player</th>
<th>Player_Rank</th>
<th>Player_Sets_Won</th>
<th>Player_Games_Won</th>
<th>Player_Aces</th>
<th>Player_DoubleFaults</th>
<th>Player_FirstServes_Won</th>
<th>Player_FirstServes_In</th>
<th>Player_SecondServes_Won</th>
<th>Player_SecondServes_In</th>
<th>Player_BreakPoints_Won</th>
<th>Player_BreakPoints</th>
<th>Player_ReturnPoints_Won</th>
<th>Player_ReturnPoints_Faced</th>
<th>Player_TotalPoints_Won</th>
<th>Total_Games</th>
<th>Tournament</th>
<th>Tournament_Date</th>
<th>Court_Surface</th>
<th>Round_Description</th>
<th>won</th>
</tr>
</thead>
<tbody>
<tr>
<td>Edouard Roger-Vasselin</td>
<td>106.0</td>
<td>2.0</td>
<td>12</td>
<td>5.0</td>
<td>2.0</td>
<td>22</td>
<td>30</td>
<td>12</td>
<td>19</td>
<td>4.0</td>
<td>7.0</td>
<td>25.0</td>
<td>59.0</td>
<td>59</td>
<td>19</td>
<td>Chennai</td>
<td>2012-01-02</td>
<td>Hard</td>
<td>First Round</td>
<td>1</td>
</tr>
<tr>
<td>Dudi Sela</td>
<td>83.0</td>
<td>2.0</td>
<td>12</td>
<td>2.0</td>
<td>0.0</td>
<td>14</td>
<td>17</td>
<td>11</td>
<td>16</td>
<td>6.0</td>
<td>14.0</td>
<td>36.0</td>
<td>58.0</td>
<td>61</td>
<td>13</td>
<td>Chennai</td>
<td>2012-01-02</td>
<td>Hard</td>
<td>First Round</td>
<td>1</td>
</tr>
<tr>
<td>Go Soeda</td>
<td>120.0</td>
<td>2.0</td>
<td>19</td>
<td>6.0</td>
<td>1.0</td>
<td>48</td>
<td>64</td>
<td>19</td>
<td>39</td>
<td>5.0</td>
<td>11.0</td>
<td>42.0</td>
<td>105.0</td>
<td>109</td>
<td>33</td>
<td>Chennai</td>
<td>2012-01-02</td>
<td>Hard</td>
<td>First Round</td>
<td>1</td>
</tr>
<tr>
<td>Yuki Bhambri</td>
<td>345.0</td>
<td>2.0</td>
<td>12</td>
<td>1.0</td>
<td>2.0</td>
<td>22</td>
<td>29</td>
<td>9</td>
<td>17</td>
<td>5.0</td>
<td>13.0</td>
<td>34.0</td>
<td>62.0</td>
<td>65</td>
<td>17</td>
<td>Chennai</td>
<td>2012-01-02</td>
<td>Hard</td>
<td>First Round</td>
<td>1</td>
</tr>
<tr>
<td>Yuichi Sugita</td>
<td>235.0</td>
<td>2.0</td>
<td>12</td>
<td>3.0</td>
<td>1.0</td>
<td>37</td>
<td>51</td>
<td>11</td>
<td>27</td>
<td>3.0</td>
<td>7.0</td>
<td>22.0</td>
<td>54.0</td>
<td>70</td>
<td>19</td>
<td>Chennai</td>
<td>2012-01-02</td>
<td>Hard</td>
<td>First Round</td>
<td>1</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="create-some-new-features">Create some new features<a class="headerlink" href="#create-some-new-features" title="Permanent link">&para;</a></h2>
<p>Thinking about the dynamics of tennis, we know that players often will matches by “breaking” the opponent’s serve (i.e. winning a game when the opponent is serving). This is especially important in tennis. Let’s create a feature called Player_BreakPoints_Per_Game, which is the number of breakpoints a player gets per game that they play (even though they can only get breakpoints every second game, we will use total games). Let’s also create a feature called Player_Return_Win_Ratio which is the proportion of points won when returning.</p>
<p>Similarly, “holding” serve is important (i.e. winning a game when you are serving). Let’s create a feature called Player_Serve_Win_Ratio which is the proportion of points won when serving.</p>
<p>Finally, you only win a set of tennis by winning more sets than your opponent. To win a set, you need to win games. Let’s create a feature called Player_Game_Win_Percentage which is the propotion of games that a player wins.</p>
<p>So the four new features we will create are:</p>
<ul>
<li><code>Player_Serve_Win_Ratio</code></li>
<li><code>Player_Return_Win_Ratio</code></li>
<li><code>Player_BreakPoints_Per_Return_Game</code></li>
<li><code>Player_Game_Win_Percentage</code></li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># Here, we will define a function so we can apply it to both atp and wta dataframes</span>
<span class="n">def</span> <span class="nf">get_new_features</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">:</span>

    <span class="c1"># Input: </span>
<span class="c1">#     df: dataframe to get the data from</span>

     <span class="c1"># Return: the df with the new features</span>


    <span class="c1"># Point Win ratio when serving</span>
    <span class="n">df</span><span class="p">[</span><span class="s">&#39;Player_Serve_Win_Ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df.Player_FirstServes_Won</span> <span class="o">+</span> <span class="n">df.Player_SecondServes_Won</span> <span class="o">-</span> <span class="n">df.Player_DoubleFaults</span><span class="p">)</span> \
                                  <span class="o">/</span><span class="p">(</span><span class="n">df.Player_FirstServes_In</span> <span class="o">+</span> <span class="n">df.Player_SecondServes_In</span> <span class="o">+</span> <span class="n">df.Player_DoubleFaults</span><span class="p">)</span>
    <span class="c1"># Point win ratio when returning</span>
    <span class="n">df</span><span class="p">[</span><span class="s">&#39;Player_Return_Win_Ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df.Player_ReturnPoints_Won</span> <span class="o">/</span> <span class="n">df.Player_ReturnPoints_Faced</span>
    <span class="c1"># Breakpoints per receiving game</span>
    <span class="n">df</span><span class="p">[</span><span class="s">&#39;Player_BreakPoints_Per_Return_Game&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df.Player_BreakPoints</span><span class="o">/</span><span class="n">df.Total_Games</span>  
    <span class="n">df</span><span class="p">[</span><span class="s">&#39;Player_Game_Win_Percentage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df.Player_Games_Won</span><span class="o">/</span><span class="n">df.Total_Games</span>

    <span class="n">return</span> <span class="n">df</span>


<span class="c1"># Apply the function we just created to the long dataframes</span>
<span class="n">df_long_atp</span> <span class="o">=</span> <span class="nf">get_new_features</span><span class="p">(</span><span class="n">df_long_atp</span><span class="p">)</span>
<span class="n">df_long_wta</span> <span class="o">=</span> <span class="nf">get_new_features</span><span class="p">(</span><span class="n">df_long_wta</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># The long table should have exactly twice of the rows of the original data</span>
<span class="n">assert</span> <span class="n">df_long_atp.shape</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">atp_shape</span><span class="p">[</span><span class="m">0</span><span class="p">]</span><span class="o">*</span><span class="m">2</span>
<span class="n">assert</span> <span class="n">df_long_wta.shape</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">wta_shape</span><span class="p">[</span><span class="m">0</span><span class="p">]</span><span class="o">*</span><span class="m">2</span>
</code></pre></div>
<hr />
<h2 id="take-the-rolling-average-for-each-player-and-each-match">Take the rolling average for each player and each match<a class="headerlink" href="#take-the-rolling-average-for-each-player-and-each-match" title="Permanent link">&para;</a></h2>
<p>To train our models, we cannot simply use the player stats for that current match. In fact, we wont be able to use any stats from the same tournament. The logic behind this is that when we try to predict the results in 2019, we would not know the stats of any of the matches in the Australian Open 2019 tournament. As a result, we will use the players' past performance. Here, we will do a rolling average of the most recent 15 matches before the tournament.</p>
<p>To do the above, we will follow the steps below:</p>
<ol>
<li>List all the tournament dates for US and Australian Opens</li>
<li>Loop through the dates from point 1, for each date, we filter the data to only include matches before that date and take the most recent 15 games</li>
<li>Take the average of those 15 games</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="c1"># the two tournaments we will be using for training and thus the feature generation</span>
<span class="n">tournaments</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;U.S. Open, New York&#39;</span><span class="p">,</span><span class="s">&#39;Australian Open, Melbourne&#39;</span><span class="p">]</span>

<span class="c1"># Store the dates for the loops </span>
<span class="n">tournament_dates_atp</span> <span class="o">=</span> <span class="n">df_atp.loc</span><span class="p">[</span><span class="nf">df_atp.Tournament.isin</span><span class="p">(</span><span class="n">tournaments</span><span class="p">)]</span><span class="nf">.groupby</span><span class="p">([</span><span class="s">&#39;Tournament&#39;</span><span class="p">,</span><span class="s">&#39;Tournament_Date&#39;</span><span class="p">])</span> \
<span class="nf">.size</span><span class="p">()</span><span class="nf">.reset_index</span><span class="p">()[[</span><span class="s">&#39;Tournament&#39;</span><span class="p">,</span><span class="s">&#39;Tournament_Date&#39;</span><span class="p">]]</span>

<span class="n">tournament_dates_wta</span> <span class="o">=</span> <span class="n">df_wta.loc</span><span class="p">[</span><span class="nf">df_wta.Tournament.isin</span><span class="p">(</span><span class="n">tournaments</span><span class="p">)]</span><span class="nf">.groupby</span><span class="p">([</span><span class="s">&#39;Tournament&#39;</span><span class="p">,</span><span class="s">&#39;Tournament_Date&#39;</span><span class="p">])</span> \
<span class="nf">.size</span><span class="p">()</span><span class="nf">.reset_index</span><span class="p">()[[</span><span class="s">&#39;Tournament&#39;</span><span class="p">,</span><span class="s">&#39;Tournament_Date&#39;</span><span class="p">]]</span>


<span class="c1"># We are adding one more date for the final prediction</span>
<span class="n">tournament_dates_atp.loc</span><span class="p">[</span><span class="m">-1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Australian Open, Melbourne&#39;</span><span class="p">,</span><span class="nf">pd.to_datetime</span><span class="p">(</span><span class="s">&#39;2019-01-15&#39;</span><span class="p">)]</span>
<span class="n">tournament_dates_wta.loc</span><span class="p">[</span><span class="m">-1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Australian Open, Melbourne&#39;</span><span class="p">,</span><span class="nf">pd.to_datetime</span><span class="p">(</span><span class="s">&#39;2019-01-15&#39;</span><span class="p">)]</span>
</code></pre></div>
<p>Following are the dates for each tournament</p>
<div class="highlight"><pre><span></span><code><span class="n">tournament_dates_atp</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>Tournament</th>
<th>Tournament_Date</th>
</tr>
</thead>
<tbody>
<tr>
<td>Australian Open, Melbourne</td>
<td>2012-01-16</td>
</tr>
<tr>
<td>Australian Open, Melbourne</td>
<td>2013-01-1</td>
</tr>
<tr>
<td>Australian Open, Melbourne</td>
<td>2014-01-1</td>
</tr>
<tr>
<td>Australian Open, Melbourne</td>
<td>2015-01-1</td>
</tr>
<tr>
<td>Australian Open, Melbourne</td>
<td>2016-01-1</td>
</tr>
<tr>
<td>Australian Open, Melbourne</td>
<td>2017-01-1</td>
</tr>
<tr>
<td>Australian Open, Melbourne</td>
<td>2018-01-1</td>
</tr>
<tr>
<td>U.S. Open, New York</td>
<td>2012-08-2</td>
</tr>
<tr>
<td>U.S. Open, New York</td>
<td>2013-08-2</td>
</tr>
<tr>
<td>U.S. Open, New York</td>
<td>2014-08-25</td>
</tr>
<tr>
<td>U.S. Open, New York</td>
<td>2015-08-31</td>
</tr>
<tr>
<td>U.S. Open, New York</td>
<td>2016-08-29</td>
</tr>
<tr>
<td>U.S. Open, New York</td>
<td>2017-08-28</td>
</tr>
<tr>
<td>U.S. Open, New York</td>
<td>2018-08-27</td>
</tr>
<tr>
<td>Australian Open, Melbourne</td>
<td>2019-01-15</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><span class="n">tournament_dates_wta</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>Tournament</th>
<th>Tournament_Date</th>
</tr>
</thead>
<tbody>
<tr>
<td>Australian Open, Melbourne</td>
<td>2014-01-13</td>
</tr>
<tr>
<td>Australian Open, Melbourne</td>
<td>2015-01-19</td>
</tr>
<tr>
<td>Australian Open, Melbourne</td>
<td>2016-01-18</td>
</tr>
<tr>
<td>Australian Open, Melbourne</td>
<td>2017-01-16</td>
</tr>
<tr>
<td>Australian Open, Melbourne</td>
<td>2018-01-15</td>
</tr>
<tr>
<td>U.S. Open, New York</td>
<td>2014-08-25</td>
</tr>
<tr>
<td>U.S. Open, New York</td>
<td>2015-08-31</td>
</tr>
<tr>
<td>U.S. Open, New York</td>
<td>2016-08-29</td>
</tr>
<tr>
<td>U.S. Open, New York</td>
<td>2017-08-28</td>
</tr>
<tr>
<td>U.S. Open, New York</td>
<td>2018-08-27</td>
</tr>
<tr>
<td>Australian Open, Melbourne</td>
<td>2019-01-15</td>
</tr>
</tbody>
</table>
<p>They look fine but it is interesting that for men's, we have two more years of data from 2012 to 2013</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Let&#39;s define a function to calculate the rolling averages</span>
<span class="n">def</span> <span class="nf">get_rolling_features </span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">date_df</span><span class="o">=</span><span class="n">None</span><span class="p">,</span><span class="n">rolling_cols</span> <span class="o">=</span> <span class="n">None</span><span class="p">,</span> <span class="n">last_cols</span><span class="o">=</span> <span class="n">None</span><span class="p">)</span><span class="o">:</span>

    <span class="c1"># Input: </span>
<span class="c1">#     df: dataframe to get the data from</span>
<span class="c1">#     date_df: dataframe that has the start dates for each tournament</span>
<span class="c1">#     rolling_cols: columns to get the rolling averages</span>
<span class="c1">#     last_cols: columns to get the last value (most recent)</span>

     <span class="c1"># Return: the df with the new features</span>


    <span class="c1"># Sort the data by player and dates so the most recent matches are at the bottom</span>
    <span class="n">df</span> <span class="o">=</span> <span class="nf">df.sort_values</span><span class="p">([</span><span class="s">&#39;Player&#39;</span><span class="p">,</span><span class="s">&#39;Tournament_Date&#39;</span><span class="p">,</span><span class="s">&#39;Tournament&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="n">True</span><span class="p">)</span>

    <span class="c1"># For each tournament, get the rolling averages of that player&#39;s past matches before the tournament start date</span>
    <span class="n">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">tournament_date</span> <span class="n">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">date_df.Tournament_Date</span><span class="p">)</span><span class="o">:</span>
        <span class="c1"># create a temp df to store the interim results</span>
        <span class="n">df_temp</span> <span class="o">=</span> <span class="n">df.loc</span><span class="p">[</span><span class="n">df.Tournament_Date</span> <span class="o">&lt;</span> <span class="n">tournament_date</span><span class="p">]</span>

        <span class="c1"># for ranks, we only take the last one. (comment this out if want to take avg of rank)</span>
        <span class="n">df_temp_last</span> <span class="o">=</span> <span class="nf">df_temp.groupby</span><span class="p">(</span><span class="s">&#39;Player&#39;</span><span class="p">)[</span><span class="n">last_cols</span><span class="p">]</span><span class="nf">.last</span><span class="p">()</span><span class="nf">.reset_index</span><span class="p">()</span>

        <span class="c1"># take the most recent 15 matches for the rolling average</span>
        <span class="n">df_temp</span> <span class="o">=</span> <span class="nf">df_temp.groupby</span><span class="p">(</span><span class="s">&#39;Player&#39;</span><span class="p">)[</span><span class="n">rolling_cols</span><span class="p">]</span><span class="nf">.rolling</span><span class="p">(</span><span class="m">15</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="m">1</span><span class="p">)</span><span class="nf">.mean</span><span class="p">()</span><span class="nf">.reset_index</span><span class="p">()</span>
        <span class="n">df_temp</span> <span class="o">=</span> <span class="nf">df_temp.groupby</span><span class="p">(</span><span class="s">&#39;Player&#39;</span><span class="p">)</span><span class="nf">.tail</span><span class="p">(</span><span class="m">1</span><span class="p">)</span> <span class="c1"># take the last row of the above</span>

        <span class="n">df_temp</span><span class="o">=</span> <span class="nf">df_temp.merge</span><span class="p">(</span><span class="n">df_temp_last</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s">&#39;Player&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s">&#39;left&#39;</span><span class="p">)</span>

        <span class="n">if</span> <span class="n">index</span> <span class="o">==</span><span class="m">0</span><span class="o">:</span>
            <span class="n">df_result</span> <span class="o">=</span> <span class="n">df_temp</span>
            <span class="n">df_result</span><span class="p">[</span><span class="s">&#39;tournament_date_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tournament_date</span> <span class="c1"># so we know which tournament this feature is for</span>
        <span class="n">else</span><span class="o">:</span>
            <span class="n">df_temp</span><span class="p">[</span><span class="s">&#39;tournament_date_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tournament_date</span>
            <span class="n">df_result</span> <span class="o">=</span> <span class="nf">df_result.append</span><span class="p">(</span><span class="n">df_temp</span><span class="p">)</span>

    <span class="nf">df_result.drop</span><span class="p">(</span><span class="s">&#39;level_1&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="n">True</span><span class="p">)</span>

    <span class="n">return</span> <span class="n">df_result</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># columns we are applying the rolling averages on</span>
<span class="n">rolling_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Player_Serve_Win_Ratio&#39;</span><span class="p">,</span> <span class="s">&#39;Player_Return_Win_Ratio&#39;</span><span class="p">,</span>
               <span class="s">&#39;Player_BreakPoints_Per_Return_Game&#39;</span><span class="p">,</span> <span class="s">&#39;Player_Game_Win_Percentage&#39;</span><span class="p">]</span>

<span class="c1"># columns we are taking the most recent values on</span>
<span class="c1"># For the player rank, we think we can just use the latest rank (before the tournament starts) </span>
<span class="c1"># as it should refect the most recent performance of the player</span>
<span class="n">last_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Player_Rank&#39;</span><span class="p">]</span>


<span class="c1"># Apply the rolling average function to the long dataframes (it will take a few mins to run)</span>
<span class="n">df_rolling_atp</span> <span class="o">=</span> <span class="nf">get_rolling_features </span><span class="p">(</span><span class="n">df_long_atp</span><span class="p">,</span> <span class="n">tournament_dates_atp</span><span class="p">,</span> <span class="n">rolling_cols</span><span class="p">,</span> <span class="n">last_cols</span><span class="o">=</span> <span class="n">last_cols</span> <span class="p">)</span>
<span class="n">df_rolling_wta</span> <span class="o">=</span> <span class="nf">get_rolling_features </span><span class="p">(</span><span class="n">df_long_wta</span><span class="p">,</span> <span class="n">tournament_dates_wta</span><span class="p">,</span> <span class="n">rolling_cols</span><span class="p">,</span> <span class="n">last_cols</span><span class="o">=</span> <span class="n">last_cols</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="nf">df_rolling_atp.head</span><span class="p">(</span><span class="m">2</span><span class="p">)</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>Player</th>
<th>Player_Serve_Win_Ratio</th>
<th>Player_Return_Win_Ratio</th>
<th>Player_BreakPoints_Per_Return_Game</th>
<th>Player_Game_Win_Percentage</th>
<th>Player_Rank</th>
<th>tournament_date_index</th>
</tr>
</thead>
<tbody>
<tr>
<td>Adrian Mannarino</td>
<td>0.623408</td>
<td>0.353397</td>
<td>0.257859</td>
<td>0.447246</td>
<td>87.0</td>
<td>2012-01-16</td>
</tr>
<tr>
<td>Albert Montanes</td>
<td>0.507246</td>
<td>0.195652</td>
<td>0.000000</td>
<td>0.294118</td>
<td>50.0</td>
<td>2012-01-16</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><span class="nf">df_rolling_wta.head</span><span class="p">(</span><span class="m">2</span><span class="p">)</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>Player</th>
<th>Player_Serve_Win_Ratio</th>
<th>Player_Return_Win_Ratio</th>
<th>Player_BreakPoints_Per_Return_Game</th>
<th>Player_Game_Win_Percentage</th>
<th>Player_Rank</th>
<th>tournament_date_index</th>
</tr>
</thead>
<tbody>
<tr>
<td>Agnieszka Radwanska</td>
<td>0.413333</td>
<td>0.475410</td>
<td>0.350000</td>
<td>0.350000</td>
<td>5.0</td>
<td>2014-01-13</td>
</tr>
<tr>
<td>Ajla Tomljanovic</td>
<td>0.468457</td>
<td>0.407319</td>
<td>0.242253</td>
<td>0.462634</td>
<td>75.0</td>
<td>2014-01-13</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="calculate-the-difference-of-averages-for-each-match-in-the-data-frames">Calculate the difference of averages for each match in the data frames<a class="headerlink" href="#calculate-the-difference-of-averages-for-each-match-in-the-data-frames" title="Permanent link">&para;</a></h2>
<p>In the original data frames, the first column is always the winner and followed by the loser. Same for the player stats. Thus, we cannot simply calculate the difference between winner and loser and create a target variable indicating player 1 will win or not because it will always be the winner in this case (target always = 1). As a result, we need to pick a player randomly so the player might or might not be the winner</p>
<p>In addition, instead of using both the features for player 1 and 2, we will take the difference of averages between the randomised player 1 and 2. The main benefit is that it will reduce the number of features to half</p>
<p>Steps:</p>
<ol>
<li>We will create a random number for each player which only return 0 or 1</li>
<li>If it is zero, we will assign the winner to player 1 and loser to player 2</li>
<li>We will join the features to the player 1 and 2. The join will be on the player names and the tournament date (tournament_index in the feature dataframes)</li>
<li>For players who do not have any history, we will fill the stats by zeros and rank by 999</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="c1"># Randomise the match_wide dataset so the first player is not always the winner</span>

<span class="c1"># set a seed so the random number is reproducable</span>
<span class="nf">np.random.seed</span><span class="p">(</span><span class="m">2</span><span class="p">)</span>

<span class="c1"># randomise a number 0/1 with 50% chance each</span>
<span class="c1"># if 0 then take the winner, 1 then take loser</span>

<span class="n">df_atp</span><span class="p">[</span><span class="s">&#39;random_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nf">np.random.randint</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="nf">len</span><span class="p">(</span><span class="n">df_atp</span><span class="p">))</span>
<span class="n">df_atp</span><span class="p">[</span><span class="s">&#39;randomised_player_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nf">np.where</span><span class="p">(</span><span class="n">df_atp</span><span class="p">[</span><span class="s">&#39;random_number&#39;</span><span class="p">]</span><span class="o">==</span><span class="m">0</span><span class="p">,</span><span class="n">df_atp</span><span class="p">[</span><span class="s">&#39;Winner&#39;</span><span class="p">],</span><span class="n">df_atp</span><span class="p">[</span><span class="s">&#39;Loser&#39;</span><span class="p">])</span>
<span class="n">df_atp</span><span class="p">[</span><span class="s">&#39;randomised_player_2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nf">np.where</span><span class="p">(</span><span class="n">df_atp</span><span class="p">[</span><span class="s">&#39;random_number&#39;</span><span class="p">]</span><span class="o">==</span><span class="m">0</span><span class="p">,</span><span class="n">df_atp</span><span class="p">[</span><span class="s">&#39;Loser&#39;</span><span class="p">],</span><span class="n">df_atp</span><span class="p">[</span><span class="s">&#39;Winner&#39;</span><span class="p">])</span>

<span class="n">df_wta</span><span class="p">[</span><span class="s">&#39;random_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nf">np.random.randint</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="nf">len</span><span class="p">(</span><span class="n">df_wta</span><span class="p">))</span>
<span class="n">df_wta</span><span class="p">[</span><span class="s">&#39;randomised_player_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nf">np.where</span><span class="p">(</span><span class="n">df_wta</span><span class="p">[</span><span class="s">&#39;random_number&#39;</span><span class="p">]</span><span class="o">==</span><span class="m">0</span><span class="p">,</span><span class="n">df_wta</span><span class="p">[</span><span class="s">&#39;Winner&#39;</span><span class="p">],</span><span class="n">df_wta</span><span class="p">[</span><span class="s">&#39;Loser&#39;</span><span class="p">])</span>
<span class="n">df_wta</span><span class="p">[</span><span class="s">&#39;randomised_player_2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nf">np.where</span><span class="p">(</span><span class="n">df_wta</span><span class="p">[</span><span class="s">&#39;random_number&#39;</span><span class="p">]</span><span class="o">==</span><span class="m">0</span><span class="p">,</span><span class="n">df_wta</span><span class="p">[</span><span class="s">&#39;Loser&#39;</span><span class="p">],</span><span class="n">df_wta</span><span class="p">[</span><span class="s">&#39;Winner&#39;</span><span class="p">])</span>

<span class="c1"># set the target (win/loss) based on the new randomise number</span>
<span class="n">df_atp</span><span class="p">[</span><span class="s">&#39;player_1_win&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nf">np.where</span><span class="p">(</span><span class="n">df_atp</span><span class="p">[</span><span class="s">&#39;random_number&#39;</span><span class="p">]</span><span class="o">==</span><span class="m">0</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">0</span><span class="p">)</span>
<span class="n">df_wta</span><span class="p">[</span><span class="s">&#39;player_1_win&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nf">np.where</span><span class="p">(</span><span class="n">df_wta</span><span class="p">[</span><span class="s">&#39;random_number&#39;</span><span class="p">]</span><span class="o">==</span><span class="m">0</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">0</span><span class="p">)</span>


<span class="nf">print </span><span class="p">(</span><span class="s">&#39;After shuffling, the win rate for player 1 for the mens is {}%&#39;</span><span class="nf">.format</span><span class="p">(</span><span class="n">df_atp</span><span class="p">[</span><span class="s">&#39;player_1_win&#39;</span><span class="p">]</span><span class="nf">.mean</span><span class="p">()</span><span class="o">*</span><span class="m">100</span><span class="p">))</span>
<span class="nf">print </span><span class="p">(</span><span class="s">&#39;After shuffling, the win rate for player 1 for the womens is {}%&#39;</span><span class="nf">.format</span><span class="p">(</span><span class="n">df_wta</span><span class="p">[</span><span class="s">&#39;player_1_win&#39;</span><span class="p">]</span><span class="nf">.mean</span><span class="p">()</span><span class="o">*</span><span class="m">100</span><span class="p">))</span>
</code></pre></div>
<p>After shuffling, the win rate for player 1 for the mens is 49.64798919857267%
After shuffling, the win rate for player 1 for the womens is 49.697671426733564%
The win rates are close enough to 50%. So we are good to go</p>
<div class="highlight"><pre><span></span><code><span class="c1"># To get our dataframes ready for model training, we will exclude other tournaments from the data now because we have gotten the rolling averages from them and </span>
<span class="c1"># for training, we only need US and Australian Open matches</span>
<span class="n">df_atp</span> <span class="o">=</span> <span class="n">df_atp.loc</span><span class="p">[</span><span class="nf">df_atp.Tournament.isin</span><span class="p">(</span><span class="n">tournaments</span><span class="p">)]</span>
<span class="n">df_wta</span> <span class="o">=</span> <span class="n">df_wta.loc</span><span class="p">[</span><span class="nf">df_wta.Tournament.isin</span><span class="p">(</span><span class="n">tournaments</span><span class="p">)]</span>

<span class="c1"># now we can remove other stats columns because we will be using the differences</span>
<span class="n">cols_to_keep</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Winner&#39;</span><span class="p">,</span><span class="s">&#39;Loser&#39;</span><span class="p">,</span><span class="s">&#39;Tournament&#39;</span><span class="p">,</span><span class="s">&#39;Tournament_Date&#39;</span><span class="p">,</span>
                    <span class="s">&#39;player_1_win&#39;</span><span class="p">,</span><span class="s">&#39;randomised_player_1&#39;</span><span class="p">,</span>
                    <span class="s">&#39;randomised_player_2&#39;</span><span class="p">]</span>

<span class="n">df_atp</span> <span class="o">=</span> <span class="n">df_atp</span><span class="p">[</span><span class="n">cols_to_keep</span><span class="p">]</span>
<span class="n">df_wta</span> <span class="o">=</span> <span class="n">df_wta</span><span class="p">[</span><span class="n">cols_to_keep</span><span class="p">]</span>


<span class="c1"># Here, we are joining the rolling average dataframes to the individual matches. </span>
<span class="c1"># We need to do it twice. One for player 1 and one for player 2</span>

<span class="c1"># Get the rolling features for player 1</span>
<span class="n">df_atp</span> <span class="o">=</span> <span class="nf">df_atp.merge</span><span class="p">(</span><span class="n">df_rolling_atp</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s">&#39;left&#39;</span><span class="p">,</span>
                      <span class="n">left_on</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;randomised_player_1&#39;</span><span class="p">,</span><span class="s">&#39;Tournament_Date&#39;</span><span class="p">],</span>
                      <span class="n">right_on</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Player&#39;</span><span class="p">,</span><span class="s">&#39;tournament_date_index&#39;</span><span class="p">],</span>
                      <span class="n">validate</span> <span class="o">=</span><span class="s">&#39;m:1&#39;</span><span class="p">)</span>

<span class="n">df_wta</span> <span class="o">=</span> <span class="nf">df_wta.merge</span><span class="p">(</span><span class="n">df_rolling_wta</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s">&#39;left&#39;</span><span class="p">,</span>
                      <span class="n">left_on</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;randomised_player_1&#39;</span><span class="p">,</span><span class="s">&#39;Tournament_Date&#39;</span><span class="p">],</span>
                      <span class="n">right_on</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Player&#39;</span><span class="p">,</span><span class="s">&#39;tournament_date_index&#39;</span><span class="p">],</span>
                      <span class="n">validate</span> <span class="o">=</span><span class="s">&#39;m:1&#39;</span><span class="p">)</span>

<span class="c1"># Get the rolling features for player 2</span>
<span class="c1"># we will use &#39;_p1&#39; to denote player 1 and &#39;_p2&#39; for player 2</span>
<span class="n">df_atp</span> <span class="o">=</span> <span class="nf">df_atp.merge</span><span class="p">(</span><span class="n">df_rolling_atp</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s">&#39;left&#39;</span><span class="p">,</span>
                      <span class="n">left_on</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;randomised_player_2&#39;</span><span class="p">,</span><span class="s">&#39;Tournament_Date&#39;</span><span class="p">],</span>
                      <span class="n">right_on</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Player&#39;</span><span class="p">,</span><span class="s">&#39;tournament_date_index&#39;</span><span class="p">],</span>
                      <span class="n">validate</span> <span class="o">=</span><span class="s">&#39;m:1&#39;</span><span class="p">,</span>
                      <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;_p1&#39;</span><span class="p">,</span><span class="s">&#39;_p2&#39;</span><span class="p">))</span>

<span class="n">df_wta</span> <span class="o">=</span> <span class="nf">df_wta.merge</span><span class="p">(</span><span class="n">df_rolling_wta</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s">&#39;left&#39;</span><span class="p">,</span>
                      <span class="n">left_on</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;randomised_player_2&#39;</span><span class="p">,</span><span class="s">&#39;Tournament_Date&#39;</span><span class="p">],</span>
                      <span class="n">right_on</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Player&#39;</span><span class="p">,</span><span class="s">&#39;tournament_date_index&#39;</span><span class="p">],</span>
                      <span class="n">validate</span> <span class="o">=</span><span class="s">&#39;m:1&#39;</span><span class="p">,</span>
                      <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;_p1&#39;</span><span class="p">,</span><span class="s">&#39;_p2&#39;</span><span class="p">))</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># How many players do not have previous match history</span>
<span class="nf">print</span><span class="p">(</span><span class="s">&#39;{} player_1s do Not have previous match history before the tournament&#39;</span><span class="nf">.format</span><span class="p">(</span><span class="n">df_atp.loc</span><span class="p">[</span><span class="nf">df_atp.Player_p1.isna</span><span class="p">(),</span><span class="s">&#39;randomised_player_1&#39;</span><span class="p">]</span><span class="nf">.nunique</span><span class="p">()))</span>
<span class="nf">print</span><span class="p">(</span><span class="s">&#39;{} player_2s do Not have previous match history before the tournament&#39;</span><span class="nf">.format</span><span class="p">(</span><span class="n">df_atp.loc</span><span class="p">[</span><span class="nf">df_atp.Player_p2.isna</span><span class="p">(),</span><span class="s">&#39;randomised_player_2&#39;</span><span class="p">]</span><span class="nf">.nunique</span><span class="p">()))</span>
</code></pre></div>
<p>59 player_1s do Not have previous match history before the tournament
56 player_2s do Not have previous match history before the tournament</p>
<div class="highlight"><pre><span></span><code><span class="c1"># How many players do not have previous match history</span>
<span class="nf">print</span><span class="p">(</span><span class="s">&#39;{} player_1s do Not have previous match history before the tournament&#39;</span><span class="nf">.format</span><span class="p">(</span><span class="n">df_wta.loc</span><span class="p">[</span><span class="nf">df_wta.Player_p1.isna</span><span class="p">(),</span><span class="s">&#39;randomised_player_1&#39;</span><span class="p">]</span><span class="nf">.nunique</span><span class="p">()))</span>
<span class="nf">print</span><span class="p">(</span><span class="s">&#39;{} player_2s do Not have previous match history before the tournament&#39;</span><span class="nf">.format</span><span class="p">(</span><span class="n">df_wta.loc</span><span class="p">[</span><span class="nf">df_wta.Player_p2.isna</span><span class="p">(),</span><span class="s">&#39;randomised_player_2&#39;</span><span class="p">]</span><span class="nf">.nunique</span><span class="p">()))</span>
</code></pre></div>
<p>41 player_1s do Not have previous match history before the tournament
37 player_2s do Not have previous match history before the tournament</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Most of the missing are for the early years which makes sense as we dont have enough history for them</span>
<span class="n">df_wta.loc</span><span class="p">[</span><span class="nf">df_wta.Player_p1.isna</span><span class="p">(),</span><span class="s">&#39;Tournament_Date&#39;</span><span class="p">]</span><span class="nf">.value_counts</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>2014-01-13    29
2014-08-25     7
2015-08-31     5
2015-01-19     3
2017-08-28     3
2018-01-15     3
2018-08-27     3
Name: Tournament_Date, dtype: int64
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">df_atp.loc</span><span class="p">[</span><span class="nf">df_atp.Player_p1.isna</span><span class="p">(),</span><span class="s">&#39;Tournament_Date&#39;</span><span class="p">]</span><span class="nf">.value_counts</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>2012-01-16    29
2012-08-27     9
2014-01-13     5
2013-08-26     5
2016-01-18     5
2013-01-14     4
2014-08-25     3
2018-01-15     3
2017-08-28     3
2018-08-27     2
2016-08-29     2
2015-01-19     1
Name: Tournament_Date, dtype: int64
</code></pre></div>
<p>Now we have gotten the rolling averages for both player 1 and 2. What we need to do next is to simply calculat their difference.</p>
<p>To calculate the difference, we need to:</p>
<ol>
<li>Split the dataframes into two new dataframes: Player 1 and Player 2</li>
<li>Take the difference between the two dataframes</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="n">def</span> <span class="nf">get_player_difference</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">diff_cols</span> <span class="o">=</span> <span class="n">None</span><span class="p">)</span><span class="o">:</span>

        <span class="c1"># Input: </span>
<span class="c1">#     df: dataframe to get the data from</span>
<span class="c1">#     diff_cols: columns we take the difference on. For example is diff_cols = win rate. This function will calculate the </span>
<span class="c1">#                difference of the win rates between player 1 and player 2</span>

     <span class="c1"># Return: the df with the new features</span>

    <span class="n">p1_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="s">&#39;_p1&#39;</span> <span class="n">for</span> <span class="n">i</span> <span class="n">in</span> <span class="n">diff_cols</span><span class="p">]</span> <span class="c1"># column names for player 1 stats</span>
    <span class="n">p2_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="s">&#39;_p2&#39;</span> <span class="n">for</span> <span class="n">i</span> <span class="n">in</span> <span class="n">diff_cols</span><span class="p">]</span> <span class="c1"># column names for player 2 stats</span>


    <span class="c1"># For any missing values, we will fill them by zeros except the ranking where we will use 999</span>
    <span class="n">df</span><span class="p">[</span><span class="s">&#39;Player_Rank_p1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">&#39;Player_Rank_p1&#39;</span><span class="p">]</span><span class="nf">.fillna</span><span class="p">(</span><span class="m">999</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="n">p1_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">p1_cols</span><span class="p">]</span><span class="nf">.fillna</span><span class="p">(</span><span class="m">0</span><span class="p">)</span>

    <span class="n">df</span><span class="p">[</span><span class="s">&#39;Player_Rank_p2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">&#39;Player_Rank_p2&#39;</span><span class="p">]</span><span class="nf">.fillna</span><span class="p">(</span><span class="m">999</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="n">p2_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">p2_cols</span><span class="p">]</span><span class="nf">.fillna</span><span class="p">(</span><span class="m">0</span><span class="p">)</span>


    <span class="n">new_column_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="s">&#39;_diff&#39;</span> <span class="n">for</span> <span class="n">i</span> <span class="n">in</span> <span class="n">diff_cols</span><span class="p">]</span>

    <span class="c1"># Take the difference</span>
    <span class="n">df_p1</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">p1_cols</span><span class="p">]</span>
    <span class="n">df_p2</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">p2_cols</span><span class="p">]</span>

    <span class="n">df_p1.columns</span><span class="o">=</span><span class="n">new_column_name</span>
    <span class="n">df_p2.columns</span><span class="o">=</span><span class="n">new_column_name</span>

    <span class="n">df_diff</span> <span class="o">=</span> <span class="n">df_p1</span> <span class="o">-</span> <span class="n">df_p2</span>
    <span class="n">df_diff.columns</span> <span class="o">=</span> <span class="n">new_column_name</span>

    <span class="c1"># drop the p1 and p2 columns because We have the differences now</span>
    <span class="nf">df.drop</span><span class="p">(</span><span class="n">p1_cols</span> <span class="o">+</span> <span class="n">p2_cols</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="m">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="n">True</span><span class="p">)</span>

    <span class="c1"># Concat the df_diff and raw_df</span>
    <span class="n">df</span> <span class="o">=</span> <span class="nf">pd.concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">df_diff</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="m">1</span><span class="p">)</span>

    <span class="n">return</span> <span class="n">df</span><span class="p">,</span><span class="n">new_column_name</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">diff_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Player_Serve_Win_Ratio&#39;</span><span class="p">,</span>
            <span class="s">&#39;Player_Return_Win_Ratio&#39;</span><span class="p">,</span>
            <span class="s">&#39;Player_BreakPoints_Per_Return_Game&#39;</span><span class="p">,</span>
            <span class="s">&#39;Player_Game_Win_Percentage&#39;</span><span class="p">,</span><span class="s">&#39;Player_Rank&#39;</span><span class="p">]</span>

<span class="c1"># Apply the function and get the difference between player 1 and 2</span>
<span class="n">df_atp</span><span class="p">,</span>_ <span class="o">=</span> <span class="nf">get_player_difference</span><span class="p">(</span><span class="n">df_atp</span><span class="p">,</span><span class="n">diff_cols</span><span class="o">=</span><span class="n">diff_cols</span><span class="p">)</span>
<span class="n">df_wta</span><span class="p">,</span>_ <span class="o">=</span> <span class="nf">get_player_difference</span><span class="p">(</span><span class="n">df_wta</span><span class="p">,</span><span class="n">diff_cols</span><span class="o">=</span><span class="n">diff_cols</span><span class="p">)</span>

<span class="c1"># Make a copy of the dataframes in case we need to come back to check the values</span>
<span class="n">df_atp_final</span> <span class="o">=</span> <span class="nf">df_atp.copy</span><span class="p">()</span>
<span class="n">df_wta_final</span> <span class="o">=</span> <span class="nf">df_wta.copy</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="nf">df_atp_final.head</span><span class="p">()</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>Winner</th>
<th>Loser</th>
<th>Tournament</th>
<th>Tournament_Date</th>
<th>player_1_win</th>
<th>randomised_player_1</th>
<th>randomised_player_2</th>
<th>Player_p1</th>
<th>tournament_date_index_p1</th>
<th>Player_p2</th>
<th>tournament_date_index_p2</th>
<th>Player_Serve_Win_Ratio_diff</th>
<th>Player_Return_Win_Ratio_diff</th>
<th>Player_BreakPoints_Per_Return_Game_diff</th>
<th>Player_Game_Win_Percentage_diff</th>
<th>Player_Rank_diff</th>
</tr>
</thead>
<tbody>
<tr>
<td>Juan Martin del Potro</td>
<td>Adrian Mannarino</td>
<td>Australian Open, Melbourne</td>
<td>2012-01-16</td>
<td>1</td>
<td>Juan Martin del Potro</td>
<td>Adrian Mannarino</td>
<td>Juan Martin del Potro</td>
<td>2012-01-16</td>
<td>Adrian Mannarino</td>
<td>2012-01-16</td>
<td>0.035030</td>
<td>-0.021271</td>
<td>-0.025975</td>
<td>0.103479</td>
<td>-76.0</td>
</tr>
<tr>
<td>Pere Riba</td>
<td>Albert Montanes</td>
<td>Australian Open, Melbourne</td>
<td>2012-01-16</td>
<td>1</td>
<td>Pere Riba</td>
<td>Albert Montanes</td>
<td>Pere Riba</td>
<td>2012-01-16</td>
<td>Albert Montanes</td>
<td>2012-01-16</td>
<td>-0.156369</td>
<td>0.008893</td>
<td>0.066667</td>
<td>-0.094118</td>
<td>39.0</td>
</tr>
<tr>
<td>Tomas Berdych</td>
<td>Albert Ramos-Vinolas</td>
<td>Australian Open, Melbourne</td>
<td>2012-01-16</td>
<td>0</td>
<td>Albert Ramos-Vinolas</td>
<td>Tomas Berdych</td>
<td>Albert Ramos-Vinolas</td>
<td>2012-01-16</td>
<td>NaN</td>
<td>NaT</td>
<td>0.498027</td>
<td>0.380092</td>
<td>0.414815</td>
<td>0.394444</td>
<td>-934.0</td>
</tr>
<tr>
<td>Rafael Nadal</td>
<td>Alex Kuznetsov</td>
<td>Australian Open, Melbourne</td>
<td>2012-01-16</td>
<td>0</td>
<td>Alex Kuznetsov</td>
<td>Rafael Nadal</td>
<td>NaN</td>
<td>NaT</td>
<td>Rafael Nadal</td>
<td>2012-01-16</td>
<td>-0.670139</td>
<td>-0.423057</td>
<td>-0.445623</td>
<td>-0.574767</td>
<td>997.0</td>
</tr>
<tr>
<td>Roger Federer</td>
<td>Alexander Kudryavtsev</td>
<td>Australian Open, Melbourne</td>
<td>2012-01-16</td>
<td>0</td>
<td>Alexander Kudryavtsev</td>
<td>Roger Federer</td>
<td>NaN</td>
<td>NaT</td>
<td>Roger Federer</td>
<td>2012-01-16</td>
<td>-0.721415</td>
<td>-0.449516</td>
<td>-0.360255</td>
<td>-0.668090</td>
<td>996.0</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="modelling">Modelling<a class="headerlink" href="#modelling" title="Permanent link">&para;</a></h2>
<p>We will trian two models here, one for mens and one for womens.</p>
<p>For training, we will use all available data from the second year (too many missing values in the first year) up until 2017.</p>
<p>For validation, we will test the model on the 2018 Australian Open data</p>
<p>This setup allows us to 'mimic' the final prediction (using historical matches to predict 2019 results)</p>
<div class="highlight"><pre><span></span><code><span class="n">df_train_atp</span> <span class="o">=</span> <span class="n">df_atp_final.loc</span><span class="p">[(</span><span class="n">df_atp_final.Tournament_Date</span> <span class="o">!=</span> <span class="s">&#39;2018-01-15&#39;</span><span class="p">)</span> <span class="c1"># excluding Aus Open 2018, and</span>
                                <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_atp_final.Tournament_Date</span> <span class="o">&gt;</span> <span class="s">&#39;2012-01-16&#39;</span><span class="p">)]</span> <span class="c1"># excluding first year</span>
<span class="n">df_valid_atp</span> <span class="o">=</span> <span class="n">df_atp_final.loc</span><span class="p">[</span><span class="n">df_atp_final.Tournament_Date</span> <span class="o">==</span> <span class="s">&#39;2018-01-15&#39;</span><span class="p">]</span> <span class="c1"># Australian Open 2018 only</span>

<span class="n">df_train_wta</span> <span class="o">=</span> <span class="n">df_wta_final.loc</span><span class="p">[(</span><span class="n">df_wta_final.Tournament_Date</span> <span class="o">!=</span> <span class="s">&#39;2018-01-15&#39;</span><span class="p">)</span> <span class="c1"># excluding Aus Open 2018, and</span>
                                <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_wta_final.Tournament_Date</span> <span class="o">&gt;</span> <span class="s">&#39;2014-01-13&#39;</span><span class="p">)]</span> <span class="c1"># excluding first year</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="nf">df_train_atp.head</span><span class="p">()</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>Winner</th>
<th>Loser</th>
<th>Tournament</th>
<th>Tournament_Date</th>
<th>player_1_win</th>
<th>randomised_player_1</th>
<th>randomised_player_2</th>
<th>Player_p1</th>
<th>tournament_date_index_p1</th>
<th>Player_p2</th>
<th>tournament_date_index_p2</th>
<th>Player_Serve_Win_Ratio_diff</th>
<th>Player_Return_Win_Ratio_diff</th>
<th>Player_BreakPoints_Per_Return_Game_diff</th>
<th>Player_Game_Win_Percentage_diff</th>
<th>Player_Rank_diff</th>
</tr>
</thead>
<tbody>
<tr>
<td>Daniel Brands</td>
<td>Adrian Ungur</td>
<td>U.S. Open, New York</td>
<td>2012-08-27</td>
<td>0</td>
<td>Adrian Ungur</td>
<td>Daniel Brands</td>
<td>NaN</td>
<td>NaT</td>
<td>Daniel Brands</td>
<td>2012-08-27</td>
<td>-0.535211</td>
<td>-0.300000</td>
<td>-0.043478</td>
<td>-0.434783</td>
<td>870.0</td>
</tr>
<tr>
<td>Richard Gasquet</td>
<td>Albert Montanes</td>
<td>U.S. Open, New York</td>
<td>2012-08-27</td>
<td>1</td>
<td>Richard Gasquet</td>
<td>Albert Montanes</td>
<td>Richard Gasquet</td>
<td>2012-08-27</td>
<td>Albert Montanes</td>
<td>2012-08-27</td>
<td>0.080003</td>
<td>0.077451</td>
<td>0.180847</td>
<td>0.131108</td>
<td>-37.0</td>
</tr>
<tr>
<td>Martin Klizan</td>
<td>Alejandro Falla</td>
<td>U.S. Open, New York</td>
<td>2012-08-27</td>
<td>1</td>
<td>Martin Klizan</td>
<td>Alejandro Falla</td>
<td>Martin Klizan</td>
<td>2012-08-27</td>
<td>Alejandro Falla</td>
<td>2012-08-27</td>
<td>0.077117</td>
<td>-0.044716</td>
<td>-0.087362</td>
<td>0.068180</td>
<td>-2.0</td>
</tr>
<tr>
<td>Andy Murray</td>
<td>Alex Bogomolov Jr.</td>
<td>U.S. Open, New York</td>
<td>2012-08-27</td>
<td>1</td>
<td>Andy Murray</td>
<td>Alex Bogomolov Jr.</td>
<td>Andy Murray</td>
<td>2012-08-27</td>
<td>Alex Bogomolov Jr.</td>
<td>2012-08-27</td>
<td>0.039641</td>
<td>0.031701</td>
<td>0.094722</td>
<td>0.059010</td>
<td>-69.0</td>
</tr>
<tr>
<td>Tommy Robredo</td>
<td>Andreas Seppi</td>
<td>U.S. Open, New York</td>
<td>2012-08-27</td>
<td>1</td>
<td>Tommy Robredo</td>
<td>Andreas Seppi</td>
<td>Tommy Robredo</td>
<td>2012-08-27</td>
<td>Andreas Seppi</td>
<td>2012-08-27</td>
<td>-0.026814</td>
<td>0.006442</td>
<td>-0.009930</td>
<td>-0.067780</td>
<td>151.0</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><span class="c1"># target variable</span>
<span class="n">target</span><span class="o">=</span> <span class="s">&#39;player_1_win&#39;</span>

<span class="c1"># features being fed into the models</span>
<span class="n">feats</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Player_Serve_Win_Ratio_diff&#39;</span><span class="p">,</span>
         <span class="s">&#39;Player_Return_Win_Ratio_diff&#39;</span><span class="p">,</span>
         <span class="s">&#39;Player_BreakPoints_Per_Return_Game_diff&#39;</span><span class="p">,</span>
         <span class="s">&#39;Player_Game_Win_Percentage_diff&#39;</span><span class="p">,</span>
         <span class="s">&#39;Player_Rank_diff&#39;</span><span class="p">]</span>

<span class="nf">print</span><span class="p">(</span><span class="n">feats</span><span class="p">)</span>
</code></pre></div>
<hr />
<h2 id="h2o-model-for-atp">H2O model for ATP<a class="headerlink" href="#h2o-model-for-atp" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><span class="nf">h2o.init</span><span class="p">()</span>

<span class="c1"># Convert to an h2o frame</span>
<span class="n">df_train_atp_h2o</span> <span class="o">=</span> <span class="nf">h2o.H2OFrame</span><span class="p">(</span><span class="n">df_train_atp</span><span class="p">)</span>
<span class="n">df_valid_atp_h2o</span> <span class="o">=</span> <span class="nf">h2o.H2OFrame</span><span class="p">(</span><span class="n">df_valid_atp</span><span class="p">)</span>


<span class="c1"># For binary classification, response should be a factor</span>
<span class="n">df_train_atp_h2o</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_train_atp_h2o</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="nf">.asfactor</span><span class="p">()</span>
<span class="n">df_valid_atp_h2o</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_valid_atp_h2o</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="nf">.asfactor</span><span class="p">()</span>

<span class="c1"># Run AutoML for 20 base models (limited to 1 hour max runtime by default)</span>
<span class="n">aml_atp</span> <span class="o">=</span> <span class="nf">h2o.automl.H2OAutoML</span><span class="p">(</span><span class="n">max_runtime_secs</span><span class="o">=</span><span class="m">300</span><span class="p">,</span>
                           <span class="n">max_models</span><span class="o">=</span><span class="m">100</span><span class="p">,</span>
                           <span class="n">stopping_metric</span><span class="o">=</span><span class="s">&#39;logloss&#39;</span><span class="p">,</span>
                           <span class="n">sort_metric</span><span class="o">=</span><span class="s">&#39;logloss&#39;</span><span class="p">,</span>
                           <span class="n">balance_classes</span><span class="o">=</span><span class="n">True</span><span class="p">,</span>
                           <span class="n">seed</span><span class="o">=</span><span class="m">183</span>
                          <span class="p">)</span>
<span class="nf">aml_atp.train</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">feats</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">training_frame</span><span class="o">=</span><span class="n">df_train_atp_h2o</span><span class="p">,</span><span class="n">validation_frame</span><span class="o">=</span><span class="n">df_valid_atp_h2o</span><span class="p">)</span>

<span class="c1"># View the AutoML Leaderboard</span>
<span class="n">lb</span> <span class="o">=</span> <span class="n">aml_atp.leaderboard</span>
<span class="nf">lb.head</span><span class="p">()</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>model_id</th>
<th>auc</th>
<th>logloss</th>
<th>mean_per_class_error</th>
<th>rmse</th>
<th>mse</th>
</tr>
</thead>
<tbody>
<tr>
<td>GBM_5_AutoML_20181221_094949</td>
<td>0.790281</td>
<td>0.554852</td>
<td>0.281363</td>
<td>0.431379</td>
<td>0.186088</td>
</tr>
<tr>
<td>GBM_grid_1_AutoML_20181221_094949_model_15</td>
<td>0.789329</td>
<td>0.556804</td>
<td>0.29856</td>
<td>0.431931</td>
<td>0.186564</td>
</tr>
<tr>
<td>GBM_grid_1_AutoML_20181221_094949_model_7</td>
<td>0.788013</td>
<td>0.557808</td>
<td>0.295899</td>
<td>0.432968</td>
<td>0.187461</td>
</tr>
<tr>
<td>StackedEnsemble_BestOfFamily_AutoML_20181221_094949</td>
<td>0.788131</td>
<td>0.558028</td>
<td>0.285321</td>
<td>0.432849</td>
<td>0.187358</td>
</tr>
<tr>
<td>GBM_grid_1_AutoML_20181221_094949_model_20</td>
<td>0.785633</td>
<td>0.561094</td>
<td>0.283932</td>
<td>0.43479</td>
<td>0.189043</td>
</tr>
<tr>
<td>StackedEnsemble_AllModels_AutoML_20181221_094949</td>
<td>0.784411</td>
<td>0.561587</td>
<td>0.293244</td>
<td>0.434667</td>
<td>0.188935</td>
</tr>
<tr>
<td>GBM_grid_1_AutoML_20181221_094949_model_25</td>
<td>0.785311</td>
<td>0.561783</td>
<td>0.291912</td>
<td>0.434888</td>
<td>0.189127</td>
</tr>
<tr>
<td>GBM_grid_1_AutoML_20181221_094949_model_17</td>
<td>0.774832</td>
<td>0.570883</td>
<td>0.295836</td>
<td>0.439375</td>
<td>0.193051</td>
</tr>
<tr>
<td>DeepLearning_1_AutoML_20181221_094949</td>
<td>0.779388</td>
<td>0.572823</td>
<td>0.311737</td>
<td>0.438479</td>
<td>0.192264</td>
</tr>
<tr>
<td>GBM_grid_1_AutoML_20181221_094949_model_14</td>
<td>0.7718</td>
<td>0.578867</td>
<td>0.285835</td>
<td>0.441373</td>
<td>0.19481</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><span class="n">H2O</span> <span class="n">model</span> <span class="n">for</span> <span class="n">WTA</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># Convert to an h2o frame</span>
<span class="n">df_train_wta_h2o</span> <span class="o">=</span> <span class="nf">h2o.H2OFrame</span><span class="p">(</span><span class="n">df_train_wta</span><span class="p">)</span>
<span class="n">df_valid_wta_h2o</span> <span class="o">=</span> <span class="nf">h2o.H2OFrame</span><span class="p">(</span><span class="n">df_valid_wta</span><span class="p">)</span>


<span class="c1"># For binary classification, response should be a factor</span>
<span class="n">df_train_wta_h2o</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_train_wta_h2o</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="nf">.asfactor</span><span class="p">()</span>
<span class="n">df_valid_wta_h2o</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_valid_wta_h2o</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="nf">.asfactor</span><span class="p">()</span>

<span class="c1"># Run AutoML for 20 base models (limited to 1 hour max runtime by default)</span>
<span class="n">aml_wta</span> <span class="o">=</span> <span class="nf">h2o.automl.H2OAutoML</span><span class="p">(</span><span class="n">max_runtime_secs</span><span class="o">=</span><span class="m">300</span><span class="p">,</span>
                           <span class="n">max_models</span><span class="o">=</span><span class="m">100</span><span class="p">,</span>
                           <span class="n">stopping_metric</span><span class="o">=</span><span class="s">&#39;logloss&#39;</span><span class="p">,</span>
                           <span class="n">sort_metric</span><span class="o">=</span><span class="s">&#39;logloss&#39;</span><span class="p">,</span>
                           <span class="n">balance_classes</span><span class="o">=</span><span class="n">True</span><span class="p">,</span>
                           <span class="n">seed</span><span class="o">=</span><span class="m">183</span>
                          <span class="p">)</span>
<span class="nf">aml_wta.train</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">feats</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">training_frame</span><span class="o">=</span><span class="n">df_train_wta_h2o</span><span class="p">,</span><span class="n">validation_frame</span><span class="o">=</span><span class="n">df_valid_wta_h2o</span><span class="p">)</span>

<span class="c1"># View the AutoML Leaderboard</span>
<span class="n">lb</span> <span class="o">=</span> <span class="n">aml_wta.leaderboard</span>
<span class="nf">lb.head</span><span class="p">()</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>model_id</th>
<th>auc</th>
<th>logloss</th>
<th>mean_per_class_error</th>
<th>rmse</th>
<th>mse</th>
</tr>
</thead>
<tbody>
<tr>
<td>StackedEnsemble_AllModels_AutoML_20181221_095400</td>
<td>0.726046</td>
<td>0.60827</td>
<td>0.321222</td>
<td>0.457117</td>
<td>0.208956</td>
</tr>
<tr>
<td>StackedEnsemble_BestOfFamily_AutoML_20181221_095400</td>
<td>0.724911</td>
<td>0.609329</td>
<td>0.337847</td>
<td>0.457659</td>
<td>0.209452</td>
</tr>
<tr>
<td>DeepLearning_grid_1_AutoML_20181221_095400_model_3</td>
<td>0.729152</td>
<td>0.612669</td>
<td>0.315971</td>
<td>0.45641</td>
<td>0.20831</td>
</tr>
<tr>
<td>GBM_grid_1_AutoML_20181221_095400_model_7</td>
<td>0.721204</td>
<td>0.615763</td>
<td>0.336848</td>
<td>0.460885</td>
<td>0.212415</td>
</tr>
<tr>
<td>GBM_5_AutoML_20181221_095400</td>
<td>0.719252</td>
<td>0.616535</td>
<td>0.319179</td>
<td>0.461055</td>
<td>0.212572</td>
</tr>
<tr>
<td>GBM_grid_1_AutoML_20181221_095400_model_15</td>
<td>0.715921</td>
<td>0.619263</td>
<td>0.318673</td>
<td>0.462215</td>
<td>0.213643</td>
</tr>
<tr>
<td>GLM_grid_1_AutoML_20181221_095400_model_1</td>
<td>0.726048</td>
<td>0.622989</td>
<td>0.366124</td>
<td>0.463099</td>
<td>0.214461</td>
</tr>
<tr>
<td>GBM_grid_1_AutoML_20181221_095400_model_17</td>
<td>0.709261</td>
<td>0.624902</td>
<td>0.34876</td>
<td>0.465628</td>
<td>0.216809</td>
</tr>
<tr>
<td>GBM_grid_1_AutoML_20181221_095400_model_18</td>
<td>0.70946</td>
<td>0.625704</td>
<td>0.393556</td>
<td>0.466147</td>
<td>0.217293</td>
</tr>
<tr>
<td>DeepLearning_grid_1_AutoML_20181221_095400_model_2</td>
<td>0.713419</td>
<td>0.628008</td>
<td>0.311334</td>
<td>0.463638</td>
<td>0.21496</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="use-the-models-to-predict-and-make-submissions">Use the models to predict and make submissions<a class="headerlink" href="#use-the-models-to-predict-and-make-submissions" title="Permanent link">&para;</a></h2>
<p>Now let's use the models we just created to make the submissions</p>
<div class="highlight"><pre><span></span><code><span class="n">df_predict_atp</span> <span class="o">=</span> <span class="nf">pd.read_csv</span><span class="p">(</span><span class="s">&quot;data/men_dummy_submission_file.csv&quot;</span><span class="p">)</span>
<span class="n">df_predict_wta</span> <span class="o">=</span> <span class="nf">pd.read_csv</span><span class="p">(</span><span class="s">&quot;data/women_dummy_submission_file.csv&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&#39;latin1&#39;</span><span class="p">)</span> <span class="c1"># for womens, there are some names need a different encoding</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="nf">df_predict_wta.head</span><span class="p">(</span><span class="m">2</span><span class="p">)</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>player_1</th>
<th>player_2</th>
<th>player_1_win_probability</th>
</tr>
</thead>
<tbody>
<tr>
<td>Simona Halep</td>
<td>Angelique Kerber</td>
<td>0.5</td>
</tr>
<tr>
<td>Simona Halep</td>
<td>Caroline Wozniacki</td>
<td>0.5</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="get-the-features-for-the-predict-df">Get the features for the predict df<a class="headerlink" href="#get-the-features-for-the-predict-df" title="Permanent link">&para;</a></h2>
<p>We need to join the features to the 2019 players</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Before we join the features by the names and the dates, we need to convert any non-english characters to english first</span>
<span class="n">translationTable</span> <span class="o">=</span> <span class="nf">str.maketrans</span><span class="p">(</span><span class="s">&quot;éàèùâêîôûçñá&quot;</span><span class="p">,</span> <span class="s">&quot;eaeuaeioucna&quot;</span><span class="p">)</span>


<span class="n">df_predict_atp</span><span class="p">[</span><span class="s">&#39;player_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nf">df_predict_atp.player_1.apply</span><span class="p">(</span><span class="n">lambda</span> <span class="n">x</span><span class="o">:</span> <span class="nf">x.translate</span><span class="p">(</span><span class="n">translationTable</span><span class="p">))</span>
<span class="n">df_predict_atp</span><span class="p">[</span><span class="s">&#39;player_2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nf">df_predict_atp.player_2.apply</span><span class="p">(</span><span class="n">lambda</span> <span class="n">x</span><span class="o">:</span> <span class="nf">x.translate</span><span class="p">(</span><span class="n">translationTable</span><span class="p">))</span>
<span class="n">df_predict_wta</span><span class="p">[</span><span class="s">&#39;player_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nf">df_predict_wta.player_1.apply</span><span class="p">(</span><span class="n">lambda</span> <span class="n">x</span><span class="o">:</span> <span class="nf">x.translate</span><span class="p">(</span><span class="n">translationTable</span><span class="p">))</span>
<span class="n">df_predict_wta</span><span class="p">[</span><span class="s">&#39;player_2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nf">df_predict_wta.player_2.apply</span><span class="p">(</span><span class="n">lambda</span> <span class="n">x</span><span class="o">:</span> <span class="nf">x.translate</span><span class="p">(</span><span class="n">translationTable</span><span class="p">))</span>


<span class="c1"># Also we need to convert the names into lower cases </span>
<span class="n">df_predict_atp</span><span class="p">[</span><span class="s">&#39;player_1&#39;</span><span class="p">]</span> <span class="o">=</span><span class="n">df_predict_atp</span><span class="p">[</span><span class="s">&#39;player_1&#39;</span><span class="p">]</span><span class="nf">.str.lower</span><span class="p">()</span> 
<span class="n">df_predict_atp</span><span class="p">[</span><span class="s">&#39;player_2&#39;</span><span class="p">]</span> <span class="o">=</span><span class="n">df_predict_atp</span><span class="p">[</span><span class="s">&#39;player_2&#39;</span><span class="p">]</span><span class="nf">.str.lower</span><span class="p">()</span> 
<span class="n">df_predict_wta</span><span class="p">[</span><span class="s">&#39;player_1&#39;</span><span class="p">]</span> <span class="o">=</span><span class="n">df_predict_wta</span><span class="p">[</span><span class="s">&#39;player_1&#39;</span><span class="p">]</span><span class="nf">.str.lower</span><span class="p">()</span> 
<span class="n">df_predict_wta</span><span class="p">[</span><span class="s">&#39;player_2&#39;</span><span class="p">]</span> <span class="o">=</span><span class="n">df_predict_wta</span><span class="p">[</span><span class="s">&#39;player_2&#39;</span><span class="p">]</span><span class="nf">.str.lower</span><span class="p">()</span> 

<span class="n">df_rolling_atp</span><span class="p">[</span><span class="s">&#39;Player&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_rolling_atp</span><span class="p">[</span><span class="s">&#39;Player&#39;</span><span class="p">]</span><span class="nf">.str.lower</span><span class="p">()</span> 
<span class="n">df_rolling_wta</span><span class="p">[</span><span class="s">&#39;Player&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_rolling_wta</span><span class="p">[</span><span class="s">&#39;Player&#39;</span><span class="p">]</span><span class="nf">.str.lower</span><span class="p">()</span> 


<span class="c1"># Lastly, some players have slightly difference names in the submission data and the match data. So we are editing them here manually</span>
<span class="n">df_predict_atp.loc</span><span class="p">[</span><span class="n">df_predict_atp.player_1</span><span class="o">==</span><span class="s">&#39;jaume munar&#39;</span><span class="p">,</span><span class="s">&#39;player_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;jaume antoni munar clar&#39;</span>
<span class="n">df_predict_atp.loc</span><span class="p">[</span><span class="n">df_predict_atp.player_2</span><span class="o">==</span><span class="s">&#39;jaume munar&#39;</span><span class="p">,</span><span class="s">&#39;player_2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;jaume antoni munar clar&#39;</span>

<span class="n">df_predict_wta.loc</span><span class="p">[</span><span class="n">df_predict_wta.player_1</span><span class="o">==</span><span class="s">&#39;daria kasatkina&#39;</span><span class="p">,</span><span class="s">&#39;player_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;darya kasatkina&#39;</span>
<span class="n">df_predict_wta.loc</span><span class="p">[</span><span class="n">df_predict_wta.player_2</span><span class="o">==</span><span class="s">&#39;daria kasatkina&#39;</span><span class="p">,</span><span class="s">&#39;player_2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;darya kasatkina&#39;</span>
<span class="n">df_predict_wta.loc</span><span class="p">[</span><span class="n">df_predict_wta.player_1</span><span class="o">==</span><span class="s">&#39;lesia tsurenko&#39;</span><span class="p">,</span><span class="s">&#39;player_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;lesya tsurenko&#39;</span>
<span class="n">df_predict_wta.loc</span><span class="p">[</span><span class="n">df_predict_wta.player_2</span><span class="o">==</span><span class="s">&#39;lesia tsurenko&#39;</span><span class="p">,</span><span class="s">&#39;player_2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;lesya tsurenko&#39;</span>
<span class="n">df_predict_wta.loc</span><span class="p">[</span><span class="n">df_predict_wta.player_1</span><span class="o">==</span><span class="s">&#39;danielle collins&#39;</span><span class="p">,</span><span class="s">&#39;player_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;danielle rose collins&#39;</span>
<span class="n">df_predict_wta.loc</span><span class="p">[</span><span class="n">df_predict_wta.player_2</span><span class="o">==</span><span class="s">&#39;danielle collins&#39;</span><span class="p">,</span><span class="s">&#39;player_2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;danielle rose collins&#39;</span>
<span class="n">df_predict_wta.loc</span><span class="p">[</span><span class="n">df_predict_wta.player_1</span><span class="o">==</span><span class="s">&#39;anna karolina schmiedlova&#39;</span><span class="p">,</span><span class="s">&#39;player_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;anna schmiedlova&#39;</span>
<span class="n">df_predict_wta.loc</span><span class="p">[</span><span class="n">df_predict_wta.player_2</span><span class="o">==</span><span class="s">&#39;anna karolina schmiedlova&#39;</span><span class="p">,</span><span class="s">&#39;player_2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;anna schmiedlova&#39;</span>
<span class="n">df_predict_wta.loc</span><span class="p">[</span><span class="n">df_predict_wta.player_1</span><span class="o">==</span><span class="s">&#39;georgina garcia perez&#39;</span><span class="p">,</span><span class="s">&#39;player_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;georgina garcia-perez&#39;</span>
<span class="n">df_predict_wta.loc</span><span class="p">[</span><span class="n">df_predict_wta.player_2</span><span class="o">==</span><span class="s">&#39;georgina garcia perez&#39;</span><span class="p">,</span><span class="s">&#39;player_2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;georgina garcia-perez&#39;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># create and tournament date column and set it to 2019 so we can join the lastest features</span>
<span class="n">df_predict_atp</span><span class="p">[</span><span class="s">&#39;Tournament_Date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nf">pd.to_datetime</span><span class="p">(</span><span class="s">&#39;2019-01-15&#39;</span><span class="p">)</span>
<span class="n">df_predict_wta</span><span class="p">[</span><span class="s">&#39;Tournament_Date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nf">pd.to_datetime</span><span class="p">(</span><span class="s">&#39;2019-01-15&#39;</span><span class="p">)</span>

<span class="c1"># Get the rolling features for player 1</span>
<span class="n">df_predict_atp</span> <span class="o">=</span> <span class="nf">df_predict_atp.merge</span><span class="p">(</span><span class="n">df_rolling_atp</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s">&#39;left&#39;</span><span class="p">,</span>
                     <span class="n">left_on</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;player_1&#39;</span><span class="p">,</span><span class="s">&#39;Tournament_Date&#39;</span><span class="p">],</span>
                     <span class="n">right_on</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Player&#39;</span><span class="p">,</span><span class="s">&#39;tournament_date_index&#39;</span><span class="p">],</span><span class="n">validate</span> <span class="o">=</span><span class="s">&#39;m:1&#39;</span><span class="p">)</span>
<span class="n">df_predict_wta</span> <span class="o">=</span> <span class="nf">df_predict_wta.merge</span><span class="p">(</span><span class="n">df_rolling_wta</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s">&#39;left&#39;</span><span class="p">,</span>
                     <span class="n">left_on</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;player_1&#39;</span><span class="p">,</span><span class="s">&#39;Tournament_Date&#39;</span><span class="p">],</span>
                     <span class="n">right_on</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Player&#39;</span><span class="p">,</span><span class="s">&#39;tournament_date_index&#39;</span><span class="p">],</span><span class="n">validate</span> <span class="o">=</span><span class="s">&#39;m:1&#39;</span><span class="p">)</span>


<span class="c1"># Get the rolling features for player 2</span>
<span class="c1"># For duplicate columns, we will use &#39;_p1&#39; to denote player 1 and &#39;_p2&#39; for player 2</span>
<span class="n">df_predict_atp</span> <span class="o">=</span> <span class="nf">df_predict_atp.merge</span><span class="p">(</span><span class="n">df_rolling_atp</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s">&#39;left&#39;</span><span class="p">,</span>
                     <span class="n">left_on</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;player_2&#39;</span><span class="p">,</span><span class="s">&#39;Tournament_Date&#39;</span><span class="p">],</span>
                     <span class="n">right_on</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Player&#39;</span><span class="p">,</span><span class="s">&#39;tournament_date_index&#39;</span><span class="p">],</span><span class="n">validate</span> <span class="o">=</span><span class="s">&#39;m:1&#39;</span><span class="p">,</span><span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;_p1&#39;</span><span class="p">,</span><span class="s">&#39;_p2&#39;</span><span class="p">))</span>
<span class="n">df_predict_wta</span> <span class="o">=</span> <span class="nf">df_predict_wta.merge</span><span class="p">(</span><span class="n">df_rolling_wta</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s">&#39;left&#39;</span><span class="p">,</span>
                     <span class="n">left_on</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;player_2&#39;</span><span class="p">,</span><span class="s">&#39;Tournament_Date&#39;</span><span class="p">],</span>
                     <span class="n">right_on</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Player&#39;</span><span class="p">,</span><span class="s">&#39;tournament_date_index&#39;</span><span class="p">],</span><span class="n">validate</span> <span class="o">=</span><span class="s">&#39;m:1&#39;</span><span class="p">,</span><span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;_p1&#39;</span><span class="p">,</span><span class="s">&#39;_p2&#39;</span><span class="p">))</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="nf">df_predict_atp.head</span><span class="p">(</span><span class="m">2</span><span class="p">)</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>player_1</th>
<th>player_2</th>
<th>player_1_win_probability</th>
<th>Tournament_Date</th>
<th>Player_p1</th>
<th>Player_Serve_Win_Ratio_p1</th>
<th>Player_Return_Win_Ratio_p1</th>
<th>Player_BreakPoints_Per_Return_Game_p1</th>
<th>Player_Game_Win_Percentage_p1</th>
<th>Player_Rank_p1</th>
<th>tournament_date_index_p1</th>
<th>Player_p2</th>
<th>Player_Serve_Win_Ratio_p2</th>
<th>Player_Return_Win_Ratio_p2</th>
<th>Player_BreakPoints_Per_Return_Game_p2</th>
<th>Player_Game_Win_Percentage_p2</th>
<th>Player_Rank_p2</th>
<th>tournament_date_index_p2</th>
</tr>
</thead>
<tbody>
<tr>
<td>novak djokovic</td>
<td>rafael nadal</td>
<td>0.5</td>
<td>2019-01-15</td>
<td>novak djokovic</td>
<td>0.685903</td>
<td>0.426066</td>
<td>0.42378</td>
<td>0.640857</td>
<td>2.0</td>
<td>2019-01-15</td>
<td>rafael nadal</td>
<td>0.622425</td>
<td>0.401028</td>
<td>0.334270</td>
<td>0.570833</td>
<td>1.0</td>
<td>2019-01-15</td>
</tr>
<tr>
<td>novak djokovic</td>
<td>roger federer</td>
<td>0.5</td>
<td>2019-01-15</td>
<td>novak djokovic</td>
<td>0.685903</td>
<td>0.426066</td>
<td>0.42378</td>
<td>0.640857</td>
<td>2.0</td>
<td>2019-01-15</td>
<td>roger federer</td>
<td>0.620070</td>
<td>0.389781</td>
<td>0.269224</td>
<td>0.564244</td>
<td>3.0</td>
<td>2019-01-15</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><span class="c1"># How many players do not have previous match history</span>
<span class="nf">print</span><span class="p">(</span><span class="s">&#39;{} player_1s do Not have previous match history before the tournament in the mens&#39;</span><span class="nf">.format</span><span class="p">(</span><span class="n">df_predict_atp.loc</span><span class="p">[</span><span class="nf">df_predict_atp.Player_p1.isna</span><span class="p">(),</span><span class="s">&#39;player_1&#39;</span><span class="p">]</span><span class="nf">.nunique</span><span class="p">()))</span>
<span class="nf">print</span><span class="p">(</span><span class="s">&#39;{} player_2s do Not have previous match history before the tournament in the mens&#39;</span><span class="nf">.format</span><span class="p">(</span><span class="n">df_predict_atp.loc</span><span class="p">[</span><span class="nf">df_predict_atp.Player_p2.isna</span><span class="p">(),</span><span class="s">&#39;player_2&#39;</span><span class="p">]</span><span class="nf">.nunique</span><span class="p">()))</span>
</code></pre></div>
<p>3 player_1s do Not have previous match history before the tournament in the mens
3 player_2s do Not have previous match history before the tournament in the mens</p>
<div class="highlight"><pre><span></span><code><span class="c1"># How many players do not have previous match history</span>
<span class="nf">print</span><span class="p">(</span><span class="s">&#39;{} player_1s do Not have previous match history before the tournament in the womens&#39;</span><span class="nf">.format</span><span class="p">(</span><span class="n">df_predict_wta.loc</span><span class="p">[</span><span class="nf">df_predict_wta.Player_p1.isna</span><span class="p">(),</span><span class="s">&#39;player_1&#39;</span><span class="p">]</span><span class="nf">.nunique</span><span class="p">()))</span>
<span class="nf">print</span><span class="p">(</span><span class="s">&#39;{} player_2s do Not have previous match history before the tournament in the womens&#39;</span><span class="nf">.format</span><span class="p">(</span><span class="n">df_predict_wta.loc</span><span class="p">[</span><span class="nf">df_predict_wta.Player_p2.isna</span><span class="p">(),</span><span class="s">&#39;player_2&#39;</span><span class="p">]</span><span class="nf">.nunique</span><span class="p">()))</span>
</code></pre></div>
<p>0 player_1s do Not have previous match history before the tournament in the womens
0 player_2s do Not have previous match history before the tournament in the womens</p>
<div class="highlight"><pre><span></span><code><span class="nf">print</span><span class="p">(</span><span class="n">df_predict_atp.loc</span><span class="p">[</span><span class="nf">df_predict_atp.Player_p1.isna</span><span class="p">(),</span><span class="s">&#39;player_1&#39;</span><span class="p">]</span><span class="nf">.unique</span><span class="p">()</span><span class="nf">.tolist</span><span class="p">())</span>
<span class="p">[</span><span class="s">&#39;christian garin&#39;</span><span class="p">,</span> <span class="s">&#39;pedro sousa&#39;</span><span class="p">,</span> <span class="s">&#39;hugo dellien&#39;</span><span class="p">]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="nf">print</span><span class="p">(</span><span class="n">df_predict_wta.loc</span><span class="p">[</span><span class="nf">df_predict_wta.Player_p1.isna</span><span class="p">(),</span><span class="s">&#39;player_1&#39;</span><span class="p">]</span><span class="nf">.unique</span><span class="p">()</span><span class="nf">.tolist</span><span class="p">())</span>
<span class="p">[]</span>
</code></pre></div>
<p>We will do the differencing again for the prediction dataframes exactly like what we did for training</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Apply the function and get the difference between player 1 and 2</span>
<span class="n">df_predict_atp</span><span class="p">,</span>_ <span class="o">=</span> <span class="nf">get_player_difference</span><span class="p">(</span><span class="n">df_predict_atp</span><span class="p">,</span><span class="n">diff_cols</span><span class="o">=</span><span class="n">diff_cols</span><span class="p">)</span>
<span class="n">df_predict_wta</span><span class="p">,</span>_ <span class="o">=</span> <span class="nf">get_player_difference</span><span class="p">(</span><span class="n">df_predict_wta</span><span class="p">,</span><span class="n">diff_cols</span><span class="o">=</span><span class="n">diff_cols</span><span class="p">)</span>
</code></pre></div>
<hr />
<h2 id="make-the-prediction">Make the prediction<a class="headerlink" href="#make-the-prediction" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><span class="n">df_predict_atp_h2o</span> <span class="o">=</span> <span class="nf">h2o.H2OFrame</span><span class="p">(</span><span class="n">df_predict_atp</span><span class="p">[</span><span class="n">feats</span><span class="p">])</span>
<span class="n">df_predict_wta_h2o</span> <span class="o">=</span> <span class="nf">h2o.H2OFrame</span><span class="p">(</span><span class="n">df_predict_wta</span><span class="p">[</span><span class="n">feats</span><span class="p">])</span>

<span class="n">atp_preds</span> <span class="o">=</span> <span class="nf">aml_atp.predict</span><span class="p">(</span><span class="n">df_predict_atp_h2o</span><span class="p">)[</span><span class="s">&#39;p1&#39;</span><span class="p">]</span><span class="nf">.as_data_frame</span><span class="p">()</span>
<span class="n">wta_preds</span> <span class="o">=</span> <span class="nf">aml_wta.predict</span><span class="p">(</span><span class="n">df_predict_wta_h2o</span><span class="p">)[</span><span class="s">&#39;p1&#39;</span><span class="p">]</span><span class="nf">.as_data_frame</span><span class="p">()</span>

<span class="n">df_predict_atp</span><span class="p">[</span><span class="s">&#39;player_1_win_probability&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atp_preds</span>
<span class="n">df_predict_wta</span><span class="p">[</span><span class="s">&#39;player_1_win_probability&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wta_preds</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">atp_submission</span> <span class="o">=</span> <span class="n">df_predict_atp</span><span class="p">[[</span><span class="s">&#39;player_1&#39;</span><span class="p">,</span><span class="s">&#39;player_2&#39;</span><span class="p">,</span><span class="s">&#39;player_1_win_probability&#39;</span><span class="p">]]</span>
<span class="n">wta_submission</span> <span class="o">=</span> <span class="n">df_predict_wta</span><span class="p">[[</span><span class="s">&#39;player_1&#39;</span><span class="p">,</span><span class="s">&#39;player_2&#39;</span><span class="p">,</span><span class="s">&#39;player_1_win_probability&#39;</span><span class="p">]]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="nf">atp_submission.head</span><span class="p">()</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>player_1</th>
<th>player_2</th>
<th>player_1_win_probability</th>
</tr>
</thead>
<tbody>
<tr>
<td>novak djokovic</td>
<td>rafael nadal</td>
<td>0.571588</td>
</tr>
<tr>
<td>novak djokovic</td>
<td>roger federer</td>
<td>0.662511</td>
</tr>
<tr>
<td>novak djokovic</td>
<td>juan martin del potro</td>
<td>0.544306</td>
</tr>
<tr>
<td>novak djokovic</td>
<td>alexander zverev</td>
<td>0.709483</td>
</tr>
<tr>
<td>novak djokovic</td>
<td>kevin anderson</td>
<td>0.687195</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><span class="nf">wta_submission.head</span><span class="p">()</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>player_1</th>
<th>player_2</th>
<th>player_1_win_probability</th>
</tr>
</thead>
<tbody>
<tr>
<td>simona halep</td>
<td>angelique kerber</td>
<td>0.455224</td>
</tr>
<tr>
<td>simona halep</td>
<td>caroline wozniacki</td>
<td>0.546276</td>
</tr>
<tr>
<td>simona halep</td>
<td>elina svitolina</td>
<td>0.408014</td>
</tr>
<tr>
<td>simona halep</td>
<td>naomi osaka</td>
<td>0.285125</td>
</tr>
<tr>
<td>simona halep</td>
<td>sloane stephens</td>
<td>0.576643</td>
</tr>
</tbody>
</table>
<p>Let's look at who has the highest win rate from our models</p>
<div class="highlight"><pre><span></span><code><span class="nf">atp_submission.groupby</span><span class="p">(</span><span class="s">&#39;player_1&#39;</span><span class="p">)[</span><span class="s">&#39;player_1_win_probability&#39;</span><span class="p">]</span><span class="nf">.mean</span><span class="p">()</span> \
<span class="nf">.reset_index</span><span class="p">()</span><span class="nf">.sort_values</span><span class="p">(</span><span class="s">&#39;player_1_win_probability&#39;</span><span class="p">,</span><span class="n">ascending</span><span class="o">=</span><span class="n">False</span><span class="p">)</span><span class="nf">.head</span><span class="p">()</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>player_1</th>
<th>player_1_win_probability</th>
</tr>
</thead>
<tbody>
<tr>
<td>novak djokovic</td>
<td>0.846377</td>
</tr>
<tr>
<td>juan martin del potro</td>
<td>0.787337</td>
</tr>
<tr>
<td>karen khachanov</td>
<td>0.782963</td>
</tr>
<tr>
<td>rafael nadal</td>
<td>0.778707</td>
</tr>
<tr>
<td>roger federer</td>
<td>0.767337</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><span class="nf">wta_submission.groupby</span><span class="p">(</span><span class="s">&#39;player_1&#39;</span><span class="p">)[</span><span class="s">&#39;player_1_win_probability&#39;</span><span class="p">]</span><span class="nf">.mean</span><span class="p">()</span> \
<span class="nf">.reset_index</span><span class="p">()</span><span class="nf">.sort_values</span><span class="p">(</span><span class="s">&#39;player_1_win_probability&#39;</span><span class="p">,</span><span class="n">ascending</span><span class="o">=</span><span class="n">False</span><span class="p">)</span><span class="nf">.head</span><span class="p">()</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>player_1</th>
<th>player_1_win_probability</th>
</tr>
</thead>
<tbody>
<tr>
<td>madison keys</td>
<td>0.750580</td>
</tr>
<tr>
<td>naomi osaka</td>
<td>0.749195</td>
</tr>
<tr>
<td>caroline wozniacki</td>
<td>0.722409</td>
</tr>
<tr>
<td>kiki bertens</td>
<td>0.713904</td>
</tr>
<tr>
<td>aryna sabalenka</td>
<td>0.707368</td>
</tr>
</tbody>
</table>
<p>Now we can output the predictions as csvs</p>
<div class="highlight"><pre><span></span><code><span class="nf">atp_submission.to_csv</span><span class="p">(</span><span class="s">&#39;submission/atp_submission_python.csv&#39;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">False</span><span class="p">)</span>
<span class="nf">wta_submission.to_csv</span><span class="p">(</span><span class="s">&#39;submission/wta_submission_pthon.csv&#39;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">False</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">atp_submission.shape</span>
</code></pre></div>
<p>(16256, 3)</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../AusOpenRTutorial/" title="Aus Open R Tutorial" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Aus Open R Tutorial
              </span>
            </div>
          </a>
        
        
          <a href="../EPLmodelPart1/" title="EPL 01. Data acquisition & exploration" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                EPL 01. Data acquisition & exploration
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
      </div>
      
        
  <div class="md-footer-social">
    <link rel="stylesheet" href="../../assets/fonts/font-awesome.css">
    
      <a href="https://twitter.com/Betfair_Aus" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://linkedin.com/company/betfair-australia" class="md-footer-social__link fa fa-linkedin"></a>
    
      <a href="https://facebook.com/betfairaustralia" class="md-footer-social__link fa fa-facebook"></a>
    
      <a href="https://youtube.com/user/betfairaus" class="md-footer-social__link fa fa-youtube"></a>
    
      <a href="https://github.com/betfair-datascientists" class="md-footer-social__link fa fa-github"></a>
    
  </div>

      
    </div>
    <div class="bf-footer">
      <p class="bf-light">Betfair Pty Limited is licensed and regulated by the Northern Territory Government of Australia.</p>
      <p class="bf-dark">Betfair Pty Limited's gambling operations are governed by its Responsible Gambling Code of Conduct and for South
      Australian residents by the South Australian Responsible Gambling Code of Practice.<br> Think! About your choices. Don’t chase your losses. Walk away. Gamble responsibly. Call Gambling Help 1800 858 858 <a href="https://gamblinghelponline.org.au">www.gamblinghelponline.org.au</a></p>
      <ul class="bf-links">
        <li><a href="https://www.betfair.com.au/hub/help/account-help/responsible-gambling/">Responsible Gambling</a><span>|</span></li>
        <li><a href="http://www.betfair.com/AUS_NZL/aboutUs/Terms.and.Conditions/">Terms & Conditions</a><span>|</span></li>
        <li><a href="https://www.betfair.com.au/info/privacy-policy/">Privacy Policy</a><span>|</span></li>
        <li><a href="http://www.betfair.com/en/aboutUs/Rules.and.Regulations/">Rules & Regulations</a><span>|</span></li>
        <li><a href="https://www.betfair.com/AUS_NZL/aboutUs/Dispute.Resolution">Dispute Resolution</a></li>
      </ul>
    </div>
  </div>
  <script src="https://js.adsrvr.org/up_loader.1.1.0.js"></script>
  <script>ttd_dom_ready(function(){"function"==typeof TTDUniversalPixelApi&&(new TTDUniversalPixelApi).init("y12d1ir",["8ml4f17"],"https://insight.adsrvr.org/track/up")})</script>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.07363bc3.js"></script>
      
      <script>app.initialize({version:"1.1.2",url:{base:"../.."}})</script>
      
        <script src="../../search/main.js"></script>
      
    
    
      
        <script>!function(e,a,t,n,o,c,i){e.GoogleAnalyticsObject=o,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),i=a.getElementsByTagName(t)[0],c.async=1,c.src="https://www.google-analytics.com/analytics.js",i.parentNode.insertBefore(c,i)}(window,document,"script",0,"ga"),ga("create","UA-125973915-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview");var links=document.getElementsByTagName("a");if(Array.prototype.map.call(links,function(e){e.host!=document.location.host&&e.addEventListener("click",function(){var a=e.getAttribute("data-md-action")||"follow";ga("send","event","outbound",a,e.href)})}),document.forms.search){var query=document.forms.search.query;query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})}</script>
      
    
  </body>
</html>