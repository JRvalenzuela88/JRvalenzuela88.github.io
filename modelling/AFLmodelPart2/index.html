



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Documentation, guides and articles on creating, developing and implementing automated betting strategies, using data analysis to inform betting models and how to interact with the Betfair API.">
      
      
        <link rel="canonical" href="https://betfair-datascientists.github.io/modelling/AFLmodelPart2/">
      
      
        <meta name="author" content="Betfair Data Scientists">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../img/BetfairFavicon.ico">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-3.0.4">
    
    
      
        <title>AFL 02. Feature creation - The Automation Hub</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.834e7605.css">
      
      
    
    
      <script src="../../assets/javascripts/modernizr.dd00d4b7.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    <link rel="stylesheet" href="../../assets/fonts/clarke-regular.css">
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#afl-modelling-walkthrough" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://betfair-datascientists.github.io" title="The Automation Hub" class="md-header-nav__button md-logo">
          
            <img src="../../img/logo.svg" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                The Automation Hub
              </span>
              <span class="md-header-nav__topic">
                AFL 02. Feature creation
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      <div class="bf-nav md-flex__cell">
        <a class="bf-hidable" href="https://www.betfair.com.au/exchange/plus/"><svg class="exchangeLogo" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 38.775 4.59" width="24" height="17">
          <path class="st1" d="m 160.3,-136.95 v 26"/>
          <g transform="translate(18.8,-137.15)">
            <path d="m 2.2901089,126.53441 v 5.20093 H -3.3107216 L 7.4888397,144.33446 18.2884,131.73534 h -5.598633 v -5.20093 z m -8.6000974,8.10132 -10.8017585,12.59913 h 5.60083 v 5.2998 h 10.3996581 v -5.2998 h 5.6008306 z"/>
          </g>
        </svg><span> Exchange</span></a>
        <a href="https://www.betfair.com.au/hub/">Hub</a>
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../.." title="Home" class="md-tabs__link">
          Home
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../thirdPartyTools/overview/" title="Tutorials" class="md-tabs__link">
          Tutorials
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../api/apiappkey/" title="API" class="md-tabs__link">
          API
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../historicData/dataSources/" title="Historic Data" class="md-tabs__link">
          Historic Data
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../howToModel/" title="Modelling" class="md-tabs__link md-tabs__link--active">
          Modelling
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://betfair-datascientists.github.io" title="The Automation Hub" class="md-nav__button md-logo">
      
        <img src="../../img/logo.svg" width="48" height="48">
      
    </a>
    The Automation Hub
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1">
    
    <label class="md-nav__link" for="nav-1">
      Home
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-1">
        Home
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../.." title="The Automation Hub" class="md-nav__link">
      The Automation Hub
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Tutorials
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Tutorials
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/overview/" title="Tools Overview" class="md-nav__link">
      Tools Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-2" type="checkbox" id="nav-2-2">
    
    <label class="md-nav__link" for="nav-2-2">
      Bet Angel Professional
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-2">
        Bet Angel Professional
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/betAngel/betAngel/" title="Overview - Bet Angel Pro" class="md-nav__link">
      Overview - Bet Angel Pro
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/betAngelbeginners/" title="Bet Angel - A beginner's guide" class="md-nav__link">
      Bet Angel - A beginner's guide
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/betAngelintermediate/" title="Bet Angel - An intermediate guide" class="md-nav__link">
      Bet Angel - An intermediate guide
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/betAngeladvanced/" title="Bet Angel - An advanced guide" class="md-nav__link">
      Bet Angel - An advanced guide
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/betAngelRatingsAutomation/" title="Ratings automation" class="md-nav__link">
      Ratings automation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/betAngelMarketFavouriteAutomation/" title="Market favourite automation" class="md-nav__link">
      Market favourite automation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/betAngelTippingAutomation/" title="Tipping automation" class="md-nav__link">
      Tipping automation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/betAngelSimultaneousMarkets/" title="Simultaneous markets" class="md-nav__link">
      Simultaneous markets
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/betAngelKellyStake/" title="Kelly Criterion staking" class="md-nav__link">
      Kelly Criterion staking
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-3" type="checkbox" id="nav-2-3">
    
    <label class="md-nav__link" for="nav-2-3">
      Gruss Betting Assistant
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-3">
        Gruss Betting Assistant
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/Gruss/Gruss/" title="Overview - Gruss" class="md-nav__link">
      Overview - Gruss
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/grussRatingsAutomation/" title="Ratings automation" class="md-nav__link">
      Ratings automation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/grussMarketFavouriteAutomation/" title="Market favourite automation" class="md-nav__link">
      Market favourite automation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/grusslSimultaneousMarkets/" title="Simultaneous markets" class="md-nav__link">
      Simultaneous markets
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/grussKellyStake/" title="Kelly Criterion staking" class="md-nav__link">
      Kelly Criterion staking
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-4" type="checkbox" id="nav-2-4">
    
    <label class="md-nav__link" for="nav-2-4">
      Cymatic Trader
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-4">
        Cymatic Trader
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/CymaticTrader/CymaticTrader/" title="Overview - Cymatic Trader" class="md-nav__link">
      Overview - Cymatic Trader
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/cymaticTraderRatingsAutomation/" title="Ratings automation" class="md-nav__link">
      Ratings automation
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      API
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        API
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../api/apiappkey/" title="How to access the Betfair API" class="md-nav__link">
      How to access the Betfair API
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../api/apiRtutorial/" title="API tutorials in R" class="md-nav__link">
      API tutorials in R
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../api/apiPythontutorial/" title="API tutorial in Python" class="md-nav__link">
      API tutorial in Python
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Historic Data
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Historic Data
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../historicData/dataSources/" title="Historic Data Sources" class="md-nav__link">
      Historic Data Sources
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../historicData/usingHistoricDataSite/" title="Downloading from the Historic Data site" class="md-nav__link">
      Downloading from the Historic Data site
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5" checked>
    
    <label class="md-nav__link" for="nav-5">
      Modelling
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Modelling
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../howToModel/" title="Intro to modelling" class="md-nav__link">
      Intro to modelling
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../howToModelTheAusOpen/" title="How to model the Australian Open" class="md-nav__link">
      How to model the Australian Open
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../AusOpenRTutorial/" title="Aus Open R Tutorial" class="md-nav__link">
      Aus Open R Tutorial
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../AusOpenPythonTutorial/" title="Aus Open Python Tutorial" class="md-nav__link">
      Aus Open Python Tutorial
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../EPLmodelPart1/" title="EPL 01. Data acquisition & exploration" class="md-nav__link">
      EPL 01. Data acquisition & exploration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../EPLmodelPart2/" title="EPL 02. Data preparation & feature engineering" class="md-nav__link">
      EPL 02. Data preparation & feature engineering
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../EPLmodelPart3/" title="EPL 03. Model building & hyperparameter tuning" class="md-nav__link">
      EPL 03. Model building & hyperparameter tuning
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../EPLmodelPart4/" title="EPL 04. Weekly predictions" class="md-nav__link">
      EPL 04. Weekly predictions
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../AFLmodelPart1/" title="AFL 01. Data cleaning" class="md-nav__link">
      AFL 01. Data cleaning
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
    <a href="./" title="AFL 02. Feature creation" class="md-nav__link md-nav__link--active">
      AFL 02. Feature creation
    </a>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../AFLmodelPart3/" title="AFL 03. Modelling" class="md-nav__link">
      AFL 03. Modelling
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../AFLmodelPart4/" title="AFL 04. Weekly predictions" class="md-nav__link">
      AFL 04. Weekly predictions
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../brownlowModelTutorial/" title="Modelling the Brownlow Medal" class="md-nav__link">
      Modelling the Brownlow Medal
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="afl-modelling-walkthrough">AFL Modelling Walkthrough<a class="headerlink" href="#afl-modelling-walkthrough" title="Permanent link">&para;</a></h1>
<h1 id="02-feature-creation">02. Feature Creation<a class="headerlink" href="#02-feature-creation" title="Permanent link">&para;</a></h1>
<p>These tutorials will walk you through how to construct your own basic AFL model. The output will be odds for each team to win, which will be shown on <a href="https://www.betfair.com.au/hub/tools/models/afl-prediction-model/">The Hub</a>.</p>
<p>In this notebook we will walk you through creating features from our dataset, which was cleaned in the first tutorial. Feature engineering is an integral part of the Data Science process. Creative and smart features can be the difference between an average performing model and a model profitable which beats the market odds.</p>
<hr />
<h2 id="grabbing-our-dataset">Grabbing Our Dataset<a class="headerlink" href="#grabbing-our-dataset" title="Permanent link">&para;</a></h2>
<p>First, we will import our required modules, as well as the prepare_afl_data function which we created in our afl_data_cleaning script. This essentially cleans all the data for us so that we're ready to explore the data and make some features.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Import modules</span>
<span class="kn">from</span> <span class="nn">afl_data_cleaning_v2</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">afl_data_cleaning_v2</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_columns&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># Use the prepare_afl_data function to prepare the data for us; this function condenses what we walked through in the previous tutorial</span>
<span class="n">afl_data</span> <span class="o">=</span> <span class="n">prepare_afl_data</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">afl_data</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</code></pre></div>
<table>
<thead>
<tr>
<th></th>
<th>team</th>
<th>f_odds</th>
<th>date</th>
<th>home_game</th>
<th>game</th>
<th>round</th>
<th>f_goals</th>
<th>f_behinds</th>
<th>f_points</th>
<th>f_margin</th>
<th>venue</th>
<th>opponent</th>
<th>f_opponent_goals</th>
<th>f_opponent_behinds</th>
<th>f_opponent_points</th>
<th>season</th>
<th>f_AF</th>
<th>f_B</th>
<th>f_BO</th>
<th>f_CCL</th>
<th>f_CG</th>
<th>f_CL</th>
<th>f_CM</th>
<th>f_CP</th>
<th>f_D</th>
<th>f_ED</th>
<th>f_FA</th>
<th>f_FF</th>
<th>f_G</th>
<th>f_GA</th>
<th>f_HB</th>
<th>f_HO</th>
<th>f_I50</th>
<th>f_ITC</th>
<th>f_K</th>
<th>f_M</th>
<th>f_MG</th>
<th>f_MI5</th>
<th>f_One.Percenters</th>
<th>f_R50</th>
<th>f_SC</th>
<th>f_SCL</th>
<th>f_SI</th>
<th>f_T</th>
<th>f_T5</th>
<th>f_TO</th>
<th>f_UP</th>
</tr>
</thead>
<tbody>
<tr>
<td>3154</td>
<td>Melbourne</td>
<td>1.5116</td>
<td>2018-08-26</td>
<td>1</td>
<td>15397</td>
<td>23</td>
<td>15</td>
<td>12</td>
<td>102</td>
<td>45</td>
<td>M.C.G.</td>
<td>GWS</td>
<td>8</td>
<td>9</td>
<td>57</td>
<td>2018</td>
<td>1712</td>
<td>8</td>
<td>12</td>
<td>10.0</td>
<td>38</td>
<td>30</td>
<td>12</td>
<td>139</td>
<td>403</td>
<td>302</td>
<td>13</td>
<td>19</td>
<td>15</td>
<td>14</td>
<td>181</td>
<td>48</td>
<td>54</td>
<td>59.0</td>
<td>222</td>
<td>106</td>
<td>6198.0</td>
<td>16</td>
<td>34</td>
<td>39</td>
<td>1768</td>
<td>20.0</td>
<td>147.0</td>
<td>60</td>
<td>2.0</td>
<td>53.0</td>
<td>269</td>
</tr>
<tr>
<td>3155</td>
<td>North Melbourne</td>
<td>1.3936</td>
<td>2018-08-26</td>
<td>0</td>
<td>15398</td>
<td>23</td>
<td>17</td>
<td>15</td>
<td>117</td>
<td>23</td>
<td>Docklands</td>
<td>St Kilda</td>
<td>14</td>
<td>10</td>
<td>94</td>
<td>2018</td>
<td>1707</td>
<td>13</td>
<td>7</td>
<td>15.0</td>
<td>50</td>
<td>24</td>
<td>6</td>
<td>131</td>
<td>425</td>
<td>322</td>
<td>14</td>
<td>18</td>
<td>17</td>
<td>13</td>
<td>201</td>
<td>32</td>
<td>59</td>
<td>77.0</td>
<td>224</td>
<td>106</td>
<td>5833.0</td>
<td>23</td>
<td>33</td>
<td>29</td>
<td>1735</td>
<td>9.0</td>
<td>154.0</td>
<td>48</td>
<td>9.0</td>
<td>66.0</td>
<td>300</td>
</tr>
<tr>
<td>3156</td>
<td>St Kilda</td>
<td>3.5178</td>
<td>2018-08-26</td>
<td>1</td>
<td>15398</td>
<td>23</td>
<td>14</td>
<td>10</td>
<td>94</td>
<td>-23</td>
<td>Docklands</td>
<td>North Melbourne</td>
<td>17</td>
<td>15</td>
<td>117</td>
<td>2018</td>
<td>1587</td>
<td>8</td>
<td>11</td>
<td>19.0</td>
<td>48</td>
<td>33</td>
<td>7</td>
<td>125</td>
<td>383</td>
<td>299</td>
<td>18</td>
<td>14</td>
<td>14</td>
<td>13</td>
<td>173</td>
<td>23</td>
<td>48</td>
<td>68.0</td>
<td>210</td>
<td>112</td>
<td>5522.0</td>
<td>14</td>
<td>46</td>
<td>35</td>
<td>1568</td>
<td>14.0</td>
<td>95.0</td>
<td>50</td>
<td>7.0</td>
<td>77.0</td>
<td>269</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="creating-a-feature-dataframe">Creating A Feature DataFrame<a class="headerlink" href="#creating-a-feature-dataframe" title="Permanent link">&para;</a></h2>
<p>Let's create a feature DataFrame and merge all of our features into this DataFrame as we go.</p>
<div class="highlight"><pre><span></span><code><span class="n">features</span> <span class="o">=</span> <span class="n">afl_data</span><span class="p">[[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;game&#39;</span><span class="p">,</span> <span class="s1">&#39;team&#39;</span><span class="p">,</span> <span class="s1">&#39;opponent&#39;</span><span class="p">,</span> <span class="s1">&#39;venue&#39;</span><span class="p">,</span> <span class="s1">&#39;home_game&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</code></pre></div>
<h3 id="what-each-column-refers-to">What Each Column Refers To<a class="headerlink" href="#what-each-column-refers-to" title="Permanent link">&para;</a></h3>
<p>Below is a DataFrame which outlines what each column refers to.</p>
<div class="highlight"><pre><span></span><code><span class="n">column_abbreviations</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;data/afl_data_columns_mapping.csv&quot;</span><span class="p">)</span>
<span class="n">column_abbreviations</span>
</code></pre></div>
<table>
<thead>
<tr>
<th></th>
<th>Feature Abbreviated</th>
<th>Feature</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>GA</td>
<td>Goal Assists</td>
</tr>
<tr>
<td>1</td>
<td>CP</td>
<td>Contested Possessions</td>
</tr>
<tr>
<td>2</td>
<td>UP</td>
<td>Uncontested Possessions</td>
</tr>
<tr>
<td>3</td>
<td>ED</td>
<td>Effective Disposals</td>
</tr>
<tr>
<td>4</td>
<td>CM</td>
<td>Contested Marks</td>
</tr>
<tr>
<td>5</td>
<td>MI5</td>
<td>Marks Inside 50</td>
</tr>
<tr>
<td>6</td>
<td>One.Percenters</td>
<td>One Percenters</td>
</tr>
<tr>
<td>7</td>
<td>BO</td>
<td>Bounces</td>
</tr>
<tr>
<td>8</td>
<td>K</td>
<td>Kicks</td>
</tr>
<tr>
<td>9</td>
<td>HB</td>
<td>Handballs</td>
</tr>
<tr>
<td>10</td>
<td>D</td>
<td>Disposals</td>
</tr>
<tr>
<td>11</td>
<td>M</td>
<td>Marks</td>
</tr>
<tr>
<td>12</td>
<td>G</td>
<td>Goals</td>
</tr>
<tr>
<td>13</td>
<td>B</td>
<td>Behinds</td>
</tr>
<tr>
<td>14</td>
<td>T</td>
<td>Tackles</td>
</tr>
<tr>
<td>15</td>
<td>HO</td>
<td>Hitouts</td>
</tr>
<tr>
<td>16</td>
<td>I50</td>
<td>Inside 50s</td>
</tr>
<tr>
<td>17</td>
<td>CL</td>
<td>Clearances</td>
</tr>
<tr>
<td>18</td>
<td>CG</td>
<td>Clangers</td>
</tr>
<tr>
<td>19</td>
<td>R50</td>
<td>Rebound 50s</td>
</tr>
<tr>
<td>20</td>
<td>FF</td>
<td>Frees For</td>
</tr>
<tr>
<td>21</td>
<td>FA</td>
<td>Frees Against</td>
</tr>
<tr>
<td>22</td>
<td>AF</td>
<td>AFL Fantasy Points</td>
</tr>
<tr>
<td>23</td>
<td>SC</td>
<td>Supercoach Points</td>
</tr>
<tr>
<td>24</td>
<td>CCL</td>
<td>Centre Clearances</td>
</tr>
<tr>
<td>25</td>
<td>SCL</td>
<td>Stoppage Clearances</td>
</tr>
<tr>
<td>26</td>
<td>SI</td>
<td>Score Involvements</td>
</tr>
<tr>
<td>27</td>
<td>MG</td>
<td>Metres Gained</td>
</tr>
<tr>
<td>28</td>
<td>TO</td>
<td>Turnovers</td>
</tr>
<tr>
<td>29</td>
<td>ITC</td>
<td>Intercepts</td>
</tr>
<tr>
<td>30</td>
<td>T5</td>
<td>Tackles Inside 50</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="feature-creation">Feature Creation<a class="headerlink" href="#feature-creation" title="Permanent link">&para;</a></h2>
<p>Now let's think about what features we can create. We have a enormous amount of stats to sift through. To start, let's create some simple features based on our domain knowledge of Aussie Rules.</p>
<h3 id="creating-expontentially-weighted-rolling-averages-as-features">Creating Expontentially Weighted Rolling Averages as Features<a class="headerlink" href="#creating-expontentially-weighted-rolling-averages-as-features" title="Permanent link">&para;</a></h3>
<p>Next, we will create rolling averages of statistics such as Tackles, which we will use as features.</p>
<p>It is fair to assume that a team's performance in a certain stat may have predictive power to the overall result. And in general, if a team consistently performs well in this stat, this may have predictive power to the result of their future games. We can't simply train a model on stats from the game which we are trying to predict (i.e. data that we don't have before the game begins), as this will leak the result. We need to train our model on past data. One way of doing this is to train our model on average stats over a certain amount of games. If a team is averaging high in this stat, this may give insight into if they are a strong team. Similarly, if the team is averaging poorly in this stat (relative to the team they are playing), this may have predictive power and give rise to a predicted loss.</p>
<p>To do this we will create a function which calculates the rolling averages, known as create_exp_weighted_avgs, which takes our cleaned DataFrame as an input, as well as the alpha which, when higher, weights recent performances more than old performances. To read more about expontentially weighted moving averages, please read the documentation <a href="https://pandas.pydata.org/pandas-docs/stable/generated/pandas.DataFrame.ewm.html">here</a>.</p>
<p>First, we will grab all the columns which we want to create EMAs for, and then use our function to create the average for that column. We will create a new DataFrame and add these columns to this new DataFrame.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Define a function which returns a DataFrame with the expontential moving average for each numeric stat</span>
<span class="k">def</span> <span class="nf">create_exp_weighted_avgs</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">span</span><span class="p">):</span>
    <span class="c1"># Create a copy of the df with only the game id and the team - we will add cols to this df</span>
    <span class="n">ema_features</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;game&#39;</span><span class="p">,</span> <span class="s1">&#39;team&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">feature_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;f_&#39;</span><span class="p">)]</span> <span class="c1"># Get a list of columns we will iterate over</span>

    <span class="k">for</span> <span class="n">feature_name</span> <span class="ow">in</span> <span class="n">feature_names</span><span class="p">:</span>
        <span class="n">feature_ema</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;team&#39;</span><span class="p">)[</span><span class="n">feature_name</span><span class="p">]</span>
                         <span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="n">span</span><span class="p">)</span>
                                                    <span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                                                    <span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))))</span>
        <span class="n">ema_features</span><span class="p">[</span><span class="n">feature_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature_ema</span>

    <span class="k">return</span> <span class="n">ema_features</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">features_rolling_averages</span> <span class="o">=</span> <span class="n">create_exp_weighted_avgs</span><span class="p">(</span><span class="n">afl_data</span><span class="p">,</span> <span class="n">span</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">features_rolling_averages</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</code></pre></div>
<table>
<thead>
<tr>
<th></th>
<th>game</th>
<th>team</th>
<th>f_odds</th>
<th>f_goals</th>
<th>f_behinds</th>
<th>f_points</th>
<th>f_margin</th>
<th>f_opponent_goals</th>
<th>f_opponent_behinds</th>
<th>f_opponent_points</th>
<th>f_AF</th>
<th>f_B</th>
<th>f_BO</th>
<th>f_CCL</th>
<th>f_CG</th>
<th>f_CL</th>
<th>f_CM</th>
<th>f_CP</th>
<th>f_D</th>
<th>f_ED</th>
<th>f_FA</th>
<th>f_FF</th>
<th>f_G</th>
<th>f_GA</th>
<th>f_HB</th>
<th>f_HO</th>
<th>f_I50</th>
<th>f_ITC</th>
<th>f_K</th>
<th>f_M</th>
<th>f_MG</th>
<th>f_MI5</th>
<th>f_One.Percenters</th>
<th>f_R50</th>
<th>f_SC</th>
<th>f_SCL</th>
<th>f_SI</th>
<th>f_T</th>
<th>f_T5</th>
<th>f_TO</th>
<th>f_UP</th>
</tr>
</thead>
<tbody>
<tr>
<td>3152</td>
<td>15396</td>
<td>West Coast</td>
<td>2.094236</td>
<td>12.809630</td>
<td>10.047145</td>
<td>86.904928</td>
<td>8.888770</td>
<td>11.435452</td>
<td>9.403444</td>
<td>78.016158</td>
<td>3193.612782</td>
<td>16.472115</td>
<td>11.958482</td>
<td>23.379562</td>
<td>100.095244</td>
<td>68.252001</td>
<td>27.688669</td>
<td>284.463270</td>
<td>719.884644</td>
<td>525.878017</td>
<td>36.762440</td>
<td>44.867118</td>
<td>25.618202</td>
<td>17.522871</td>
<td>270.478779</td>
<td>88.139376</td>
<td>105.698031</td>
<td>148.005305</td>
<td>449.405865</td>
<td>201.198907</td>
<td>11581.929999</td>
<td>20.048124</td>
<td>95.018480</td>
<td>74.180967</td>
<td>3314.157893</td>
<td>44.872398</td>
<td>177.894442</td>
<td>126.985101</td>
<td>20.565549</td>
<td>138.876613</td>
<td>438.848376</td>
</tr>
<tr>
<td>3153</td>
<td>15397</td>
<td>GWS</td>
<td>1.805565</td>
<td>13.100372</td>
<td>13.179329</td>
<td>91.781563</td>
<td>18.527618</td>
<td>10.371198</td>
<td>11.026754</td>
<td>73.253945</td>
<td>3165.127358</td>
<td>19.875913</td>
<td>12.947209</td>
<td>25.114002</td>
<td>105.856671</td>
<td>80.609640</td>
<td>23.374884</td>
<td>303.160047</td>
<td>741.439198</td>
<td>534.520295</td>
<td>42.597317</td>
<td>38.160889</td>
<td>26.208715</td>
<td>18.688880</td>
<td>300.188301</td>
<td>81.540693</td>
<td>106.989070</td>
<td>143.032506</td>
<td>441.250897</td>
<td>173.050118</td>
<td>12091.630837</td>
<td>21.106142</td>
<td>103.077097</td>
<td>80.201059</td>
<td>3419.245919</td>
<td>55.495610</td>
<td>219.879895</td>
<td>138.202470</td>
<td>25.313148</td>
<td>135.966798</td>
<td>438.466439</td>
</tr>
<tr>
<td>3154</td>
<td>15397</td>
<td>Melbourne</td>
<td>1.706488</td>
<td>15.157271</td>
<td>13.815113</td>
<td>104.758740</td>
<td>25.170429</td>
<td>11.814319</td>
<td>8.702396</td>
<td>79.588311</td>
<td>3312.408470</td>
<td>22.077317</td>
<td>7.724955</td>
<td>28.364418</td>
<td>114.399147</td>
<td>78.406069</td>
<td>26.934677</td>
<td>324.352577</td>
<td>775.176933</td>
<td>547.385948</td>
<td>39.353251</td>
<td>36.025646</td>
<td>30.308918</td>
<td>22.461080</td>
<td>348.613592</td>
<td>99.787800</td>
<td>120.339062</td>
<td>154.417642</td>
<td>426.563341</td>
<td>178.102118</td>
<td>12395.717925</td>
<td>32.168752</td>
<td>96.390688</td>
<td>63.786515</td>
<td>3427.596843</td>
<td>50.041649</td>
<td>232.287556</td>
<td>144.875098</td>
<td>23.789233</td>
<td>149.042149</td>
<td>456.988552</td>
</tr>
<tr>
<td>3155</td>
<td>15398</td>
<td>North Melbourne</td>
<td>2.272313</td>
<td>12.721783</td>
<td>10.733785</td>
<td>87.064486</td>
<td>-1.214246</td>
<td>12.915796</td>
<td>10.783958</td>
<td>88.278732</td>
<td>3066.272143</td>
<td>17.322710</td>
<td>9.815243</td>
<td>26.015421</td>
<td>106.465181</td>
<td>67.504286</td>
<td>26.064079</td>
<td>291.259574</td>
<td>736.279779</td>
<td>534.154748</td>
<td>34.301603</td>
<td>40.908551</td>
<td>25.386136</td>
<td>17.816570</td>
<td>341.210547</td>
<td>81.541130</td>
<td>102.589427</td>
<td>145.265493</td>
<td>395.069232</td>
<td>173.089408</td>
<td>10875.002463</td>
<td>21.802751</td>
<td>82.347511</td>
<td>70.416194</td>
<td>3171.120023</td>
<td>41.488865</td>
<td>197.620152</td>
<td>122.547684</td>
<td>22.286256</td>
<td>142.780474</td>
<td>450.374058</td>
</tr>
<tr>
<td>3156</td>
<td>15398</td>
<td>St Kilda</td>
<td>5.516150</td>
<td>10.464266</td>
<td>11.957047</td>
<td>74.742643</td>
<td>-21.138101</td>
<td>14.105551</td>
<td>11.247440</td>
<td>95.880745</td>
<td>3094.163405</td>
<td>20.523847</td>
<td>14.569589</td>
<td>24.134276</td>
<td>102.540441</td>
<td>66.976211</td>
<td>18.018350</td>
<td>270.674857</td>
<td>773.086015</td>
<td>573.769838</td>
<td>41.319843</td>
<td>36.198820</td>
<td>20.850476</td>
<td>14.443658</td>
<td>364.405251</td>
<td>63.498760</td>
<td>103.803779</td>
<td>130.494307</td>
<td>408.680763</td>
<td>184.780054</td>
<td>10765.717942</td>
<td>21.572806</td>
<td>94.731555</td>
<td>65.790561</td>
<td>3228.278599</td>
<td>42.841935</td>
<td>196.086493</td>
<td>115.901425</td>
<td>18.796764</td>
<td>127.364334</td>
<td>508.844514</td>
</tr>
</tbody>
</table>
<p>As you can see our function worked perfectly! Now we have a full DataFrame of exponentially weighted moving averages. Note that as these rolling averages have been shifted by 1 to ensure no data leakage, the first round of the data will have all NA values. We can drop these later.</p>
<p>Let's add these averages to our features DataFrame</p>
<div class="highlight"><pre><span></span><code><span class="n">features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">features_rolling_averages</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;game&#39;</span><span class="p">,</span> <span class="s1">&#39;team&#39;</span><span class="p">])</span>
</code></pre></div>
<h3 id="creating-a-form-between-the-teams-feature">Creating a 'Form Between the Teams' Feature<a class="headerlink" href="#creating-a-form-between-the-teams-feature" title="Permanent link">&para;</a></h3>
<p>It is well known in Aussie Rules that often some teams perform better against certain teams than others. If we isolate our features to pure stats based on previous games not between the teams playing, or elo ratings, we won't account for any relationships between certain teams. An example is the <a href="https://en.wikipedia.org/wiki/Kennett_curse">Kennett Curse</a>, where Geelong won 11 consecutive games against Hawthorn, despite being similarly matched teams. Let's create a feature which calculates how many games a team has won against their opposition over a given window of games.</p>
<p>To do this, we will need to use historical data that dates back well before our current DataFrame starts at. Otherwise we will be using a lot of our games to calculate form, meaning we will have to drop these rows before feeding it into an algorithm. So let's use our prepare_match_results function which we defined in the afl_data_cleaning tutorial to grab a clean DataFrame of all match results since 1897. We can then calculate the form and join this to our current DataFrame.</p>
<div class="highlight"><pre><span></span><code><span class="n">match_results</span> <span class="o">=</span> <span class="n">afl_data_cleaning_v2</span><span class="o">.</span><span class="n">get_cleaned_match_results</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">match_results</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</code></pre></div>
<table>
<thead>
<tr>
<th></th>
<th>game</th>
<th>date</th>
<th>round</th>
<th>team</th>
<th>goals</th>
<th>behinds</th>
<th>points</th>
<th>margin</th>
<th>venue</th>
<th>opponent</th>
<th>opponent_goals</th>
<th>opponent_behinds</th>
<th>opponent_points</th>
<th>home_game</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>1</td>
<td>1897-05-08</td>
<td>1</td>
<td>Fitzroy</td>
<td>6</td>
<td>13</td>
<td>49</td>
<td>33</td>
<td>Brunswick St</td>
<td>Carlton</td>
<td>2</td>
<td>4</td>
<td>16</td>
<td>1</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>1897-05-08</td>
<td>1</td>
<td>Carlton</td>
<td>2</td>
<td>4</td>
<td>16</td>
<td>-33</td>
<td>Brunswick St</td>
<td>Fitzroy</td>
<td>6</td>
<td>13</td>
<td>49</td>
<td>0</td>
</tr>
<tr>
<td>2</td>
<td>2</td>
<td>1897-05-08</td>
<td>1</td>
<td>Collingwood</td>
<td>5</td>
<td>11</td>
<td>41</td>
<td>25</td>
<td>Victoria Park</td>
<td>St Kilda</td>
<td>2</td>
<td>4</td>
<td>16</td>
<td>1</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><span class="n">form_btwn_teams</span> <span class="o">=</span> <span class="n">match_results</span><span class="p">[[</span><span class="s1">&#39;game&#39;</span><span class="p">,</span> <span class="s1">&#39;team&#39;</span><span class="p">,</span> <span class="s1">&#39;opponent&#39;</span><span class="p">,</span> <span class="s1">&#39;margin&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">form_btwn_teams</span><span class="p">[</span><span class="s1">&#39;f_form_margin_btwn_teams&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">match_results</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;team&#39;</span><span class="p">,</span> <span class="s1">&#39;opponent&#39;</span><span class="p">])[</span><span class="s1">&#39;margin&#39;</span><span class="p">]</span>
                                                          <span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">())</span>
                                                          <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

<span class="n">form_btwn_teams</span><span class="p">[</span><span class="s1">&#39;f_form_past_5_btwn_teams&#39;</span><span class="p">]</span> <span class="o">=</span> \
<span class="p">(</span><span class="n">match_results</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">win</span><span class="o">=</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">margin</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;columns&#39;</span><span class="p">))</span>
              <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;team&#39;</span><span class="p">,</span> <span class="s1">&#39;opponent&#39;</span><span class="p">])[</span><span class="s1">&#39;win&#39;</span><span class="p">]</span>
              <span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">()</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span>
              <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">form_btwn_teams</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</code></pre></div>
<table>
<thead>
<tr>
<th></th>
<th>game</th>
<th>team</th>
<th>opponent</th>
<th>margin</th>
<th>f_form_margin_btwn_teams</th>
<th>f_form_past_5_btwn_teams</th>
</tr>
</thead>
<tbody>
<tr>
<td>30793</td>
<td>15397</td>
<td>Melbourne</td>
<td>GWS</td>
<td>45</td>
<td>-23.2</td>
<td>2.0</td>
</tr>
<tr>
<td>30794</td>
<td>15398</td>
<td>St Kilda</td>
<td>North Melbourne</td>
<td>-23</td>
<td>-3.2</td>
<td>2.0</td>
</tr>
<tr>
<td>30795</td>
<td>15398</td>
<td>North Melbourne</td>
<td>St Kilda</td>
<td>23</td>
<td>3.2</td>
<td>3.0</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><span class="c1"># Merge to our features df</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">form_btwn_teams</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;margin&#39;</span><span class="p">]),</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;game&#39;</span><span class="p">,</span> <span class="s1">&#39;team&#39;</span><span class="p">,</span> <span class="s1">&#39;opponent&#39;</span><span class="p">])</span>
</code></pre></div>
<h3 id="creating-efficiency-features">Creating Efficiency Features<a class="headerlink" href="#creating-efficiency-features" title="Permanent link">&para;</a></h3>
<h4 id="disposal-efficiency">Disposal Efficiency<a class="headerlink" href="#disposal-efficiency" title="Permanent link">&para;</a></h4>
<p>Disposal efficiency is pivotal in Aussie Rules football. If you are dispose of the ball effectively you are much more likely to score and much less likely to concede goals than if you dispose of it ineffectively.</p>
<p>Let's create a disposal efficiency feature by dividing Effective Disposals by Disposals.</p>
<h4 id="inside-50rebound-50-efficiency">Inside 50/Rebound 50 Efficiency<a class="headerlink" href="#inside-50rebound-50-efficiency" title="Permanent link">&para;</a></h4>
<p>Similarly, one could hypothesise that teams who keep the footy in their Inside 50 regularly will be more likely to score, whilst teams who are effective at getting the ball out of their Defensive 50 will be less likely to concede. Let's use this logic to create Inside 50 Efficiency and Rebound 50 Efficiency features.</p>
<p>The formula used will be:
<div class="highlight"><pre><span></span><code>Inside 50 Efficiency = R50_Opponents / I50 (lower is better).
Rebound 50 Efficiency = R50 / I50_Opponents (higher is better).
</code></pre></div></p>
<p>Using these formulas, I50 Efficiency = R50 Efficiency_Opponent. So we will just need to create the formulas for I50 efficiency.
To create these features we will need the opposition's Inside 50s/Rebound 50s. So we will split out data into two DataFrames, create a new DataFrame by joining these two DataFrames on the Game, calculate our efficiency features, then join our features with our main features DataFrame.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Get each match on single rows</span>
<span class="n">single_row_df</span> <span class="o">=</span> <span class="p">(</span><span class="n">afl_data</span><span class="p">[[</span><span class="s1">&#39;game&#39;</span><span class="p">,</span> <span class="s1">&#39;team&#39;</span><span class="p">,</span> <span class="s1">&#39;f_I50&#39;</span><span class="p">,</span> <span class="s1">&#39;f_R50&#39;</span><span class="p">,</span> <span class="s1">&#39;f_D&#39;</span><span class="p">,</span> <span class="s1">&#39;f_ED&#39;</span><span class="p">,</span> <span class="s1">&#39;home_game&#39;</span><span class="p">,</span> <span class="p">]]</span>
                    <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;home_game == 1&#39;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;team&#39;</span><span class="p">:</span> <span class="s1">&#39;home_team&#39;</span><span class="p">,</span> <span class="s1">&#39;f_I50&#39;</span><span class="p">:</span> <span class="s1">&#39;f_I50_home&#39;</span><span class="p">,</span> <span class="s1">&#39;f_R50&#39;</span><span class="p">:</span> <span class="s1">&#39;f_R50_home&#39;</span><span class="p">,</span> <span class="s1">&#39;f_D&#39;</span><span class="p">:</span> <span class="s1">&#39;f_D_home&#39;</span><span class="p">,</span> <span class="s1">&#39;f_ED&#39;</span><span class="p">:</span> <span class="s1">&#39;f_ED_home&#39;</span><span class="p">})</span>
                    <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;home_game&#39;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">,</span> <span class="n">afl_data</span><span class="p">[[</span><span class="s1">&#39;game&#39;</span><span class="p">,</span> <span class="s1">&#39;team&#39;</span><span class="p">,</span> <span class="s1">&#39;f_I50&#39;</span><span class="p">,</span> <span class="s1">&#39;f_R50&#39;</span><span class="p">,</span> <span class="s1">&#39;f_D&#39;</span><span class="p">,</span> <span class="s1">&#39;f_ED&#39;</span><span class="p">,</span> <span class="s1">&#39;home_game&#39;</span><span class="p">]]</span>
                                    <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;home_game == 0&#39;</span><span class="p">)</span>
                                    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;team&#39;</span><span class="p">:</span> <span class="s1">&#39;away_team&#39;</span><span class="p">,</span> <span class="s1">&#39;f_I50&#39;</span><span class="p">:</span> <span class="s1">&#39;f_I50_away&#39;</span><span class="p">,</span> <span class="s1">&#39;f_R50&#39;</span><span class="p">:</span> <span class="s1">&#39;f_R50_away&#39;</span><span class="p">,</span> <span class="s1">&#39;f_D&#39;</span><span class="p">:</span> <span class="s1">&#39;f_D_away&#39;</span><span class="p">,</span> <span class="s1">&#39;f_ED&#39;</span><span class="p">:</span> <span class="s1">&#39;f_ED_away&#39;</span><span class="p">})</span>
                                    <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;home_game&#39;</span><span class="p">),</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;game&#39;</span><span class="p">))</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">single_row_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div>
<table>
<thead>
<tr>
<th></th>
<th>game</th>
<th>home_team</th>
<th>f_I50_home</th>
<th>f_R50_home</th>
<th>f_D_home</th>
<th>f_ED_home</th>
<th>away_team</th>
<th>f_I50_away</th>
<th>f_R50_away</th>
<th>f_D_away</th>
<th>f_ED_away</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>13764</td>
<td>Carlton</td>
<td>69</td>
<td>21</td>
<td>373</td>
<td>268</td>
<td>Richmond</td>
<td>37</td>
<td>50</td>
<td>316</td>
<td>226</td>
</tr>
<tr>
<td>1</td>
<td>13765</td>
<td>Geelong</td>
<td>54</td>
<td>40</td>
<td>428</td>
<td>310</td>
<td>St Kilda</td>
<td>52</td>
<td>45</td>
<td>334</td>
<td>246</td>
</tr>
<tr>
<td>2</td>
<td>13766</td>
<td>Collingwood</td>
<td>70</td>
<td>38</td>
<td>398</td>
<td>289</td>
<td>Port Adelaide</td>
<td>50</td>
<td>44</td>
<td>331</td>
<td>232</td>
</tr>
<tr>
<td>3</td>
<td>13767</td>
<td>Adelaide</td>
<td>59</td>
<td>38</td>
<td>366</td>
<td>264</td>
<td>Hawthorn</td>
<td>54</td>
<td>38</td>
<td>372</td>
<td>264</td>
</tr>
<tr>
<td>4</td>
<td>13768</td>
<td>Brisbane</td>
<td>50</td>
<td>39</td>
<td>343</td>
<td>227</td>
<td>Fremantle</td>
<td>57</td>
<td>30</td>
<td>351</td>
<td>250</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><span class="n">single_row_df</span> <span class="o">=</span> <span class="n">single_row_df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">f_I50_efficiency_home</span><span class="o">=</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">f_R50_away</span> <span class="o">/</span> <span class="n">df</span><span class="o">.</span><span class="n">f_I50_home</span><span class="p">,</span>
                                    <span class="n">f_I50_efficiency_away</span><span class="o">=</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">f_R50_home</span> <span class="o">/</span> <span class="n">df</span><span class="o">.</span><span class="n">f_I50_away</span><span class="p">)</span>

<span class="n">feature_efficiency_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;f_I50_efficiency_home&#39;</span><span class="p">,</span> <span class="s1">&#39;f_I50_efficiency_away&#39;</span><span class="p">]</span>

<span class="c1"># Now let&#39;s create an Expontentially Weighted Moving Average for these features - we will need to reshape our DataFrame to do this</span>
<span class="n">efficiency_features_multi_row</span> <span class="o">=</span> <span class="p">(</span><span class="n">single_row_df</span><span class="p">[[</span><span class="s1">&#39;game&#39;</span><span class="p">,</span> <span class="s1">&#39;home_team&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">feature_efficiency_cols</span><span class="p">]</span>
                                    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>
                                        <span class="s1">&#39;home_team&#39;</span><span class="p">:</span> <span class="s1">&#39;team&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;f_I50_efficiency_home&#39;</span><span class="p">:</span> <span class="s1">&#39;f_I50_efficiency&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;f_I50_efficiency_away&#39;</span><span class="p">:</span> <span class="s1">&#39;f_I50_efficiency_opponent&#39;</span><span class="p">,</span>
                                    <span class="p">})</span>
                                    <span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">single_row_df</span><span class="p">[[</span><span class="s1">&#39;game&#39;</span><span class="p">,</span> <span class="s1">&#39;away_team&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">feature_efficiency_cols</span><span class="p">]</span>
                                                 <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>
                                                     <span class="s1">&#39;away_team&#39;</span><span class="p">:</span> <span class="s1">&#39;team&#39;</span><span class="p">,</span>
                                                     <span class="s1">&#39;f_I50_efficiency_home&#39;</span><span class="p">:</span> <span class="s1">&#39;f_I50_efficiency_opponent&#39;</span><span class="p">,</span>
                                                     <span class="s1">&#39;f_I50_efficiency_away&#39;</span><span class="p">:</span> <span class="s1">&#39;f_I50_efficiency&#39;</span><span class="p">,</span>
                                                 <span class="p">})),</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                                    <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;game&#39;</span><span class="p">)</span>
                                    <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

<span class="n">efficiency_features</span> <span class="o">=</span> <span class="n">efficiency_features_multi_row</span><span class="p">[[</span><span class="s1">&#39;game&#39;</span><span class="p">,</span> <span class="s1">&#39;team&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">feature_efficiency_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;f_I50_efficiency&#39;</span><span class="p">,</span> <span class="s1">&#39;f_I50_efficiency_opponent&#39;</span><span class="p">]</span>

<span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">feature_efficiency_cols</span><span class="p">:</span>
    <span class="n">efficiency_features</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">efficiency_features_multi_row</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;team&#39;</span><span class="p">)[</span><span class="n">feature</span><span class="p">]</span>
                                        <span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>

<span class="c1"># Get feature efficiency df back onto single rows</span>
<span class="n">efficiency_features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">efficiency_features</span><span class="p">,</span> <span class="n">afl_data</span><span class="p">[[</span><span class="s1">&#39;game&#39;</span><span class="p">,</span> <span class="s1">&#39;team&#39;</span><span class="p">,</span> <span class="s1">&#39;home_game&#39;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;game&#39;</span><span class="p">,</span> <span class="s1">&#39;team&#39;</span><span class="p">])</span>
<span class="n">efficiency_features_single_row</span> <span class="o">=</span> <span class="p">(</span><span class="n">efficiency_features</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;home_game == 1&#39;</span><span class="p">)</span>
                                    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>
                                        <span class="s1">&#39;team&#39;</span><span class="p">:</span> <span class="s1">&#39;home_team&#39;</span><span class="p">,</span> 
                                        <span class="s1">&#39;f_I50_efficiency&#39;</span><span class="p">:</span> <span class="s1">&#39;f_I50_efficiency_home&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;f_I50_efficiency_opponent&#39;</span><span class="p">:</span> <span class="s1">&#39;f_R50_efficiency_home&#39;</span><span class="p">})</span>
                                    <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;home_game&#39;</span><span class="p">)</span>
                                    <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">,</span> <span class="p">(</span><span class="n">efficiency_features</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;home_game == 0&#39;</span><span class="p">)</span>
                                                        <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>
                                                            <span class="s1">&#39;team&#39;</span><span class="p">:</span> <span class="s1">&#39;away_team&#39;</span><span class="p">,</span>
                                                            <span class="s1">&#39;f_I50_efficiency&#39;</span><span class="p">:</span> <span class="s1">&#39;f_I50_efficiency_away&#39;</span><span class="p">,</span>
                                                            <span class="s1">&#39;f_I50_efficiency_opponent&#39;</span><span class="p">:</span> <span class="s1">&#39;f_R50_efficiency_away&#39;</span><span class="p">})</span>
                                                        <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;home_game&#39;</span><span class="p">)),</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;game&#39;</span><span class="p">))</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">efficiency_features_single_row</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</code></pre></div>
<table>
<thead>
<tr>
<th></th>
<th>game</th>
<th>home_team</th>
<th>f_I50_efficiency_home</th>
<th>f_R50_efficiency_home</th>
<th>away_team</th>
<th>f_I50_efficiency_away</th>
<th>f_R50_efficiency_away</th>
</tr>
</thead>
<tbody>
<tr>
<td>1580</td>
<td>15394</td>
<td>Carlton</td>
<td>0.730668</td>
<td>0.675002</td>
<td>Adelaide</td>
<td>0.691614</td>
<td>0.677128</td>
</tr>
<tr>
<td>1581</td>
<td>15395</td>
<td>Sydney</td>
<td>0.699994</td>
<td>0.778280</td>
<td>Hawthorn</td>
<td>0.699158</td>
<td>0.673409</td>
</tr>
<tr>
<td>1582</td>
<td>15396</td>
<td>Brisbane</td>
<td>0.683604</td>
<td>0.691730</td>
<td>West Coast</td>
<td>0.696822</td>
<td>0.709605</td>
</tr>
<tr>
<td>1583</td>
<td>15397</td>
<td>Melbourne</td>
<td>0.667240</td>
<td>0.692632</td>
<td>GWS</td>
<td>0.684525</td>
<td>0.753783</td>
</tr>
<tr>
<td>1584</td>
<td>15398</td>
<td>St Kilda</td>
<td>0.730843</td>
<td>0.635819</td>
<td>North Melbourne</td>
<td>0.697018</td>
<td>0.654991</td>
</tr>
</tbody>
</table>
<p>We will merge these features back to our features df later, when the features data frame is on a single row as well.</p>
<h3 id="creating-an-elo-feature">Creating an Elo Feature<a class="headerlink" href="#creating-an-elo-feature" title="Permanent link">&para;</a></h3>
<p>Another feature which we could create is an Elo feature. If you don't know what Elo is, go ahead and read our article on it <a href="https://www.betfair.com.au/hub/better-betting/betting-strategies/tennis/tennis-elo-modelling/">here</a>. We have also written a guide on using elo to model the 2018 FIFA World Cup <a href="https://www.betfair.com.au/hub/how-to-use-elo-to-model-the-world-cup/">here</a>.</p>
<p>Essentially, Elo ratings increase if you win. The amount the rating increases is based on how strong the opponent is relative to the team who won. Weak teams get more points for beating stronger teams than they do for beating weaker teams, and vice versa for losses (teams lose points for losses).</p>
<p>Mathematically, Elo ratings can also assign a probability for winning or losing based on the two Elo Ratings of the teams playing.</p>
<p>So let's get into it. We will first define a function which calculates the elo for each team and applies these elos to our DataFrame.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Define a function which finds the elo for each team in each game and returns a dictionary with the game ID as a key and the</span>
<span class="c1"># elos as the key&#39;s value, in a list. It also outputs the probabilities and a dictionary of the final elos for each team</span>
<span class="k">def</span> <span class="nf">elo_applier</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">k_factor</span><span class="p">):</span>
    <span class="c1"># Initialise a dictionary with default elos for each team</span>
    <span class="n">elo_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">team</span><span class="p">:</span> <span class="mi">1500</span> <span class="k">for</span> <span class="n">team</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;team&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()}</span>
    <span class="n">elos</span><span class="p">,</span> <span class="n">elo_probs</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>

    <span class="c1"># Get a home and away dataframe so that we can get the teams on the same row</span>
    <span class="n">home_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">home_game</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;team&#39;</span><span class="p">,</span> <span class="s1">&#39;game&#39;</span><span class="p">,</span> <span class="s1">&#39;f_margin&#39;</span><span class="p">,</span> <span class="s1">&#39;home_game&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;team&#39;</span><span class="p">:</span> <span class="s1">&#39;home_team&#39;</span><span class="p">})</span>
    <span class="n">away_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">home_game</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;team&#39;</span><span class="p">,</span> <span class="s1">&#39;game&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;team&#39;</span><span class="p">:</span> <span class="s1">&#39;away_team&#39;</span><span class="p">})</span>

    <span class="n">df</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">home_df</span><span class="p">,</span> <span class="n">away_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;game&#39;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;game&#39;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s1">&#39;game&#39;</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

    <span class="c1"># Loop over the rows in the DataFrame</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="c1"># Get the Game ID</span>
        <span class="n">game_id</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;game&#39;</span><span class="p">]</span>

        <span class="c1"># Get the margin</span>
        <span class="n">margin</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;f_margin&#39;</span><span class="p">]</span>

        <span class="c1"># If the game already has the elos for the home and away team in the elos dictionary, go to the next game</span>
        <span class="k">if</span> <span class="n">game_id</span> <span class="ow">in</span> <span class="n">elos</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">continue</span>

        <span class="c1"># Get the team and opposition</span>
        <span class="n">home_team</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;home_team&#39;</span><span class="p">]</span>
        <span class="n">away_team</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;away_team&#39;</span><span class="p">]</span>

        <span class="c1"># Get the team and opposition elo score</span>
        <span class="n">home_team_elo</span> <span class="o">=</span> <span class="n">elo_dict</span><span class="p">[</span><span class="n">home_team</span><span class="p">]</span>
        <span class="n">away_team_elo</span> <span class="o">=</span> <span class="n">elo_dict</span><span class="p">[</span><span class="n">away_team</span><span class="p">]</span>

        <span class="c1"># Calculated the probability of winning for the team and opposition</span>
        <span class="n">prob_win_home</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">10</span><span class="o">**</span><span class="p">((</span><span class="n">away_team_elo</span> <span class="o">-</span> <span class="n">home_team_elo</span><span class="p">)</span> <span class="o">/</span> <span class="mi">400</span><span class="p">))</span>
        <span class="n">prob_win_away</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">prob_win_home</span>

        <span class="c1"># Add the elos and probabilities our elos dictionary and elo_probs dictionary based on the Game ID</span>
        <span class="n">elos</span><span class="p">[</span><span class="n">game_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">home_team_elo</span><span class="p">,</span> <span class="n">away_team_elo</span><span class="p">]</span>
        <span class="n">elo_probs</span><span class="p">[</span><span class="n">game_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">prob_win_home</span><span class="p">,</span> <span class="n">prob_win_away</span><span class="p">]</span>

        <span class="c1"># Calculate the new elos of each team</span>
        <span class="k">if</span> <span class="n">margin</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># Home team wins; update both teams&#39; elo</span>
            <span class="n">new_home_team_elo</span> <span class="o">=</span> <span class="n">home_team_elo</span> <span class="o">+</span> <span class="n">k_factor</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">prob_win_home</span><span class="p">)</span>
            <span class="n">new_away_team_elo</span> <span class="o">=</span> <span class="n">away_team_elo</span> <span class="o">+</span> <span class="n">k_factor</span><span class="o">*</span><span class="p">(</span><span class="mi">0</span> <span class="o">-</span> <span class="n">prob_win_away</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">margin</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># Away team wins; update both teams&#39; elo</span>
            <span class="n">new_home_team_elo</span> <span class="o">=</span> <span class="n">home_team_elo</span> <span class="o">+</span> <span class="n">k_factor</span><span class="o">*</span><span class="p">(</span><span class="mi">0</span> <span class="o">-</span> <span class="n">prob_win_home</span><span class="p">)</span>
            <span class="n">new_away_team_elo</span> <span class="o">=</span> <span class="n">away_team_elo</span> <span class="o">+</span> <span class="n">k_factor</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">prob_win_away</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">margin</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># Drawn game&#39; update both teams&#39; elo</span>
            <span class="n">new_home_team_elo</span> <span class="o">=</span> <span class="n">home_team_elo</span> <span class="o">+</span> <span class="n">k_factor</span><span class="o">*</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">-</span> <span class="n">prob_win_home</span><span class="p">)</span>
            <span class="n">new_away_team_elo</span> <span class="o">=</span> <span class="n">away_team_elo</span> <span class="o">+</span> <span class="n">k_factor</span><span class="o">*</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">-</span> <span class="n">prob_win_away</span><span class="p">)</span>

        <span class="c1"># Update elos in elo dictionary</span>
        <span class="n">elo_dict</span><span class="p">[</span><span class="n">home_team</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_home_team_elo</span>
        <span class="n">elo_dict</span><span class="p">[</span><span class="n">away_team</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_away_team_elo</span>

    <span class="k">return</span> <span class="n">elos</span><span class="p">,</span> <span class="n">elo_probs</span><span class="p">,</span> <span class="n">elo_dict</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># Use the elo applier function to get the elos and elo probabilities for each game - we will map these later</span>
<span class="n">elos</span><span class="p">,</span> <span class="n">probs</span><span class="p">,</span> <span class="n">elo_dict</span> <span class="o">=</span> <span class="n">elo_applier</span><span class="p">(</span><span class="n">afl_data</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
</code></pre></div>
<p>Great! now we have both rolling averages for stats as a feature, and the elo of the teams! Let's have a quick look at the current elo standings with a k-factor of 30, out of curiosity.</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span> <span class="n">team</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">elo_dict</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">elo_dict</span><span class="o">.</span><span class="n">get</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">team</span><span class="p">,</span> <span class="n">elo_dict</span><span class="p">[</span><span class="n">team</span><span class="p">])</span>

    <span class="n">Richmond</span> <span class="mf">1695.2241513840117</span>
    <span class="n">Sydney</span> <span class="mf">1645.548990879842</span>
    <span class="n">Hawthorn</span> <span class="mf">1632.5266709780622</span>
    <span class="n">West</span> <span class="n">Coast</span> <span class="mf">1625.871701773721</span>
    <span class="n">Geelong</span> <span class="mf">1625.423154644809</span>
    <span class="n">GWS</span> <span class="mf">1597.4158602131877</span>
    <span class="n">Adelaide</span> <span class="mf">1591.1704934545442</span>
    <span class="n">Collingwood</span> <span class="mf">1560.370309216614</span>
    <span class="n">Melbourne</span> <span class="mf">1558.5666572771509</span>
    <span class="n">Essendon</span> <span class="mf">1529.0198398117086</span>
    <span class="n">Port</span> <span class="n">Adelaide</span> <span class="mf">1524.8882517820093</span>
    <span class="n">North</span> <span class="n">Melbourne</span> <span class="mf">1465.5637511922569</span>
    <span class="n">Western</span> <span class="n">Bulldogs</span> <span class="mf">1452.2110697845148</span>
    <span class="n">Fremantle</span> <span class="mf">1393.142087030804</span>
    <span class="n">St</span> <span class="n">Kilda</span> <span class="mf">1360.9120149937303</span>
    <span class="n">Brisbane</span> <span class="mf">1276.2923772139352</span>
    <span class="n">Gold</span> <span class="n">Coast</span> <span class="mf">1239.174528704772</span>
    <span class="n">Carlton</span> <span class="mf">1226.6780896643265</span>
</code></pre></div>
<p>This looks extremely similar to the currently AFL ladder, so this is a good sign for elo being an effective predictor of winning.</p>
<h3 id="merging-our-features-into-one-features-dataframe">Merging Our Features Into One Features DataFrame<a class="headerlink" href="#merging-our-features-into-one-features-dataframe" title="Permanent link">&para;</a></h3>
<p>Now we need to reshape our features df so that we have all of the statistics for both teams in a game on a single row. We can then merge our elo and efficiency features to this df.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Look at our current features df</span>
<span class="n">features</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</code></pre></div>
<table>
<thead>
<tr>
<th></th>
<th>date</th>
<th>game</th>
<th>team</th>
<th>opponent</th>
<th>venue</th>
<th>home_game</th>
<th>f_odds</th>
<th>f_goals</th>
<th>f_behinds</th>
<th>f_points</th>
<th>f_margin</th>
<th>f_opponent_goals</th>
<th>f_opponent_behinds</th>
<th>f_opponent_points</th>
<th>f_AF</th>
<th>f_B</th>
<th>f_BO</th>
<th>f_CCL</th>
<th>f_CG</th>
<th>f_CL</th>
<th>f_CM</th>
<th>f_CP</th>
<th>f_D</th>
<th>f_ED</th>
<th>f_FA</th>
<th>f_FF</th>
<th>f_G</th>
<th>f_GA</th>
<th>f_HB</th>
<th>f_HO</th>
<th>f_I50</th>
<th>f_ITC</th>
<th>f_K</th>
<th>f_M</th>
<th>f_MG</th>
<th>f_MI5</th>
<th>f_One.Percenters</th>
<th>f_R50</th>
<th>f_SC</th>
<th>f_SCL</th>
<th>f_SI</th>
<th>f_T</th>
<th>f_T5</th>
<th>f_TO</th>
<th>f_UP</th>
<th>f_form_margin_btwn_teams</th>
<th>f_form_past_5_btwn_teams</th>
</tr>
</thead>
<tbody>
<tr>
<td>3156</td>
<td>2018-08-26</td>
<td>15397</td>
<td>Melbourne</td>
<td>GWS</td>
<td>M.C.G.</td>
<td>1</td>
<td>1.706488</td>
<td>15.157271</td>
<td>13.815113</td>
<td>104.758740</td>
<td>25.170429</td>
<td>11.814319</td>
<td>8.702396</td>
<td>79.588311</td>
<td>3312.408470</td>
<td>22.077317</td>
<td>7.724955</td>
<td>28.364418</td>
<td>114.399147</td>
<td>78.406069</td>
<td>26.934677</td>
<td>324.352577</td>
<td>775.176933</td>
<td>547.385948</td>
<td>39.353251</td>
<td>36.025646</td>
<td>30.308918</td>
<td>22.461080</td>
<td>348.613592</td>
<td>99.78780</td>
<td>120.339062</td>
<td>154.417642</td>
<td>426.563341</td>
<td>178.102118</td>
<td>12395.717925</td>
<td>32.168752</td>
<td>96.390688</td>
<td>63.786515</td>
<td>3427.596843</td>
<td>50.041649</td>
<td>232.287556</td>
<td>144.875098</td>
<td>23.789233</td>
<td>149.042149</td>
<td>456.988552</td>
<td>-23.2</td>
<td>2.0</td>
</tr>
<tr>
<td>3157</td>
<td>2018-08-26</td>
<td>15398</td>
<td>North Melbourne</td>
<td>St Kilda</td>
<td>Docklands</td>
<td>0</td>
<td>2.272313</td>
<td>12.721783</td>
<td>10.733785</td>
<td>87.064486</td>
<td>-1.214246</td>
<td>12.915796</td>
<td>10.783958</td>
<td>88.278732</td>
<td>3066.272143</td>
<td>17.322710</td>
<td>9.815243</td>
<td>26.015421</td>
<td>106.465181</td>
<td>67.504286</td>
<td>26.064079</td>
<td>291.259574</td>
<td>736.279779</td>
<td>534.154748</td>
<td>34.301603</td>
<td>40.908551</td>
<td>25.386136</td>
<td>17.816570</td>
<td>341.210547</td>
<td>81.54113</td>
<td>102.589427</td>
<td>145.265493</td>
<td>395.069232</td>
<td>173.089408</td>
<td>10875.002463</td>
<td>21.802751</td>
<td>82.347511</td>
<td>70.416194</td>
<td>3171.120023</td>
<td>41.488865</td>
<td>197.620152</td>
<td>122.547684</td>
<td>22.286256</td>
<td>142.780474</td>
<td>450.374058</td>
<td>3.2</td>
<td>3.0</td>
</tr>
<tr>
<td>3158</td>
<td>2018-08-26</td>
<td>15398</td>
<td>St Kilda</td>
<td>North Melbourne</td>
<td>Docklands</td>
<td>1</td>
<td>5.516150</td>
<td>10.464266</td>
<td>11.957047</td>
<td>74.742643</td>
<td>-21.138101</td>
<td>14.105551</td>
<td>11.247440</td>
<td>95.880745</td>
<td>3094.163405</td>
<td>20.523847</td>
<td>14.569589</td>
<td>24.134276</td>
<td>102.540441</td>
<td>66.976211</td>
<td>18.018350</td>
<td>270.674857</td>
<td>773.086015</td>
<td>573.769838</td>
<td>41.319843</td>
<td>36.198820</td>
<td>20.850476</td>
<td>14.443658</td>
<td>364.405251</td>
<td>63.49876</td>
<td>103.803779</td>
<td>130.494307</td>
<td>408.680763</td>
<td>184.780054</td>
<td>10765.717942</td>
<td>21.572806</td>
<td>94.731555</td>
<td>65.790561</td>
<td>3228.278599</td>
<td>42.841935</td>
<td>196.086493</td>
<td>115.901425</td>
<td>18.796764</td>
<td>127.364334</td>
<td>508.844514</td>
<td>-3.2</td>
<td>2.0</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><span class="n">one_line_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;game&#39;</span><span class="p">,</span> <span class="s1">&#39;team&#39;</span><span class="p">,</span> <span class="s1">&#39;home_game&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">features</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;f_&#39;</span><span class="p">)]</span>

<span class="c1"># Get all features onto individual rows for each match</span>
<span class="n">features_one_line</span> <span class="o">=</span> <span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">features</span><span class="o">.</span><span class="n">home_game</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">one_line_cols</span><span class="p">]</span>
                     <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;team&#39;</span><span class="p">:</span> <span class="s1">&#39;home_team&#39;</span><span class="p">})</span>
                     <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;home_game&#39;</span><span class="p">)</span>
                     <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">,</span> <span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">features</span><span class="o">.</span><span class="n">home_game</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">one_line_cols</span><span class="p">]</span>
                                              <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;home_game&#39;</span><span class="p">)</span>
                                              <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;team&#39;</span><span class="p">:</span> <span class="s1">&#39;away_team&#39;</span><span class="p">})</span>
                                              <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="n">col</span><span class="o">+</span><span class="s1">&#39;_away&#39;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;f_&#39;</span><span class="p">)})),</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;game&#39;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;f_form_margin_btwn_teams_away&#39;</span><span class="p">,</span> <span class="s1">&#39;f_form_past_5_btwn_teams_away&#39;</span><span class="p">]))</span>

<span class="c1"># Add our created features - elo, efficiency etc.</span>
<span class="n">features_one_line</span> <span class="o">=</span> <span class="p">(</span><span class="n">features_one_line</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">f_elo_home</span><span class="o">=</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">elos</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                            <span class="n">f_elo_away</span><span class="o">=</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">elos</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                                      <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">,</span> <span class="n">efficiency_features_single_row</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;game&#39;</span><span class="p">,</span> <span class="s1">&#39;home_team&#39;</span><span class="p">,</span> <span class="s1">&#39;away_team&#39;</span><span class="p">])</span>
                                      <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">,</span> <span class="n">afl_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">afl_data</span><span class="o">.</span><span class="n">home_game</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;game&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;round&#39;</span><span class="p">,</span> <span class="s1">&#39;venue&#39;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;game&#39;</span><span class="p">])</span>
                                      <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
                                      <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                                      <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">season</span><span class="o">=</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">year</span><span class="p">)))</span>

<span class="n">ordered_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">features_one_line</span> <span class="k">if</span> <span class="n">col</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;f_&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">features_one_line</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;f_&#39;</span><span class="p">)]</span>

<span class="n">feature_df</span> <span class="o">=</span> <span class="n">features_one_line</span><span class="p">[</span><span class="n">ordered_cols</span><span class="p">]</span>
</code></pre></div>
<p>Finally, let's reduce the dimensionality of the features df by subtracting the home features from the away features. This will reduce the huge amount of columns we have and make our data more manageable. To do this, we will need a list of columns which we are subtracting from each other. We will then loop over each of these columns to create our new differential columns. </p>
<p>We will then add in the implied probability from the odds of the home and away team, as our current odds feature is simply an exponential moving average over the past n games.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Create differential df - this df is the home features - the away features</span>
<span class="n">diff_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">feature_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span> <span class="o">+</span> <span class="s1">&#39;_away&#39;</span> <span class="ow">in</span> <span class="n">feature_df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="n">col</span> <span class="o">!=</span> <span class="s1">&#39;f_odds&#39;</span> <span class="ow">and</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;f_&#39;</span><span class="p">)]</span>
<span class="n">non_diff_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">feature_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">diff_cols</span> <span class="ow">and</span> <span class="n">col</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">diff_cols</span><span class="p">]</span>

<span class="n">diff_df</span> <span class="o">=</span> <span class="n">feature_df</span><span class="p">[</span><span class="n">non_diff_cols</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">diff_cols</span><span class="p">:</span>
    <span class="n">diff_df</span><span class="p">[</span><span class="n">col</span><span class="o">+</span><span class="s1">&#39;_diff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">-</span> <span class="n">feature_df</span><span class="p">[</span><span class="n">col</span><span class="o">+</span><span class="s1">&#39;_away&#39;</span><span class="p">]</span>

<span class="c1"># Add current odds in to diff_df</span>
<span class="n">odds</span> <span class="o">=</span> <span class="n">get_cleaned_odds</span><span class="p">()</span>
<span class="n">home_odds</span> <span class="o">=</span> <span class="p">(</span><span class="n">odds</span><span class="p">[</span><span class="n">odds</span><span class="o">.</span><span class="n">home_game</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
             <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">f_current_odds_prob</span><span class="o">=</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">df</span><span class="o">.</span><span class="n">odds</span><span class="p">)</span>
             <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;team&#39;</span><span class="p">:</span> <span class="s1">&#39;home_team&#39;</span><span class="p">})</span>
             <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;home_game&#39;</span><span class="p">,</span> <span class="s1">&#39;odds&#39;</span><span class="p">]))</span>

<span class="n">away_odds</span> <span class="o">=</span> <span class="p">(</span><span class="n">odds</span><span class="p">[</span><span class="n">odds</span><span class="o">.</span><span class="n">home_game</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
             <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">f_current_odds_prob_away</span><span class="o">=</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">df</span><span class="o">.</span><span class="n">odds</span><span class="p">)</span>
             <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;team&#39;</span><span class="p">:</span> <span class="s1">&#39;away_team&#39;</span><span class="p">})</span>
             <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;home_game&#39;</span><span class="p">,</span> <span class="s1">&#39;odds&#39;</span><span class="p">]))</span>

<span class="n">diff_df</span> <span class="o">=</span> <span class="p">(</span><span class="n">diff_df</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">,</span> <span class="n">home_odds</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;home_team&#39;</span><span class="p">])</span>
              <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">,</span> <span class="n">away_odds</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;away_team&#39;</span><span class="p">]))</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">diff_df</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</code></pre></div>
<table>
<thead>
<tr>
<th></th>
<th>game</th>
<th>home_team</th>
<th>away_team</th>
<th>date</th>
<th>round</th>
<th>venue</th>
<th>season</th>
<th>f_odds</th>
<th>f_form_margin_btwn_teams</th>
<th>f_form_past_5_btwn_teams</th>
<th>f_odds_away</th>
<th>f_elo_home</th>
<th>f_elo_away</th>
<th>f_I50_efficiency_home</th>
<th>f_R50_efficiency_home</th>
<th>f_I50_efficiency_away</th>
<th>f_R50_efficiency_away</th>
<th>f_goals_diff</th>
<th>f_behinds_diff</th>
<th>f_points_diff</th>
<th>f_margin_diff</th>
<th>f_opponent_goals_diff</th>
<th>f_opponent_behinds_diff</th>
<th>f_opponent_points_diff</th>
<th>f_AF_diff</th>
<th>f_B_diff</th>
<th>f_BO_diff</th>
<th>f_CCL_diff</th>
<th>f_CG_diff</th>
<th>f_CL_diff</th>
<th>f_CM_diff</th>
<th>f_CP_diff</th>
<th>f_D_diff</th>
<th>f_ED_diff</th>
<th>f_FA_diff</th>
<th>f_FF_diff</th>
<th>f_G_diff</th>
<th>f_GA_diff</th>
<th>f_HB_diff</th>
<th>f_HO_diff</th>
<th>f_I50_diff</th>
<th>f_ITC_diff</th>
<th>f_K_diff</th>
<th>f_M_diff</th>
<th>f_MG_diff</th>
<th>f_MI5_diff</th>
<th>f_One.Percenters_diff</th>
<th>f_R50_diff</th>
<th>f_SC_diff</th>
<th>f_SCL_diff</th>
<th>f_SI_diff</th>
<th>f_T_diff</th>
<th>f_T5_diff</th>
<th>f_TO_diff</th>
<th>f_UP_diff</th>
<th>f_current_odds_prob</th>
<th>f_current_odds_prob_away</th>
</tr>
</thead>
<tbody>
<tr>
<td>1626</td>
<td>15394</td>
<td>Carlton</td>
<td>Adelaide</td>
<td>2018-08-25</td>
<td>23</td>
<td>Docklands</td>
<td>2018</td>
<td>6.467328</td>
<td>-26.2</td>
<td>1.0</td>
<td>2.066016</td>
<td>1230.072138</td>
<td>1587.776445</td>
<td>0.730668</td>
<td>0.675002</td>
<td>0.691614</td>
<td>0.677128</td>
<td>-3.498547</td>
<td>-5.527193</td>
<td>-26.518474</td>
<td>-34.473769</td>
<td>1.289715</td>
<td>0.217006</td>
<td>7.955295</td>
<td>-341.342677</td>
<td>-9.317269</td>
<td>3.088569</td>
<td>-2.600593</td>
<td>15.192839</td>
<td>-12.518345</td>
<td>-4.136673</td>
<td>-41.855717</td>
<td>-72.258378</td>
<td>-51.998775</td>
<td>9.499447</td>
<td>8.670917</td>
<td>-6.973088</td>
<td>-4.740623</td>
<td>-26.964945</td>
<td>-13.147675</td>
<td>-23.928700</td>
<td>-28.940883</td>
<td>-45.293433</td>
<td>-15.183406</td>
<td>-1900.784014</td>
<td>-0.362402</td>
<td>-1.314627</td>
<td>4.116133</td>
<td>-294.813511</td>
<td>-9.917793</td>
<td>-34.724925</td>
<td>-5.462844</td>
<td>-9.367141</td>
<td>-19.623785</td>
<td>-38.188082</td>
<td>0.187709</td>
<td>0.816860</td>
</tr>
<tr>
<td>1627</td>
<td>15395</td>
<td>Sydney</td>
<td>Hawthorn</td>
<td>2018-08-25</td>
<td>23</td>
<td>S.C.G.</td>
<td>2018</td>
<td>2.128611</td>
<td>1.0</td>
<td>2.0</td>
<td>1.777290</td>
<td>1662.568452</td>
<td>1615.507209</td>
<td>0.699994</td>
<td>0.778280</td>
<td>0.699158</td>
<td>0.673409</td>
<td>-1.756730</td>
<td>-0.874690</td>
<td>-11.415069</td>
<td>-15.575319</td>
<td>0.014390</td>
<td>4.073909</td>
<td>4.160250</td>
<td>-174.005092</td>
<td>-0.942357</td>
<td>-4.078635</td>
<td>-4.192916</td>
<td>7.814496</td>
<td>-2.225780</td>
<td>6.215760</td>
<td>15.042979</td>
<td>-34.894261</td>
<td>-50.615255</td>
<td>4.214158</td>
<td>0.683548</td>
<td>-3.535594</td>
<td>-3.168608</td>
<td>-12.068691</td>
<td>-30.493980</td>
<td>-9.867332</td>
<td>2.588103</td>
<td>-22.825570</td>
<td>-5.604199</td>
<td>253.086090</td>
<td>-2.697132</td>
<td>-22.612327</td>
<td>25.340623</td>
<td>-90.812188</td>
<td>1.967104</td>
<td>-31.047879</td>
<td>0.007606</td>
<td>-6.880120</td>
<td>11.415593</td>
<td>-49.957313</td>
<td>0.440180</td>
<td>0.561924</td>
</tr>
<tr>
<td>1628</td>
<td>15396</td>
<td>Brisbane</td>
<td>West Coast</td>
<td>2018-08-26</td>
<td>23</td>
<td>Gabba</td>
<td>2018</td>
<td>3.442757</td>
<td>-49.2</td>
<td>0.0</td>
<td>2.094236</td>
<td>1279.963814</td>
<td>1622.200265</td>
<td>0.683604</td>
<td>0.691730</td>
<td>0.696822</td>
<td>0.709605</td>
<td>-0.190413</td>
<td>1.182699</td>
<td>0.040221</td>
<td>-13.621456</td>
<td>1.772577</td>
<td>3.026217</td>
<td>13.661677</td>
<td>-22.709485</td>
<td>2.424261</td>
<td>-4.848054</td>
<td>1.800473</td>
<td>5.051157</td>
<td>6.440524</td>
<td>-5.549630</td>
<td>-17.041838</td>
<td>27.543023</td>
<td>33.983159</td>
<td>4.459181</td>
<td>-3.213885</td>
<td>-0.428455</td>
<td>1.514474</td>
<td>42.646138</td>
<td>-7.141638</td>
<td>1.457375</td>
<td>-17.472537</td>
<td>-15.103115</td>
<td>8.001966</td>
<td>-383.083539</td>
<td>6.458915</td>
<td>7.275716</td>
<td>0.942863</td>
<td>44.461590</td>
<td>4.640136</td>
<td>13.180967</td>
<td>-15.704694</td>
<td>2.366444</td>
<td>-5.985843</td>
<td>38.195255</td>
<td>0.433501</td>
<td>0.569866</td>
</tr>
<tr>
<td>1629</td>
<td>15397</td>
<td>Melbourne</td>
<td>GWS</td>
<td>2018-08-26</td>
<td>23</td>
<td>M.C.G.</td>
<td>2018</td>
<td>1.706488</td>
<td>-23.2</td>
<td>2.0</td>
<td>1.805565</td>
<td>1540.367850</td>
<td>1615.614668</td>
<td>0.667240</td>
<td>0.692632</td>
<td>0.684525</td>
<td>0.753783</td>
<td>2.056899</td>
<td>0.635785</td>
<td>12.977177</td>
<td>6.642811</td>
<td>1.443121</td>
<td>-2.324358</td>
<td>6.334366</td>
<td>147.281112</td>
<td>2.201404</td>
<td>-5.222254</td>
<td>3.250416</td>
<td>8.542475</td>
<td>-2.203571</td>
<td>3.559792</td>
<td>21.192530</td>
<td>33.737734</td>
<td>12.865653</td>
<td>-3.244066</td>
<td>-2.135243</td>
<td>4.100203</td>
<td>3.772200</td>
<td>48.425291</td>
<td>18.247107</td>
<td>13.349992</td>
<td>11.385136</td>
<td>-14.687556</td>
<td>5.052000</td>
<td>304.087088</td>
<td>11.062610</td>
<td>-6.686409</td>
<td>-16.414544</td>
<td>8.350924</td>
<td>-5.453961</td>
<td>12.407662</td>
<td>6.672628</td>
<td>-1.523915</td>
<td>13.075351</td>
<td>18.522113</td>
<td>0.661551</td>
<td>0.340379</td>
</tr>
<tr>
<td>1630</td>
<td>15398</td>
<td>St Kilda</td>
<td>North Melbourne</td>
<td>2018-08-26</td>
<td>23</td>
<td>Docklands</td>
<td>2018</td>
<td>5.516150</td>
<td>-3.2</td>
<td>2.0</td>
<td>2.272313</td>
<td>1372.453734</td>
<td>1454.022032</td>
<td>0.730843</td>
<td>0.635819</td>
<td>0.697018</td>
<td>0.654991</td>
<td>-2.257517</td>
<td>1.223261</td>
<td>-12.321842</td>
<td>-19.923855</td>
<td>1.189755</td>
<td>0.463481</td>
<td>7.602012</td>
<td>27.891262</td>
<td>3.201137</td>
<td>4.754346</td>
<td>-1.881145</td>
<td>-3.924740</td>
<td>-0.528075</td>
<td>-8.045729</td>
<td>-20.584717</td>
<td>36.806235</td>
<td>39.615090</td>
<td>7.018240</td>
<td>-4.709732</td>
<td>-4.535660</td>
<td>-3.372912</td>
<td>23.194704</td>
<td>-18.042370</td>
<td>1.214353</td>
<td>-14.771187</td>
<td>13.611531</td>
<td>11.690647</td>
<td>-109.284521</td>
<td>-0.229945</td>
<td>12.384044</td>
<td>-4.625633</td>
<td>57.158576</td>
<td>1.353070</td>
<td>-1.533659</td>
<td>-6.646259</td>
<td>-3.489492</td>
<td>-15.416140</td>
<td>58.470456</td>
<td>0.284269</td>
<td>0.717566</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="wrapping-it-up">Wrapping it Up<a class="headerlink" href="#wrapping-it-up" title="Permanent link">&para;</a></h2>
<p>We now have a fairly decent amount of features. Some other features which could be added include whether the game is in a major Capital city outisde of Mebourne (i.e. Sydney, Adelaide or Peth), how many 'Elite' players are playing (which could be judged by average SuperCoach scores over 110, for example), as well as your own metrics for attacking and defending.</p>
<p>Note that all of our features have columns starting with 'f_' so in the <a href="/modelling/AFLmodelPart3">next tutorial</a>, we will grab this feature dataframe and use these features to sport predicting the matches.</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../AFLmodelPart1/" title="AFL 01. Data cleaning" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                AFL 01. Data cleaning
              </span>
            </div>
          </a>
        
        
          <a href="../AFLmodelPart3/" title="AFL 03. Modelling" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                AFL 03. Modelling
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
      </div>
      
        
  <div class="md-footer-social">
    <link rel="stylesheet" href="../../assets/fonts/font-awesome.css">
    
      <a href="https://twitter.com/Betfair_Aus" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://linkedin.com/company/betfair-australia" class="md-footer-social__link fa fa-linkedin"></a>
    
      <a href="https://facebook.com/betfairaustralia" class="md-footer-social__link fa fa-facebook"></a>
    
      <a href="https://youtube.com/user/betfairaus" class="md-footer-social__link fa fa-youtube"></a>
    
      <a href="https://github.com/betfair-datascientists" class="md-footer-social__link fa fa-github"></a>
    
  </div>

      
    </div>
    <div class="bf-footer">
      <p class="bf-light">Betfair Pty Limited is licensed and regulated by the Northern Territory Government of Australia.</p>
      <p class="bf-dark">Betfair Pty Limited's gambling operations are governed by its Responsible Gambling Code of Conduct and for South
      Australian residents by the South Australian Responsible Gambling Code of Practice.<br> Think! About your choices. Think of the people who need your support. Gamble responsibly. Call Gambling Help 1800 858 858 <a href="https://gamblinghelponline.org.au">www.gamblinghelponline.org.au</a></p>
      <ul class="bf-links">
        <li><a href="https://www.betfair.com.au/hub/help/account-help/responsible-gambling/">Responsible Gambling</a><span>|</span></li>
        <li><a href="http://www.betfair.com/AUS_NZL/aboutUs/Terms.and.Conditions/">Terms & Conditions</a><span>|</span></li>
        <li><a href="https://www.betfair.com.au/info/privacy-policy/">Privacy Policy</a><span>|</span></li>
        <li><a href="http://www.betfair.com/en/aboutUs/Rules.and.Regulations/">Rules & Regulations</a><span>|</span></li>
        <li><a href="https://www.betfair.com/AUS_NZL/aboutUs/Dispute.Resolution">Dispute Resolution</a></li>
      </ul>
    </div>
  </div>
  <script src="https://js.adsrvr.org/up_loader.1.1.0.js"></script>
  <script>ttd_dom_ready(function(){"function"==typeof TTDUniversalPixelApi&&(new TTDUniversalPixelApi).init("y12d1ir",["8ml4f17"],"https://insight.adsrvr.org/track/up")})</script>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.72d6715c.js"></script>
      
      <script>app.initialize({version:"1.1.2",url:{base:"../.."}})</script>
      
        <script src="../../search/main.js"></script>
      
    
    
      
        <script>!function(e,a,t,n,o,c,i){e.GoogleAnalyticsObject=o,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),i=a.getElementsByTagName(t)[0],c.async=1,c.src="https://www.google-analytics.com/analytics.js",i.parentNode.insertBefore(c,i)}(window,document,"script",0,"ga"),ga("create","UA-125973915-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview");var links=document.getElementsByTagName("a");if(Array.prototype.map.call(links,function(e){e.host!=document.location.host&&e.addEventListener("click",function(){var a=e.getAttribute("data-md-action")||"follow";ga("send","event","outbound",a,e.href)})}),document.forms.search){var query=document.forms.search.query;query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})}</script>
      
    
  </body>
</html>